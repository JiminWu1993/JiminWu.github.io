<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>英语时态之旅</title>
    <link rel="stylesheet" href="style.css">
    <!-- Firebase App (核心SDK) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <!-- Firebase Database -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <link rel="icon" href="data:image/x-icon;base64,AAABAAEAEBAQAAEABAAoAQAAFgAAACgAAAAQAAAAIAAAAAEABAAAAAAAgAAAAAAAAAAAAAAAEAAAABAAAAAAAAAA////AAAAAAD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wAiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIiIi极简版favicon，避免404错误">
</head>
<body>
    <!-- 初始界面 -->
    <div id="page-2001" class="page active">
        <img src="images/开始画面.jpg" alt="开始画面" class="background-image">
        <div class="text-container">
            <p>Welcome to the journey of English tenses</p>
        </div>
        <div class="button-container">
            <button id="join-room-btn" class="game-btn">Join a Room</button>
            <button id="create-room-btn" class="game-btn">Create a Room</button>
        </div>
    </div>

    <script>
        // Firebase配置
        const firebaseConfig = {
            apiKey: "AIzaSyDHRYTBU74r31MPYVAAnRMwKM76c_-BduQ",
            authDomain: "tetrisonline-ca400.firebaseapp.com",
            projectId: "tetrisonline-ca400",
            storageBucket: "tetrisonline-ca400.firebasestorage.app",
            messagingSenderId: "58207939196",
            appId: "1:58207939196:web:b34f403204096084ee37f9",
            measurementId: "G-GG7GNEQ718"
        };

        // 初始化Firebase
        let firebaseInitialized = false;
        try {
            firebase.initializeApp(firebaseConfig);
            firebaseInitialized = true;
            console.log("Firebase initialized successfully");
        } catch (error) {
            console.error("Firebase initialization error:", error);
            alert("Failed to initialize Firebase. Please check your connection and refresh the page.");
        }

        // 全局变量
        let roomNumber = '';
        let playerId = '';
        let playerName = '';
        let isTeacher = false;

        // DOM元素
        const joinRoomBtn = document.getElementById('join-room-btn');
        const createRoomBtn = document.getElementById('create-room-btn');

        // 加入房间按钮点击事件
        joinRoomBtn.addEventListener('click', function() {
            if (!firebaseInitialized) {
                alert("Firebase not initialized. Please refresh the page.");
                return;
            }
            
            const roomInput = prompt('Please enter a 6-digit room number');
            if (roomInput && roomInput.length === 6 && /^\d+$/.test(roomInput)) {
                checkRoomExists(roomInput);
            } else if (roomInput) {
                alert('Please enter a valid 6-digit number');
            }
        });

        // 创建房间按钮点击事件
        createRoomBtn.addEventListener('click', function() {
            if (!firebaseInitialized) {
                alert("Firebase not initialized. Please refresh the page.");
                return;
            }
            
            createNewRoom();
        });

        // 检查房间是否存在
        function checkRoomExists(roomId) {
            const db = firebase.database();
            const roomRef = db.ref('rooms/' + roomId);
            
            roomRef.once('value')
                .then((snapshot) => {
                    if (snapshot.exists()) {
                        roomNumber = roomId;
                        // 请求玩家输入昵称
                        const nickname = prompt('Please enter your English nickname');
                        if (nickname && nickname.length <= 12) {
                            playerName = nickname;
                            joinRoom(roomId);
                        } else if (nickname) {
                            alert('Nickname must be 12 characters or less');
                        }
                    } else {
                        // 房间不存在，显示提示
                        showTemporaryAlert('Room number does not exist');
                    }
                })
                .catch((error) => {
                    console.error('Error checking room:', error);
                    alert('Error checking room. Please try again.');
                });
        }

        // 显示临时提示
        function showTemporaryAlert(message) {
            const alertDiv = document.createElement('div');
            alertDiv.className = 'temp-alert';
            alertDiv.textContent = message;
            document.body.appendChild(alertDiv);
            
            // 3秒后移除提示
            setTimeout(() => {
                document.body.removeChild(alertDiv);
            }, 3000);
        }

        // 加入房间
        function joinRoom(roomId) {
            const db = firebase.database();
            const roomRef = db.ref('rooms/' + roomId);
            
            // 生成玩家ID
            playerId = generatePlayerId();
            
            // 获取当前时间作为加入时间
            const joinTime = Date.now();
            
            // 创建玩家数据
            const playerData = {
                name: playerName,
                joinTime: joinTime,
                status: 'playing',
                progress: 0,
                score: 0,
                correctAnswers: 0,
                finished: false
            };
            
            // 将玩家添加到房间
            roomRef.child('players').child(playerId).set(playerData)
                .then(() => {
                    // 跳转到章节页面
                    window.location.href = `chapter.html?room=${roomId}&player=${playerId}`;
                })
                .catch((error) => {
                    console.error('Error joining room:', error);
                    alert('Error joining room. Please try again.');
                });
        }

        // 创建新房间
        function createNewRoom() {
            const db = firebase.database();
            
            // 生成6位随机房间号
            roomNumber = generateRoomNumber();
            isTeacher = true;
            
            // 创建房间数据
            const roomData = {
                createdAt: Date.now(),
                teacher: true,
                players: {}
            };
            
            // 将房间添加到数据库
            const roomRef = db.ref('rooms/' + roomNumber);
            roomRef.set(roomData)
                .then(() => {
                    // 直接跳转到排名页面
                    window.location.href = `chapter.html?room=${roomNumber}&teacher=true`;
                })
                .catch((error) => {
                    console.error('Error creating room:', error);
                    alert('Error creating room. Please try again.');
                });
        }

        // 生成6位随机房间号
        function generateRoomNumber() {
            return Math.floor(100000 + Math.random() * 900000).toString();
        }

        // 生成玩家ID
        function generatePlayerId() {
            return 'player_' + Date.now() + '_' + Math.floor(Math.random() * 1000);
        }

        // 预加载下一张图片
        function preloadImage(src) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.onload = () => resolve(img);
                img.onerror = reject;
                img.src = src;
            });
        }

        // 预加载第一张章节图片
        preloadImage('images/画面01.jpg').catch(() => {
            console.log('Preloading image failed');
        });
    </script>
</body>
</html>
