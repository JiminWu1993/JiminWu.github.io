<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>英语时态之旅</title>
    <link rel="stylesheet" href="style.css">
    <!-- Firebase App (核心SDK) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <!-- Firebase Database -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
</head>
<body>
    <!-- 开始画面 (页面ID:2001) -->
    <div id="page-2001" class="page active">
        <img src="images/开始画面.jpg" alt="开始画面" class="full-width-img">
        <div class="text-container">
            <h1>Welcome to the journey of English tenses</h1>
        </div>
        <div class="button-container horizontal-buttons">
            <button id="join-room-btn" class="blue-btn">Join a Room</button>
            <button id="create-room-btn" class="blue-btn">Create a Room</button>
        </div>
    </div>

    <!-- 房间号输入模态框 -->
    <div id="room-input-modal" class="modal">
        <div class="modal-content">
            <p>Please enter a 6-digit room number</p>
            <input type="text" id="room-number-input" maxlength="6" pattern="[0-9]{6}">
            <div class="modal-buttons">
                <button id="confirm-room-btn" class="blue-btn">Confirm</button>
                <button id="cancel-room-btn" class="blue-btn">Cancel</button>
            </div>
        </div>
    </div>

    <!-- 昵称输入模态框 -->
    <div id="nickname-modal" class="modal">
        <div class="modal-content">
            <p>Please enter your English nickname</p>
            <input type="text" id="nickname-input" maxlength="12">
            <div class="modal-buttons">
                <button id="confirm-nickname-btn" class="blue-btn">Confirm</button>
                <button id="cancel-nickname-btn" class="blue-btn">Cancel</button>
            </div>
        </div>
    </div>

    <!-- 提示信息模态框 -->
    <div id="message-modal" class="modal">
        <div class="modal-content">
            <p id="message-text"></p>
        </div>
    </div>

    <script>
        // Firebase配置
        const firebaseConfig = {
            apiKey: "AIzaSyDHRYTBU74r31MPYVAAnRMwKM76c_-BduQ",
            authDomain: "tetrisonline-ca400.firebaseapp.com",
            projectId: "tetrisonline-ca400",
            storageBucket: "tetrisonline-ca400.firebasestorage.app",
            messagingSenderId: "58207939196",
            appId: "1:58207939196:web:b34f403204096084ee37f9",
            measurementId: "G-GG7GNEQ718"
        };

        // 初始化Firebase
        let firebaseApp;
        let database;
        
        try {
            firebaseApp = firebase.initializeApp(firebaseConfig);
            database = firebase.database();
            console.log("Firebase initialized successfully");
        } catch (error) {
            console.error("Firebase initialization error:", error);
            showMessage("Database connection failed. Please refresh and try again.");
        }

        // DOM元素
        const joinRoomBtn = document.getElementById('join-room-btn');
        const createRoomBtn = document.getElementById('create-room-btn');
        const roomInputModal = document.getElementById('room-input-modal');
        const roomNumberInput = document.getElementById('room-number-input');
        const confirmRoomBtn = document.getElementById('confirm-room-btn');
        const cancelRoomBtn = document.getElementById('cancel-room-btn');
        const nicknameModal = document.getElementById('nickname-modal');
        const nicknameInput = document.getElementById('nickname-input');
        const confirmNicknameBtn = document.getElementById('confirm-nickname-btn');
        const cancelNicknameBtn = document.getElementById('cancel-nickname-btn');
        const messageModal = document.getElementById('message-modal');
        const messageText = document.getElementById('message-text');

        // 显示消息函数
        function showMessage(message, duration = 0) {
            messageText.textContent = message;
            messageModal.style.display = 'flex';
            
            if (duration > 0) {
                setTimeout(() => {
                    messageModal.style.display = 'none';
                }, duration);
            }
        }

        // 隐藏消息函数
        function hideMessage() {
            messageModal.style.display = 'none';
        }

        // 加入房间按钮点击事件
        joinRoomBtn.addEventListener('click', () => {
            roomInputModal.style.display = 'flex';
            roomNumberInput.focus();
        });

        // 取消房间输入
        cancelRoomBtn.addEventListener('click', () => {
            roomInputModal.style.display = 'none';
            roomNumberInput.value = '';
        });

        // 确认房间号
        confirmRoomBtn.addEventListener('click', () => {
            const roomNumber = roomNumberInput.value.trim();
            
            if (roomNumber.length !== 6 || !/^\d{6}$/.test(roomNumber)) {
                showMessage("Please enter a valid 6-digit room number", 3000);
                return;
            }
            
            roomInputModal.style.display = 'none';
            
            // 检查房间是否存在
            if (!database) {
                showMessage("Database not available. Please refresh and try again.");
                return;
            }
            
            const roomRef = database.ref('rooms/' + roomNumber);
            roomRef.once('value')
                .then(snapshot => {
                    if (snapshot.exists()) {
                        // 房间存在，请求昵称
                        sessionStorage.setItem('roomNumber', roomNumber);
                        sessionStorage.setItem('isTeacher', 'false');
                        nicknameModal.style.display = 'flex';
                        nicknameInput.focus();
                    } else {
                        // 房间不存在
                        showMessage("Room number does not exist", 3000);
                    }
                })
                .catch(error => {
                    console.error("Error checking room:", error);
                    showMessage("Error checking room. Please try again.");
                });
        });

        // 取消昵称输入
        cancelNicknameBtn.addEventListener('click', () => {
            nicknameModal.style.display = 'none';
            nicknameInput.value = '';
        });

        // 确认昵称
        confirmNicknameBtn.addEventListener('click', () => {
            const nickname = nicknameInput.value.trim();
            
            if (nickname.length === 0) {
                showMessage("Please enter your nickname", 3000);
                return;
            }
            
            if (nickname.length > 12) {
                showMessage("Nickname must be 12 characters or less", 3000);
                return;
            }
            
            nicknameModal.style.display = 'none';
            sessionStorage.setItem('playerName', nickname);
            
            // 跳转到游戏章节页面
            window.location.href = 'chapter.html';
        });

        // 创建房间按钮点击事件
        createRoomBtn.addEventListener('click', () => {
            if (!database) {
                showMessage("Database not available. Please refresh and try again.");
                return;
            }
            
            // 生成6位随机房间号
            const roomNumber = Math.floor(100000 + Math.random() * 900000).toString();
            sessionStorage.setItem('roomNumber', roomNumber);
            sessionStorage.setItem('isTeacher', 'true');
            
            // 在Firebase中创建房间
            const roomRef = database.ref('rooms/' + roomNumber);
            roomRef.set({
                createdAt: firebase.database.ServerValue.TIMESTAMP,
                teacher: true,
                players: 0
            })
            .then(() => {
                // 直接跳转到排名画面
                window.location.href = 'chapter.html#2113';
            })
            .catch(error => {
                console.error("Error creating room:", error);
                showMessage("Failed to create room. Please try again.");
            });
        });

        // 输入框回车键支持
        roomNumberInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                confirmRoomBtn.click();
            }
        });
        
        nicknameInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                confirmNicknameBtn.click();
            }
        });
    </script>
</body>
</html>
