<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è‹±è¯­æ—¶æ€ä¹‹æ—…</title>
    <link rel="stylesheet" href="style.css">
    <!-- Firebase App (the core Firebase SDK) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <!-- Firebase Database -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ“š</text></svg>">
</head>
<body>
    <!-- å¼€å§‹ç”»é¢ (é¡µé¢ID:2001) -->
    <div id="page-2001" class="page active">
        <img src="images/å¼€å§‹ç”»é¢.jpg" alt="å¼€å§‹ç”»é¢" class="background-image">
        <div class="content">
            <h1 class="welcome-text">Welcome to the journey of English tenses</h1>
            <div class="button-container">
                <button id="join-room-btn" class="action-btn">Join a Room</button>
                <button id="create-room-btn" class="action-btn">Create a Room</button>
            </div>
        </div>
    </div>

    <script>
        // Firebaseé…ç½®
        const firebaseConfig = {
            apiKey: "AIzaSyDHRYTBU74r31MPYVAAnRMwKM76c_-BduQ",
            authDomain: "tetrisonline-ca400.firebaseapp.com",
            projectId: "tetrisonline-ca400",
            storageBucket: "tetrisonline-ca400.firebasestorage.app",
            messagingSenderId: "58207939196",
            appId: "1:58207939196:web:b34f403204096084ee37f9",
            measurementId: "G-GG7GNEQ718"
        };

        // åˆå§‹åŒ–Firebase
        let firebaseInitialized = false;
        try {
            firebase.initializeApp(firebaseConfig);
            firebaseInitialized = true;
            console.log("Firebase initialized successfully");
        } catch (error) {
            console.error("Firebase initialization error:", error);
            alert("Failed to initialize the game. Please refresh the page and try again.");
        }

        // å…¨å±€å˜é‡0
        let currentRoom = null;
        let playerId = null;
        let playerName = null;

        // DOMå…ƒç´ 
        const joinRoomBtn = document.getElementById('join-room-btn');
        const createRoomBtn = document.getElementById('create-room-btn');

        // åŠ å…¥æˆ¿é—´æŒ‰é’®äº‹ä»¶
        joinRoomBtn.addEventListener('click', function() {
            if (!firebaseInitialized) {
                alert("Game initialization failed. Please refresh and try again.");
                return;
            }
            
            const roomNumber = prompt("Please enter a 6-digit room number");
            if (!roomNumber) return;
            
            if (!/^\d{6}$/.test(roomNumber)) {
                alert("Please enter a valid 6-digit room number");
                return;
            }
            
            checkRoomExists(roomNumber);
        });

        // åˆ›å»ºæˆ¿é—´æŒ‰é’®äº‹ä»¶
        createRoomBtn.addEventListener('click', function() {
            if (!firebaseInitialized) {
                alert("Game initialization failed. Please refresh and try again.");
                return;
            }
            
            createNewRoom();
        });

        // æ£€æŸ¥æˆ¿é—´æ˜¯å¦å­˜åœ¨
        function checkRoomExists(roomNumber) {
            const db = firebase.database();
            const roomRef = db.ref('rooms/' + roomNumber);
            
            roomRef.once('value')
                .then((snapshot) => {
                    if (snapshot.exists()) {
                        const roomData = snapshot.val();
                        // æ£€æŸ¥æˆ¿é—´æ˜¯å¦å·²æ»¡
                        if (roomData.players && Object.keys(roomData.players).length >= 20) {
                            alert("This room is full. Please join another room.");
                            return;
                        }
                        
                        currentRoom = roomNumber;
                        promptForNickname();
                    } else {
                        showTemporaryAlert("Room number does not exist");
                    }
                })
                .catch((error) => {
                    console.error("Error checking room:", error);
                    alert("Error checking room. Please try again.");
                });
        }

        // æ˜¾ç¤ºä¸´æ—¶æç¤º
        function showTemporaryAlert(message) {
            const alertDiv = document.createElement('div');
            alertDiv.className = 'temporary-alert';
            alertDiv.textContent = message;
            document.body.appendChild(alertDiv);
            
            setTimeout(() => {
                document.body.removeChild(alertDiv);
            }, 3000);
        }

        // æç¤ºè¾“å…¥æ˜µç§°
        function promptForNickname() {
            const nickname = prompt("Please enter your English nickname");
            if (!nickname) return;
            
            if (nickname.length > 12) {
                alert("Nickname must be 12 characters or less");
                promptForNickname();
                return;
            }
            
            playerName = nickname;
            joinRoom();
        }

        // åŠ å…¥æˆ¿é—´
        function joinRoom() {
            const db = firebase.database();
            const playerRef = db.ref('rooms/' + currentRoom + '/players');
            
            // ç”Ÿæˆç©å®¶ID
            playerId = generateId();
            
            // ç©å®¶æ•°æ®
            const playerData = {
                name: playerName,
                status: "playing",
                progress: 0,
                correctAnswers: 0,
                startTime: Date.now(),
                finished: false
            };
            
            // å†™å…¥æ•°æ®åº“
            playerRef.child(playerId).set(playerData)
                .then(() => {
                    // è·³è½¬åˆ°æ¸¸æˆé¡µé¢
                    window.location.href = `chapter.html?room=${currentRoom}&player=${playerId}`;
                })
                .catch((error) => {
                    console.error("Error joining room:", error);
                    alert("Failed to join room. Please try again.");
                });
        }

        // åˆ›å»ºæ–°æˆ¿é—´
        function createNewRoom() {
            const db = firebase.database();
            const roomsRef = db.ref('rooms');
            
            // ç”Ÿæˆ6ä½éšæœºæˆ¿é—´å·
            const roomNumber = generateRoomNumber();
            
            // æˆ¿é—´æ•°æ®
            const roomData = {
                createdAt: Date.now(),
                createdBy: "teacher",
                players: {}
            };
            
            // å†™å…¥æ•°æ®åº“
            roomsRef.child(roomNumber).set(roomData)
                .then(() => {
                    currentRoom = roomNumber;
                    // ä½œä¸ºè€å¸ˆç›´æ¥è·³è½¬åˆ°æ’è¡Œæ¦œ
                    window.location.href = `chapter.html?room=${currentRoom}&teacher=true`;
                })
                .catch((error) => {
                    console.error("Error creating room:", error);
                    alert("Failed to create room. Please try again.");
                });
        }

        // ç”Ÿæˆéšæœºæˆ¿é—´å·
        function generateRoomNumber() {
            return Math.floor(100000 + Math.random() * 900000).toString();
        }

        // ç”ŸæˆID
        function generateId() {
            return Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);
        }
    </script>
</body>
</html>
