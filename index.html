<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>英语时态之旅</title>
    <link rel="stylesheet" href="style.css">
    <!-- Firebase App (the core Firebase SDK) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <!-- Firebase Database -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>📚</text></svg>">
</head>
<body>
    <!-- 开始画面 (页面ID:2001) -->
    <div id="page-2001" class="page active">
        <img src="images/开始画面.jpg" alt="开始画面" class="background-image">
        <div class="content">
            <h1 class="welcome-text">Welcome to the journey of English tenses</h1>
            <div class="button-container">
                <button id="join-room-btn" class="action-btn">Join a Room</button>
                <button id="create-room-btn" class="action-btn">Create a Room</button>
            </div>
        </div>
    </div>

    <script>
        // Firebase配置
        const firebaseConfig = {
            apiKey: "AIzaSyDHRYTBU74r31MPYVAAnRMwKM76c_-BduQ",
            authDomain: "tetrisonline-ca400.firebaseapp.com",
            projectId: "tetrisonline-ca400",
            storageBucket: "tetrisonline-ca400.firebasestorage.app",
            messagingSenderId: "58207939196",
            appId: "1:58207939196:web:b34f403204096084ee37f9",
            measurementId: "G-GG7GNEQ718"
        };

        // 初始化Firebase
        let firebaseInitialized = false;
        try {
            firebase.initializeApp(firebaseConfig);
            firebaseInitialized = true;
            console.log("Firebase initialized successfully");
        } catch (error) {
            console.error("Firebase initialization error:", error);
            alert("Failed to initialize the game. Please refresh the page and try again.");
        }

        // 全局变量0
        let currentRoom = null;
        let playerId = null;
        let playerName = null;

        // DOM元素
        const joinRoomBtn = document.getElementById('join-room-btn');
        const createRoomBtn = document.getElementById('create-room-btn');

        // 加入房间按钮事件
        joinRoomBtn.addEventListener('click', function() {
            if (!firebaseInitialized) {
                alert("Game initialization failed. Please refresh and try again.");
                return;
            }
            
            const roomNumber = prompt("Please enter a 6-digit room number");
            if (!roomNumber) return;
            
            if (!/^\d{6}$/.test(roomNumber)) {
                alert("Please enter a valid 6-digit room number");
                return;
            }
            
            checkRoomExists(roomNumber);
        });

        // 创建房间按钮事件
        createRoomBtn.addEventListener('click', function() {
            if (!firebaseInitialized) {
                alert("Game initialization failed. Please refresh and try again.");
                return;
            }
            
            createNewRoom();
        });

        // 检查房间是否存在
        function checkRoomExists(roomNumber) {
            const db = firebase.database();
            const roomRef = db.ref('rooms/' + roomNumber);
            
            roomRef.once('value')
                .then((snapshot) => {
                    if (snapshot.exists()) {
                        const roomData = snapshot.val();
                        // 检查房间是否已满
                        if (roomData.players && Object.keys(roomData.players).length >= 20) {
                            alert("This room is full. Please join another room.");
                            return;
                        }
                        
                        currentRoom = roomNumber;
                        promptForNickname();
                    } else {
                        showTemporaryAlert("Room number does not exist");
                    }
                })
                .catch((error) => {
                    console.error("Error checking room:", error);
                    alert("Error checking room. Please try again.");
                });
        }

        // 显示临时提示
        function showTemporaryAlert(message) {
            const alertDiv = document.createElement('div');
            alertDiv.className = 'temporary-alert';
            alertDiv.textContent = message;
            document.body.appendChild(alertDiv);
            
            setTimeout(() => {
                document.body.removeChild(alertDiv);
            }, 3000);
        }

        // 提示输入昵称
        function promptForNickname() {
            const nickname = prompt("Please enter your English nickname");
            if (!nickname) return;
            
            if (nickname.length > 12) {
                alert("Nickname must be 12 characters or less");
                promptForNickname();
                return;
            }
            
            playerName = nickname;
            joinRoom();
        }

        // 加入房间
        function joinRoom() {
            const db = firebase.database();
            const playerRef = db.ref('rooms/' + currentRoom + '/players');
            
            // 生成玩家ID
            playerId = generateId();
            
            // 玩家数据
            const playerData = {
                name: playerName,
                status: "playing",
                progress: 0,
                correctAnswers: 0,
                startTime: Date.now(),
                finished: false
            };
            
            // 写入数据库
            playerRef.child(playerId).set(playerData)
                .then(() => {
                    // 跳转到游戏页面
                    window.location.href = `chapter.html?room=${currentRoom}&player=${playerId}`;
                })
                .catch((error) => {
                    console.error("Error joining room:", error);
                    alert("Failed to join room. Please try again.");
                });
        }

        // 创建新房间
        function createNewRoom() {
            const db = firebase.database();
            const roomsRef = db.ref('rooms');
            
            // 生成6位随机房间号
            const roomNumber = generateRoomNumber();
            
            // 房间数据
            const roomData = {
                createdAt: Date.now(),
                createdBy: "teacher",
                players: {}
            };
            
            // 写入数据库
            roomsRef.child(roomNumber).set(roomData)
                .then(() => {
                    currentRoom = roomNumber;
                    // 作为老师直接跳转到排行榜
                    window.location.href = `chapter.html?room=${currentRoom}&teacher=true`;
                })
                .catch((error) => {
                    console.error("Error creating room:", error);
                    alert("Failed to create room. Please try again.");
                });
        }

        // 生成随机房间号
        function generateRoomNumber() {
            return Math.floor(100000 + Math.random() * 900000).toString();
        }

        // 生成ID
        function generateId() {
            return Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);
        }
    </script>
</body>
</html>
