<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>英语时态之旅 - 游戏</title>
    <link rel="stylesheet" href="style.css">
    <!-- Firebase App (core Firebase SDK) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <!-- Firebase Firestore -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
</head>
<body>
    <div id="game-container" class="screen">
        <!-- 图片区域 -->
        <img id="scene-image" class="background-image" alt="Scene">
        
        <!-- 文本区域 -->
        <div id="text-container" class="text-container">
            <p id="dialogue-text"></p>
        </div>
        
        <!-- 选项按钮区域 -->
        <div id="options-container" class="options-container"></div>
        
        <!-- Continue按钮 -->
        <button id="continue-btn" class="continue-btn">Continue</button>
    </div>

    <script>
        // Firebase配置
        const firebaseConfig = {
            apiKey: "AIzaSyDHRYTBU74r31MPYVAAnRMwKM76c_-BduQ",
            authDomain: "tetrisonline-ca400.firebaseapp.com",
            projectId: "tetrisonline-ca400",
            storageBucket: "tetrisonline-ca400.firebasestorage.app",
            messagingSenderId: "58207939196",
            appId: "1:58207939196:web:b34f403204096084ee37f9",
            measurementId: "G-GG7GNEQ718"
        };
        
        // 初始化Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        
        // 游戏数据
        const gameData = {
            // 开始画面 (页面ID:2100)
            2100: {
                image: "开始画面.jpg",
                text: "Welcome to the journey of English tenses",
                options: [],
                nextPage: 2101
            },
            // 画面01 (页面ID:2101)
            2101: {
                image: "画面01.jpg",
                text: "Arturo: Hello, I'm Arturo Valdez.",
                options: [],
                nextPage: 2102
            },
            // 画面02 (页面ID:2102)
            2102: {
                image: "画面02.jpg",
                text: "Alexa: Hi. My name (1) Alexandra Costa, but please (2) me Alexa.",
                options: [
                    [
                        { id: "1-1", text: "is", correct: true },
                        { id: "1-2", text: "am", correct: false },
                        { id: "1-3", text: "are", correct: false }
                    ],
                    [
                        { id: "2-1", text: "calls", correct: false },
                        { id: "2-2", text: "call", correct: true },
                        { id: "2-3", text: "calling", correct: false }
                    ]
                ],
                nextPage: 2103
            },
            // 画面03 (页面ID:2103)
            2103: {
                image: "画面03.jpg",
                text: "Arturo: OK. Where (3) you from, Alexa?",
                options: [
                    [
                        { id: "1-1", text: "is", correct: false },
                        { id: "1-2", text: "are", correct: true },
                        { id: "1-3", text: "am", correct: false }
                    ]
                ],
                nextPage: 2104
            },
            // 画面04 (页面ID:2104)
            2104: {
                image: "画面04.jpg",
                text: "Alexa: Brazil. How about you?",
                options: [],
                nextPage: 2105
            },
            // 画面05 (页面ID:2105)
            2105: {
                image: "画面05.jpg",
                text: "Arturo: I'm from Mexico. I (4) here in the city now, but my family (5) in a small town near Guadalajara.",
                options: [
                    [
                        { id: "1-1", text: "lives", correct: true },
                        { id: "1-2", text: "live", correct: false },
                        { id: "1-3", text: "living", correct: false }
                    ],
                    [
                        { id: "2-1", text: "lives", correct: true },
                        { id: "2-2", text: "live", correct: false },
                        { id: "2-3", text: "are living", correct: false }
                    ]
                ],
                nextPage: 2106
            },
            // 画面06 (页面ID:2106)
            2106: {
                image: "画面06.jpg",
                text: "Alexa: Oh, I (6) Mexico! It (7) really beautiful. My brother (8) Mexico, too. Oh, good. Soo-jin (9) here.",
                options: [
                    [
                        { id: "1-1", text: "loves", correct: false },
                        { id: "1-2", text: "love", correct: true },
                        { id: "1-3", text: "loving", correct: false }
                    ],
                    [
                        { id: "2-1", text: "is", correct: true },
                        { id: "2-2", text: "am", correct: false },
                        { id: "2-3", text: "are", correct: false }
                    ],
                    [
                        { id: "3-1", text: "loves", correct: true },
                        { id: "3-2", text: "love", correct: false },
                        { id: "3-3", text: "loving", correct: false }
                    ],
                    [
                        { id: "4-1", text: "is", correct: true },
                        { id: "4-2", text: "are", correct: false },
                        { id: "4-3", text: "am", correct: false }
                    ]
                ],
                nextPage: 2107
            },
            // 画面07 (页面ID:2107)
            2107: {
                image: "画面07.jpg",
                text: "Arturo: Who (10) Soo-jin? She (11) familiar.",
                options: [
                    [
                        { id: "1-1", text: "is", correct: true },
                        { id: "1-2", text: "are", correct: false },
                        { id: "1-3", text: "am", correct: false }
                    ],
                    [
                        { id: "2-1", text: "looks", correct: true },
                        { id: "2-2", text: "look", correct: false },
                        { id: "2-3", text: "looking", correct: false }
                    ]
                ],
                nextPage: 2108
            },
            // 画面08 (页面ID:2108)
            2108: {
                image: "画面08.jpg",
                text: "Alexa: She (12) my classmate. We (13) in the same business class. We (14) our class every Monday and Wednesday.",
                options: [
                    [
                        { id: "1-1", text: "is", correct: false },
                        { id: "1-2", text: "are", correct: true },
                        { id: "1-3", text: "am", correct: false }
                    ],
                    [
                        { id: "2-1", text: "is", correct: false },
                        { id: "2-2", text: "are", correct: true },
                        { id: "2-3", text: "am", correct: false }
                    ],
                    [
                        { id: "3-1", text: "has", correct: false },
                        { id: "3-2", text: "have", correct: true },
                        { id: "3-3", text: "having", correct: false }
                    ]
                ],
                nextPage: 2109
            },
            // 画面09 (页面ID:2109)
            2109: {
                image: "画面09.jpg",
                text: "Arturo: Where (15) she from?",
                options: [
                    [
                        { id: "1-1", text: "is", correct: false },
                        { id: "1-2", text: "are", correct: true },
                        { id: "1-3", text: "am", correct: false }
                    ]
                ],
                nextPage: 2110
            },
            // 画面10 (页面ID:2110)
            2110: {
                image: "画面10.jpg",
                text: "Alexa: South Korea. She (16) marketing. She (17) the classes (18) very interesting. Let's go and say hello. Sorry, what (19) your last name again? Vargas?",
                options: [
                    [
                        { id: "1-1", text: "studies", correct: true },
                        { id: "1-2", extreme: "study", correct: false },
                        { id: "1-3", text: "studying", correct: false }
                    ],
                    [
                        { id: "2-1", text: "says", correct: true },
                        { id: "2-2", text: "say", correct: false },
                        { id: "2-3", text: "saying", extreme: false }
                    ],
                    [
                        { id: "3-1", text: "is", correct: false },
                        { id: "3-2", text: "are", correct: true },
                        { id: extreme: "3-3", text: "am", correct: false }
                    ],
                    [
                        { id: "4-1", text: "is", correct: true },
                        { id: "4-2", text: "are", correct: false },
                        { id: "4-3", text: "am", correct: false }
                    ]
                ],
                nextPage: 2111
            },
            // 画面11 (页面ID:2111)
            2111: {
                image: "画面11.jpg",
                text: "Arturo: Actually, it (20) Valdez",
                options: [
                    [
                        { id: "1-1", text: "is", correct: true },
                        { id: "1-2", text: "are", correct: false },
                        { id: "1-3", text: "am", correct: false }
                    ]
                ],
                nextPage: 2112
            },
            // 画面12 (页面ID:2112)
            2112: {
                image: "画面12.jpg",
                text: "Alexa: How (21) you spell that?",
                options: [
                    [
                        { id: "1-1", text: "is", correct: false },
                        { id: "1-2", text: "are", correct: true },
                        { id: "1-3", text: "am", correct: false }
                    ]
                ],
                nextPage: 2113
            },
            // 画面13 (页面ID:2113) - 计分开始
            2113: {
                image: "画面13.jpg",
                text: "My name's Nick. My girlfriend's name (1) Karen. We (2) students. I (3) to university in Oxford.",
                options: [
                    [
                        { id: "1-1", text: "is", correct: true },
                        { id: "1-2", text: "are", correct: false },
                        { id: "1-3", text: "am", correct: false }
                    ],
                    [
                        { id: "2-1", text: "is", correct: false },
                        { id: "极值2-2", text: "are", correct: true },
                        { id: "2-3", text: "am", correct: false }
                    ],
                    [
                        { id: "3-1", text: "go", correct: true },
                        { id: "3-2", text: "goes", correct: false },
                        { id: "3-3", text: "going", correct: false }
                    ]
                ],
                nextPage: 2114
            },
            // 画面14 (页面ID:2114) - 计分
            211极值4: {
                image: "画面14.jpg",
                text: "Karen (4) go to university in Oxford; she (5) to university in Cambridge. She (6) in Cambridge.",
                options: [
                    [
                        { id: "1-1", text: "don't", correct: false },
                        { id: "1-2", text: "isn't", correct: false },
                        { id: "1-3", text: "doesn't", correct: true }
                    ],
                    [
                        { id: "2-1", text: "go", correct: false },
                        { id: "2-2", text: "goes", correct: true },
                        { id: "2-3", text: "going", correct: false }
                    ],
                    [
                        { id: "3-1", text: "lives", correct: true },
                        { id: "3-2", text: "live", correct: false },
                        { id: "3-3", text: "living", correct: false }
                    ]
                ],
                nextPage: 2115
            },
            // 画面15 (页面ID:2115) - 计分
            2115: {
                image: "画面15.jpg",
                text: "I (7) with my parents in Woodstock, which (8) a small town near Oxford.",
                options: [
                    [
                        { id: "1-1", text: "lives", correct: false },
                        { id: "1-2", text: "live", correct: true },
                        { id: "1-3", text: "living", correct: false }
                    ],
                    [
                        { id: "2-1", text: "is", correct: true },
                        { id: "2-2", text: "are", correct: false },
                        { id: "2-3", text: "am", correct: false }
                    ]
                ],
                nextPage: 2116
            },
            // 画面16 (页面ID:2116) - 计分
            2116: {
                image: "画面16.jpg",
                text: "It (9) difficult sometimes because we (10) each other only on weekends.",
                options: [
                    [
                        { id: "1-1", text: "is", correct: true },
                        { id: "1-2", text: "are", correct: false },
                        { id: "1-3", text: "am", correct: false }
                    ],
                    [
                        { id: "2-1", text: "see", correct: true },
                        { id: "2-2", text极值: "sees", correct: false },
                        { id: "2-3", text: "seeing", correct: false }
                    ]
                ],
                nextPage: 2117
            },
            // 画面17 (页面ID:2117) - 计分
            2117: {
                image: "画面17.jpg",
                text: "Karen (11) history, and she (12) her course. She (13) the architecture in Cambridge (14) beautiful.",
                options: [
                    [
                        { id: "1-1", text: "studies", correct: true },
                        { id: "1-2", text: "study", correct: false },
                        { id: "1-3", text: "studying", correct: false }
                    ],
                    [
                        { id: "2-1", text: "love", correct: false },
                        { id: "2-2", text: "loves", correct: true },
                        { id: "2-3", text: "loving", correct: false }
                    ],
                    [
                        { id: "3-1", text: "says", correct: true },
                        { id: "3-2", text: "say", correct: false },
                        { id: "3-3", text: "saying", correct: false }
                    ],
                    [
                        { id: "4-1", text: "极值is", correct: true },
                        { id: "4-2", text: "are", correct: false },
                        { id: "4-3", text: "am", correct: false }
                    ]
                ],
                nextPage: 2118
            },
            // 画面18 (页面ID:2118) - 计分
            2118: {
                image: "画面18.jpg",
                text: "I (15) philosophy and politics, so my courses (16) very different from hers.",
                options: [
                    [
                        { id: "1-1", text: "studies", correct: false },
                        { id: "1-2", text: "study", correct: true },
                        { id: "1-3", text: "studying", correct: false }
                    ],
                    [
                        { id: "2-1", text: "is", correct: false },
                        { id: "2-2", text: "are", correct: true },
                        { id: "2-3", text: "am", correct: false }
                    ]
                ],
                nextPage: 2119
            },
            // 画面19 (页面ID:2119) - 计分
            2119: {
                image: "画面19.jpg",
                text: "I (17) living in Woodstock because my family (18) there and it (19) quiet, but I (20) Karen a lot.",
                options: [
                    [
                        { id: "1-1", text: "like", correct: true },
                        { id: "1-2", text: "likes", correct: false },
                        { id: "1-3", text: "liking", correct: false }
                    ],
                    [
                        { id: "2-1", text: "is", correct: true },
                        { id: "2-2", text: "are", correct: false },
                        { id: "2-3", text: "am", correct: false }
                    ],
                    [
                        { id: "3-1", text: "is", correct: true },
                        { id: "3-2", text: "are", correct: false },
                        { id: "3-3", text: "am", correct: false }
                    ],
                    [
                        { id: "4-1", text: "miss", correct: true },
                        { id: "4-2", text: "misses", correct: false },
                       极值 { id: "4-3", text: "missing", correct: false }
                    ]
                ],
                nextPage: 2120
            },
            // 画面20 (页面ID:2120) - 计分
            2120: {
                image: "画面20.jpg",
                text: "We (21) on the phone every night and we (22) each other whenever we can.",
                options: [
                    [
                        { id: "1-1", text: "talk", correct: true },
                        { id: "1-2", text: "talks", correct: false },
                        { id: "1-3", text: "talking", correct: false }
                    ],
                    [
                        { id: "2-1", text: "visit", correct: true },
                        { id: "2-2", text: "visits", correct: false },
                        { id: "2-3", text: "visiting", correct: false }
                    ]
                ],
                nextPage: 2121
            },
            // 画面21 (页面ID:2121) - 得分画面
            2121: {
                image: "", // 根据得分动态设置
                text: "",
                options: [],
                nextPage: null
            }
        };
        
        // 全局变量
        let currentPageId = 2101; // 从第一个游戏画面开始
        let selectedOptions = {}; // 存储用户选择的选项
        let score = 0; // 得分
        
        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 从URL参数获取当前页面ID
            const urlParams = new URLSearchParams(window.location.search);
            const pageParam = urlParams.get('page');
            
            if (pageParam) {
                currentPageId = parseInt(pageParam);
            }
            
            // 初始化游戏
            initGame();
        });
        
        // 初始化游戏
        function initGame() {
            // 加载当前页面数据
            loadPage(currentPageId);
            
            // 添加Continue按钮事件监听
            document.getElementById('continue-btn').addEventListener('click', function() {
                // 处理Continue按钮点击
                handleContinue();
            });
        }
        
        // 加载页面
        function loadPage(pageId) {
            const pageData = gameData[pageId];
            
            if (!pageData) {
                console.error('页面数据不存在:', pageId);
                return;
            }
            
            // 更新页面内容
            document.getElementById('scene-image').src = 'images/' + pageData.image;
            document.getElementById('dialogue-text').textContent = pageData.text;
            
            // 清空选项容器
            const optionsContainer = document.getElementById('options-container');
            optionsContainer.innerHTML = '';
            
            // 创建选项按钮
            if (pageData.options && pageData.options.length > 0) {
                pageData.options.forEach((optionRow, rowIndex) => {
                    const rowDiv = document.createElement('div');
                    rowDiv.className = 'option-row';
                    
                    optionRow.forEach((option, colIndex) => {
                        const button = document.createElement('button');
                        button.className = 'option-btn';
                        button.textContent = option.text;
                        button.dataset.id = option.id;
                        button.dataset.correct = option.correct;
                        
                        // 添加点击事件
                        button.addEventListener('click', function() {
                            handleOptionClick(this, rowIndex);
                        });
                        
                        rowDiv.appendChild(button);
                    });
                    
                    optionsContainer.appendChild(rowDiv);
                });
            }
            
            // 如果是得分页面，特殊处理
            if (pageId === 2121) {
                showScorePage();
            }
        }
        
        // 处理选项点击
        function handleOptionClick(button, rowIndex) {
            const optionId = button.dataset.id;
            const rowDiv = button.parentElement;
            
            // 重置同一行中所有按钮的状态
            const rowButtons = rowDiv.querySelectorAll('.option-btn');
            rowButtons.forEach(btn => {
                btn.classList.remove('selected');
            });
            
            // 设置当前按钮为选中状态
            button.classList.add('selected');
            
            // 存储用户选择
            selectedOptions[rowIndex] = {
                id: optionId,
                correct: button.dataset.correct === 'true'
            };
        }
        
        // 处理Continue按钮点击
        function handleContinue() {
            // 如果当前页面有选项，检查并计分
            if (gameData[currentPageId].options && gameData[currentPageId].options.length > 0) {
                // 从第22组按钮开始计分（页面2113）
                if (currentPageId >= 2113) {
                    Object.values(selectedOptions).forEach(option => {
                        if (option.correct) {
                            score++;
                        }
                    });
                    
                    // 更新本地存储的得分
                    localStorage.setItem('score', score.toString());
                }
            }
            
            // 清空当前选择
            selectedOptions = {};
            
            // 获取下一页ID
            const nextPageId = gameData[currentPageId].nextPage;
            
            if (nextPageId) {
                // 跳转到下一页
                window.location.href = `chapter.html?page=${nextPageId}`;
            } else {
                // 没有下一页，游戏结束
                console.log('游戏结束');
            }
        }
        
        // 显示得分页面
        function showScorePage() {
            // 获取最终得分
            const finalScore = Math.round(score * 4.55);
            
            // 根据得分选择背景图片
            const bgImage = finalScore >= 60 ? '及格.jpg' : '不及格.jpg';
            document.getElementById('scene-image').src = 'images/' + bgImage;
            
            // 显示得分文本
            document.getElementById('dialogue-text').textContent = `得分: ${finalScore}`;
            
            // 隐藏选项容器和Continue按钮
            document.getElementById('options-container').style.display = 'none';
            document.getElementById('continue-btn').style.display = 'none';
            
            // 保存得分到Firebase
            saveScoreToFirebase(finalScore);
        }
        
        // 保存得分到Firebase
        function saveScoreToFirebase(score) {
            db.collection("scores").add({
                score: score,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            })
            .then((docRef) => {
                console.log("得分已保存，ID: ", docRef.id);
            })
            .catch((error) => {
                console.error("保存得分错误: ", error);
            });
        }
    </script>
</body>
</html>
