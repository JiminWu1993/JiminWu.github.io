<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>English Tenses Journey - Game</title>
    <link rel="stylesheet" href="style.css">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
</head>
<body>
    <!-- 游戏章节页面容器 -->
    <div id="game-container">
        <!-- 画面01 -->
        <div id="page-2101" class="game-page">
            <img src="images/画面01.jpg" alt="Scene 01" class="background-image">
            <div class="text-container">
                <p>Arturo: Hello, I'm Arturo Valdez.</p>
            </div>
            <div class="buttons-container">
                <button class="blue-btn continue-btn" data-next="2102">Continue</button>
            </div>
        </div>

        <!-- 画面02 -->
        <div id="page-2102" class="game-page">
            <img src="images/画面02.jpg" alt="Scene 02" class="background-image">
            <div class="text-container">
                <p>Alexa: Hi. My name <span class="blank">(1)</span> Alexandra Costa, but please <span class="blank">(2)</span> me Alexa.</p>
            </div>
            <div class="options-container">
                <div class="option-row">
                    <button class="option-btn" data-group="1" data-value="is" data-correct="true">is</button>
                    <button class="option-btn" data-group="1" data-value="am" data-correct="false">am</button>
                    <button class="option-btn" data-group="1" data-value="are" data-correct="false">are</button>
                </div>
                <div class="option-row">
                    <button class="option-btn" data-group="2" data-value="calls" data-correct="false">calls</button>
                    <button class="option-btn" data-group="2" data-value="call" data-correct="true">call</button>
                    <button class="option-btn" data-group="2" data-value="calling" data-correct="false">calling</button>
                </div>
            </div>
            <div class="buttons-container">
                <button class="blue-btn continue-btn" data-next="2103">Continue</button>
            </div>
        </div>

        <!-- 画面03 -->
        <div id="page-2103" class="game-page">
            <img src="images/画面03.jpg" alt="Scene 03" class="background-image">
            <div class="text-container">
                <p>Arturo: OK. Where <span class="blank">(3)</span> you from, Alexa?</p>
            </div>
            <div class="options-container">
                <div class="option-row">
                    <button class="option-btn" data-group="3" data-value="is" data-correct="false">is</button>
                    <button class="option-btn" data-group="3" data-value="are" data-correct="true">are</button>
                    <button class="option-btn" data-group="3" data-value="am" data-correct="false">am</button>
                </div>
            </div>
            <div class="buttons-container">
                <button class="blue-btn continue-btn" data-next="2104">Continue</button>
            </div>
        </div>

        <!-- 画面04 -->
        <div id="page-2104" class="game-page">
            <img src="images/画面04.jpg" alt="Scene 04" class="background-image">
            <div class="text-container">
                <p>Alexa: Brazil. How about you?</p>
            </div>
            <div class="buttons-container">
                <button class="blue-btn continue-btn" data-next="2105">Continue</button>
            </div>
        </div>

        <!-- 画面05 -->
        <div id="page-2105" class="game-page">
            <img src="images/画面05.jpg" alt="Scene 05" class="background-image">
            <div class="text-container">
                <p>Arturo: I'm from Mexico. I <span class="blank">(4)</span> here in the city now, but my family <span class="blank">(5)</span> in a small town near Guadalajara.</p>
            </div>
            <div class="options-container">
                <div class="option-row">
                    <button class="option-btn" data-group="4" data-value="lives" data-correct="true">lives</button>
                    <button class="option-btn" data-group="4" data-value="live" data-correct="false">live</button>
                    <button class="option-btn" data-group="4" data-value="living" data-correct="false">living</button>
                </div>
                <div class="option-row">
                    <button class="option-btn" data-group="5" data-value="lives" data-correct="true">lives</button>
                    <button class="option-btn" data-group="5" data-value="live" data-correct="false">live</button>
                    <button class="option-btn" data-group="5" data-value="are living" data-correct="false">are living</button>
                </div>
            </div>
            <div class="buttons-container">
                <button class="blue-btn continue-btn" data-next="2106">Continue</button>
            </div>
        </div>

        <!-- 画面06 -->
        <div id="page-2106" class="game-page">
            <img src="images/画面06.jpg" alt="Scene 06" class="background-image">
            <div class="text-container">
                <p>Alexa: Oh, I <span class="blank">(6)</span> Mexico! It <span class="blank">(7)</span> really beautiful. My brother <span class="blank">(8)</span> Mexico, too. Oh, good. Soo-jin <span class="blank">(9)</span> here.</p>
            </div>
            <div class="options-container">
                <div class="option-row">
                    <button class="option-btn" data-group="6" data-value="loves" data-correct="false">loves</button>
                    <button class="option-btn" data-group="6" data-value="love" data-correct="true">love</button>
                    <button class="option-btn" data-group="6" data-value="loving" data-correct="false">loving</button>
                </div>
                <div class="option-row">
                    <button class="option-btn" data-group="7" data-value="is" data-correct="true">is</button>
                    <button class="option-btn" data-group="7" data-value="am" data-correct="false">am</button>
                    <button class="option-btn" data-group="7" data-value="are" data-correct="false">are</button>
                </div>
                <div class="option-row">
                    <button class="option-btn" data-group="8" data-value="loves" data-correct="true">loves</button>
                    <button class="option-btn" data-group="8" data-value="love" data-correct="false">love</button>
                    <button class="option-btn" data-group="8" data-value="loving" data-correct="false">loving</button>
                </div>
                <div class="option-row">
                    <button class="option-btn" data-group="9" data-value="is" data-correct="true">is</button>
                    <button class="option-btn" data-group="9" data-value="are" data-correct="false">are</button>
                    <button class="option-btn" data-group="9" data-value="am" data-correct="false">am</button>
                </div>
            </div>
            <div class="buttons-container">
                <button class="blue-btn continue-btn" data-next="2107">Continue</button>
            </div>
        </div>

        <!-- 画面07 -->
        <div id="page-2107" class="game-page">
            <img src="images/画面07.jpg" alt="Scene 07" class="background-image">
            <div class="text-container">
                <p>Arturo: Who <span class="blank">(10)</span> Soo-jin? She <span class="blank">(11)</span> familiar.</p>
            </div>
            <div class="options-container">
                <div class="option-row">
                    <button class="option-btn" data-group="10" data-value="is" data-correct="true">is</button>
                    <button class="option-btn" data-group="10" data-value="are" data-correct="false">are</button>
                    <button class="option-btn" data-group="10" data-value="am" data-correct="false">am</button>
                </div>
                <极简版div class="option-row">
                    <button class="option-btn" data-group="11" data-value="looks" data-correct="true">looks</button>
                    <button class="option-btn" data-group="11" data-value="look" data-correct="false">look</极简版button>
                    <button class="option-btn" data-group="11" data-value="looking" data-correct="false">looking</button>
                </div>
            </div>
            <div class="buttons-container">
                <button class="blue-btn continue-btn" data-next="2108">Continue</button>
            </div>
        </div>

        <!-- 画面08 -->
        <div id="page-2108" class="game-page">
            <img src="images/画面08.jpg" alt="Scene 08" class="background-image">
            <div class="极简版text-container">
                <p>Alexa: She <span class="blank">(12)</span> my classmate. We <span class="blank">(13)</span> in the same business class. We <span class="blank">(14)</span> our class every Monday and Wednesday.</p>
            </div>
            <div class="options-container">
                <div class="option-row">
                    <button class="option-btn" data-group="12" data-value="is" data-correct="false">is</button>
                    <button class="option-btn" data-group="12" data-value="are" data-correct="true">are</button>
                    <button class="option-btn" data-group="12" data-value="am" data-correct="false">am</button>
                </div>
                <div class="option-row">
                    <button class="option-btn" data-group="13极简版" data-value="is" data-correct="false">is</button>
                    <button class="option-btn" data-group="13" data-value="are" data-correct="true">are</button>
                    <button class="option-btn" data-group="13" data-value="am" data-correct="false">am</button>
                </div>
                <div class="option-row">
                    <button class="option-btn" data-group="14" data-value="has" data-correct="false">has</button>
                    <button class="option-btn" data-group="14" data-value="have" data-correct="true">have</button>
                    <button class="option-btn" data-group="14" data-value="having" data-correct="false">having</button>
                </div>
            </div>
            <div class="buttons-container">
                <button class="blue-btn continue-btn" data-next="2109">Continue</button>
            </div>
        </div>

        <!-- 画面09 -->
        <div id="page-2109" class="game-page">
            <img src="images/画面09.jpg" alt="Scene 09" class="background-image">
            <div class="text-container">
                <p>Arturo: Where <span class="blank">(15)</span> she from?</p>
            </div>
            <div class="options-container">
                <div class="option-row">
                    <button class="option-btn" data-group="15" data-value="is" data-correct="false">is</button>
                    <button class="option-btn" data-group="15" data-value="are" data-correct="true">are</button>
                    <button class="option-btn" data-group="15" data-value="am" data-correct="false">am</button>
                </极简版div>
            </div>
            <div class="buttons-container">
                <button class="blue-btn continue-btn" data-next="2110">Continue</button>
            </div>
        </div>

        <!-- 画面10 -->
        <div id="page-2110" class="game-page">
            <img src="images/画面10.jpg" alt="Scene 10" class="background-image">
            <div class="text-container">
                <p>Alexa: South Korea. She <span class="blank">(16)</span> marketing. She <span class="blank">(17)</span> the classes <span class="blank">(18)</span> very interesting. Let's go and say hello. Sorry, what <span class="blank">(19)</span> your last name again? Vargas?</p>
            </div>
            <div class="options-container">
                <div class="option-row">
                    <button class="option-btn" data-group="16" data-value="studies" data-correct="true">studies</button>
                    <button class="option-btn" data-group="16" data-value="study" data-correct="false">study</button>
                    <button class="option-btn" data-group="16" data-value="studying" data-correct="false">studying</button>
                </div>
                <div class="option-row">
                    <button class="option-btn" data-group="17" data-value="says" data极简版-correct="true">says</button>
                    <button class="option-btn" data-group="17" data-value="say" data-correct="false">say</button>
                    <button class="option-btn" data-group="17" data-value="saying" data-correct="false">saying</button>
                </div>
                <div class="option-row">
                    <button class="option-btn" data-group="18" data-value="is" data-correct="false">is</button>
                    <button class="option-btn" data-group="18" data-value="are" data-correct="true">are</button>
                    <button class="option-btn" data-group="18" data-value="am" data-correct="false">am</button>
                </div>
                <div class="option-row">
                    <button class="option-btn" data-group="19" data-value="is" data-correct="true">is</button>
                    <button class="option-btn" data-group="19" data-value="are" data-correct="false">are</button>
                    <button class="option-btn" data-group="19" data-value="am" data-correct="false">am</button>
                </div>
            </div>
            <div class="buttons-container">
                <button class="blue-btn continue-btn" data-next="2111">Continue</button>
            </div>
        </div>

        <!-- 画面11 -->
        <div id="page-2111" class="game-page">
            <img src="images/画面11.jpg" alt="Scene 11" class="background-image">
            <div class="text-container">
                <p>Arturo: Actually, it <span class="blank">(20)</span> Valdez</p>
            </div>
            <div class="options-container">
                <div class="option-row">
                    <button class="option-btn" data-group="20" data-value="is" data-correct="true">is</button>
                    <button class="option-btn" data-group="20" data-value="are" data-correct="false">are</button>
                    <button class="option-btn" data-group="20" data-value="am" data-correct="false极简版">am</button>
                </div>
            </div>
            <div class="buttons-container">
                <button class="blue-btn continue-btn" data-next="2112">Continue</button>
            </div>
        </div>

        <!-- 画面12 -->
        <div id="page-2112" class="game-page">
            <img src="images/画面12.jpg" alt="Scene 12" class="background-image">
            <div class="text-container">
                <p>Alexa: How <span class="blank">(21)</span> you spell that?</p>
            </div>
            <div class="options-container">
                <div class="option-row">
                    <button class="option-btn" data-group="21" data-value="is" data-correct="false">is</button>
                    <button class="option-btn" data-group="21" data-value="are" data-correct="true">are</button>
                    <button class="option-btn" data-group="21" data-value="am" data-correct="false">am</button>
                </div>
            </div>
            <div class="buttons-container">
                <button class="blue-btn continue-btn" data-next="2113">Continue</button>
            </div>
        </div>

        <!-- 排名画面13 -->
        <div id="page-2113" class="game-page">
            <div class="ranking-header">
                <div class="room-info">
                    <p>Room: <span id="room-number-display"></span></p>
                    <p>Players: <span id="player-count">0</span></p>
                </div>
            </div>
            <div class="ranking-container">
                <table class="ranking-table">
                    <thead>
                        <tr>
                            <th>Rank</th>
                            <th>Name</th>
                            <th>Score</th>
                            <th>Accuracy</th>
                            <th>Time</th>
                        </tr>
                    </thead>
                    <tbody id="ranking-body">
                        <!-- 排行榜数据将通过JavaScript动态生成 -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Firebase配置
        const firebaseConfig = {
            apiKey: "AIzaSyDHRYTBU74r31极简版MPYVAAnRMwKM76c_-BduQ",
            authDomain: "tetrisonline-ca400.firebaseapp.com",
            projectId: "tetrisonline-ca400",
            storageBucket: "tetrisonline-ca400.firebasestorage.app",
            messagingSenderId: "58207939196",
            appId: "1:58207939196:web:b34f403204096084ee37f9",
            measurementId: "G-GG7GNEQ718"
        };

        // 初始化Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // 全局变量
        let currentPage = "2101";
        let playerAnswers = {};
        let correctCount = 0;
        let startTime = null;
        let totalTime = 0;
        let playerId = null;
        let roomId = null;
        let playerNickname = null;
        let isTeacher = false;
        let timerInterval = null;
        let preloadedImages = [];

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 获取URL参数
            const urlParams = new URLSearchParams(window.location.search);
            roomId = urlParams.get('room');
            playerId = urlParams.get('player');
            isTeacher = urlParams.get('teacher') === 'true';
            
            // 初始化页面
            initGame();
            
            // 预加载下一张图片
            preloadNextImage(parseInt(currentPage) + 1);
        });

        // 初始化游戏
        function initGame() {
            // 显示第一页
            showPage(currentPage);
            
            // 如果不是老师，开始计时
            if (!isTeacher && playerId) {
                startTime = Date.now();
                
                // 设置计时器，每3秒更新一次数据到Firebase
                timerInterval = setInterval(updatePlayerData, 3000);
            }
            
            // 如果是老师，直接显示排名页面
            if (isTeacher) {
                showPage("2113");
                startRankingUpdates();
            }
            
            // 设置继续按钮事件
            document.querySelectorAll('.continue-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const nextPage = this.getAttribute('data-next');
                    navigateToPage(nextPage);
                });
            });
            
            // 设置选项按钮事件
            document.querySelectorAll('.option-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    handleOptionClick(this);
                });
            });
        }

        // 显示指定页面
        function showPage(pageId) {
            // 隐藏所有页面
            document.querySelectorAll('.game-page').forEach(page => {
                page.classList.remove('active');
            });
            
            // 显示指定页面
            const pageElement = document.getElementById('page-' + pageId);
            if (pageElement) {
                pageElement.classList.add('active');
                currentPage = pageId;
                
                // 更新Firebase中的进度
                updateProgress();
                
                // 预加载下一张图片
                const nextPageNum = parseInt(pageId) + 1;
                if (nextPageNum <= 2112) {
                    preloadNextImage(nextPageNum);
                }
            }
        }

        // 处理选项点击
        function handleOptionClick(button) {
            const group = button.getAttribute('data-group');
            const value = button.getAttribute('data-value');
            const isCorrect = button.getAttribute('data-correct') === 'true';
            
            // 禁用同一组的其他按钮
            const groupButtons = document.querySelectorAll(`.option-btn[data-group="${group}"]`);
            groupButtons.forEach(btn => {
                btn.disabled = true;
            });
            
            // 标记选中的按钮
            if (isCorrect) {
                button.classList.add('correct');
                correctCount++;
            } else {
                button.classList.add('incorrect');
                
                // 显示正确答案
                groupButtons.forEach(btn => {
                    if (btn.getAttribute('data-correct') === 'true') {
                        btn.classList.add('show-correct');
                    }
                });
            }
            
            // 保存答案
            playerAnswers[group] = {
                value: value,
                correct: isCorrect
            };
        }

        // 导航到指定页面
        function navigateToPage(pageId) {
            // 如果是最后一页，计算分数并结束游戏
            if (pageId === "2113") {
                endGame();
            }
            
            showPage(pageId);
        }

        // 更新进度到Firebase
        function updateProgress() {
            if (!isTeacher && playerId && roomId) {
                const progress = Math.round((parseInt(currentPage) - 2100) / 21 * 100);
                
                db.collection('rooms').doc(roomId).collection('players').doc(playerId).update({
                    progress: progress,
                    lastUpdate: firebase.firestore.FieldValue.serverTimestamp()
                }).catch(error => {
                    console.error("Error updating progress:", error);
                });
            }
        }

        // 更新玩家数据到Firebase
        function updatePlayerData() {
            if (!isTeacher && playerId && roomId && startTime) {
                totalTime = Math.floor((Date.now() - startTime) / 1000);
                
                db.collection('rooms').doc(roomId).collection('players').doc(playerId).update({
                    elapsedTime: totalTime,
                    correctAnswers: correctCount,
                    lastUpdate: firebase.firestore.FieldValue.serverTimestamp()
                }).catch(error => {
                    console.error("Error updating player data:", error);
                });
            }
        }

        // 结束游戏
        function endGame() {
            // 停止计时器
            if (timerInterval) {
                clearInterval(timerInterval);
            }
            
            // 计算总分
            totalTime = Math.floor((Date.now() - startTime) / 1000);
            const timeScore = calculateTimeScore(totalTime);
            const answerScore = correctCount * 6.7;
            let totalScore = Math.min(answerScore + timeScore, 100);
            
            // 计算正确率
            const accuracy = (correctCount / 15 * 100).toFixed(1);
            
            // 更新最终分数到Firebase
            if (playerId && roomId) {
                db.collection('rooms').doc(roomId).collection('players').doc(playerId).update({
                    finished: true,
                    totalScore: totalScore,
                    accuracy: accuracy,
                    elapsedTime: totalTime,
                    correctAnswers: correctCount,
                    endTime: firebase.firestore.FieldValue.serverTimestamp()
                }).then(() => {
                    // 开始排行榜更新
                    startRankingUpdates();
                }).catch(error => {
                    console.error("Error updating final score:", error);
                });
            }
            
            // 显示房间信息
            document.getElementById('room-number-display').textContent = roomId;
        }

        // 计算时间分数
        function calculateTimeScore(seconds) {
            const minutes = Math.floor(seconds / 60);
            return minutes * 2 + (seconds % 60 > 0 ? 1 : 0);
        }

        // 开始排行榜更新
        function startRankingUpdates() {
            // 显示房间信息
            document.getElementById('room-number-display').textContent = roomId;
            
            // 设置定期更新
            updateRanking();
            setInterval(updateRanking, 3000);
        }

        // 更新排行榜
        function updateRanking() {
            if (roomId) {
                // 获取玩家数量
                db.collection('rooms').doc(roomId).collection('players')
                    .where('finished', '==', true)
                    .get()
                    .then(snapshot => {
                        document.getElementById('player-count').textContent = snapshot.size;
                    });
                
                // 获取排行榜数据
                db.collection('rooms').doc(roomId).collection('players')
                    .where('finished', '==', true)
                    .orderBy('totalScore', 'desc')
                    .limit(10)
                    .get()
                    .then(snapshot => {
                        const rankingBody = document.getElementById('ranking-body');
                        rankingBody.innerHTML = '';
                        
                        let rank = 1;
                        snapshot.forEach(doc => {
                            const player = doc.data();
                            const row = document.createElement('tr');
                            
                            // 如果是当前玩家，高亮显示
                            if (doc.id === playerId) {
                                row.classList.add('current-player');
                            }
                            
                            // 格式化时间
                            const minutes = Math.floor(player.elapsedTime / 60);
                            const seconds = player.elapsedTime % 60;
                            const timeFormatted = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                            
                            row.innerHTML = `
                                <td>${rank}</td>
                                <td>${player.nickname}</td>
                                <td>${Math.round(player.totalScore || 0)}</td>
                                <td>${player.accuracy || '0.0'}%</td>
                                <td>${timeFormatted}</td>
                            `;
                            
                            rankingBody.appendChild(row);
                            rank++;
                        });
                    })
                    .catch(error => {
                        console.error("Error getting ranking data:", error);
                    });
            }
        }

        // 预加载下一张图片
        function preloadNextImage(nextPageNum) {
            if (nextPageNum > 2112) return;
            
            const img = new Image();
            img.src = `images/画面${nextPageNum.toString().padStart(2, '0')}.jpg`;
            
            img.onload = function() {
                preloadedImages.push(img);
            };
        }
    </script>
</body>
</html>
