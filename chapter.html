<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>英语时态之旅 - 游戏章节</title>
    <link rel="stylesheet" href="style.css">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
</head>
<body>
    <!-- 游戏章节界面容器 -->
    <div id="chapter-container">
        <!-- 动态生成的游戏页面将在这里显示 -->
    </div>

    <script>
        // Firebase配置
        const firebaseConfig = {
            apiKey: "AIzaSyDHRYTBU74r31MPYVAAnRMwKM76c_-BduQ",
            authDomain: "tetrisonline-ca400.firebaseapp.com",
            projectId: "tetrisonline-ca400",
            storageBucket: "tetrisonline-ca400.firebasestorage.app",
            messagingSenderId: "58207939196",
            appId: "1:58207939196:web:b34f403204096084ee37f9",
            measurementId: "G-GG7GNEQ718"
        };

        // 初始化Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // 全局变量
        let currentRoomId = null;
        let playerId = null;
        let currentPage = 2101; // 起始页面ID
        let startTime = null;
        let selectedAnswers = {};
        let score = 0;
        let correctAnswers = 0;
        let timeSpent = 0;
        let updateInterval = null;

        // 从URL获取参数
        const urlParams = new URLSearchParams(window.location.search);
        currentRoomId = urlParams.get('room');
        playerId = urlParams.get('player');

        // 页面配置数据
        const pageConfigs = {
            2101: {
                image: "画面01.jpg",
                text: "Arturo: Hello, I'm Arturo Valdez.",
                buttons: [],
                nextPage: 2102
            },
            2102: {
                image: "画面02.jpg",
                text: "Alexa: Hi. My name (1) Alexandra Costa, but please (2) me Alexa.",
                buttons: [
                    [
                        { id: "1-1", text: "is", correct: true },
                        { id: "1-2", text: "am", correct: false },
                        { id: "1-3", text: "are", correct: false }
                    ],
                    [
                        { id: "2-1", text: "calls", correct: false },
                        { id: "2-2", text: "call", correct: true },
                        { id: "2-3", text: "calling", correct: false }
                    ]
                ],
                nextPage: 2103
            },
            2103: {
                image: "画面03.jpg",
                text: "Arturo: OK. Where (3) you from, Alexa?",
                buttons: [
                    [
                        { id: "3-1", text: "is", correct: false },
                        { id: "3-2", text: "are", correct: true },
                        { id: "3-3", text: "am", correct: false }
                    ]
                ],
                nextPage: 2104
            },
            2104: {
                image: "画面04.jpg",
                text: "Alexa: Brazil. How about you?",
                buttons: [],
                nextPage: 2105
            },
            2105: {
                image: "画面05.jpg",
                text: "Arturo: I'm from Mexico. I (4) here in the city now, but my family (5) in a small town near Guadalajara.",
                buttons: [
                    [
                        { id: "4-1", text: "lives", correct: true },
                        { id: "4-2", text: "live", correct: false },
                        { id: "4-3", text: "living", correct: false }
                    ],
                    [
                        { id: "5-1", text: "lives", correct: true },
                        { id: "5-2", text: "live", correct: false },
                        { id: "5-3", text: "are living", correct: false }
                    ]
                ],
                nextPage: 2106
            },
            2106: {
                image: "画面06.jpg",
                text: "Alexa: Oh, I (6) Mexico! It (7) really beautiful. My brother (8) Mexico, too. Oh, good. Soo-jin (9) here.",
                buttons: [
                    [
                        { id: "6-1", text: "loves", correct: false },
                        { id: "6-2", text: "love", correct: true },
                        { id: "6-3", text: "loving", correct: false }
                    ],
                    [
                        { id: "7-1", text: "is", correct: true },
                        { id: "7-2", text: "am", correct: false },
                        { id: "7-3", text: "are", correct: false }
                    ],
                    [
                        { id: "8-1", text: "loves", correct: true },
                        { id: "8-2", text: "love", correct: false },
                        { id: "8-3", text: "loving", correct: false }
                    ],
                    [
                        { id: "9-1", text: "is", correct: true },
                        { id: "9-2", text: "are", correct: false },
                        { id: "9-3", text: "am", correct: false }
                    ]
                ],
                nextPage: 2107
            },
            2107: {
                image: "画面07.jpg",
                text: "Arturo: Who (10) Soo-jin? She (11) familiar.",
                buttons: [
                    [
                        { id: "10-1", text: "is", correct: true },
                        { id: "10-2", text: "are", correct: false },
                        { id: "10-3", text: "am", correct: false }
                    ],
                    [
                        { id: "11-1", text: "looks", correct: true },
                        { id: "11-2", text: "look", correct: false },
                        { id: "11-3", text: "looking", correct: false }
                    ]
                ],
                nextPage: 2108
            },
            2108: {
                image: "画面08.jpg",
                text: "Alexa: She (12) my classmate. We (13) in the same business class. We (14) our class every Monday and Wednesday.",
                buttons: [
                    [
                        { id: "12-1", text: "is", correct: false },
                        { id: "12-2", text: "are", correct: true },
                        { id: "12-3", text: "am", correct: false }
                    ],
                    [
                        { id: "13-1", text: "is", correct: false },
                        { id: "13-2", text: "are", correct: true },
                        { id: "13-3", text: "am", correct: false }
                    ],
                    [
                        { id: "14-1", text: "has", correct: false },
                        { id: "14-2", text: "have", correct: true },
                        { id: "14-3", text: "having", correct: false }
                    ]
                ],
                nextPage: 2109
            },
            2109: {
                image: "画面09.jpg",
                text: "Arturo: Where (15) she from?",
                buttons: [
                    [
                        { id: "15-1", text: "is", correct: false },
                        { id: "15-2", text: "are", correct: true },
                        { id: "15-3", text: "am", correct: false }
                    ]
                ],
                nextPage: 2110
            },
            2110: {
                image: "画面10.jpg",
                text: "Alexa: South Korea. She (16) marketing. She (17) the classes (18) very interesting. Let's go and say hello. Sorry, what (19) your last name again? Vargas?",
                buttons: [
                    [
                        { id: "16-1", text: "studies", correct: true },
                        { id: "16-2", text: "study", correct: false },
                        { id: "16-3", text: "studying", correct: false }
                    ],
                    [
                        { id: "17-1", text: "says", correct: true },
                        { id: "17-2", text: "say", correct: false },
                        { id: "17-3", text: "saying", correct: false }
                    ],
                    [
                        { id: "18-1", text: "is", correct: false },
                        { id: "18-2", text: "are", correct: true },
                        { id: "18-3", text: "am", correct: false }
                    ],
                    [
                        { id: "19-1", text: "is", correct: true },
                        { id: "19-2", text: "are", correct: false },
                        { id: "19-3", text: "am", correct: false }
                    ]
                ],
                nextPage: 2111
            },
            2111: {
                image: "画面11.jpg",
                text: "Arturo: Actually, it (20) Valdez",
                buttons: [
                    [
                        { id: "20-1", text: "is", correct: true },
                        { id: "20-2", text: "are", correct: false },
                        { id: "20-3", text: "am", correct: false }
                    ]
                ],
                nextPage: 2112
            },
            2112: {
                image: "画面12.jpg",
                text: "Alexa: How (21) you spell that?",
                buttons: [
                    [
                        { id: "21-1", text: "is", correct: false },
                        { id: "21-2", text: "are", correct: true },
                        { id: "21-3", text: "am", correct: false }
                    ]
                ],
                nextPage: 2213 // 排名画面
            }
        };

        // 初始化游戏
        async function initGame() {
            if (!currentRoomId || !playerId) {
                alert("Invalid room or player information. Redirecting to home.");
                window.location.href = "index.html";
                return;
            }

            // 开始计时
            startTime = Date.now();
            
            // 设置定时更新玩家数据到Firebase
            updateInterval = setInterval(updatePlayerData, 3000);
            
            // 加载第一个页面
            loadPage(currentPage);
            
            // 预加载下一张图片
            preloadNextImage(currentPage);
        }

        // 加载指定页面
        function loadPage(pageId) {
            const config = pageConfigs[pageId];
            if (!config) {
                console.error("Page configuration not found for:", pageId);
                return;
            }

            const container = document.getElementById('chapter-container');
            container.innerHTML = '';

            // 创建页面元素
            const pageDiv = document.createElement('div');
            pageDiv.className = 'screen active';
            pageDiv.id = `page-${pageId}`;

            // 添加背景图片
            const img = document.createElement('img');
            img.src = `images/${config.image}`;
            img.alt = `Page ${pageId}`;
            img.className = 'background-image fade-in';
            pageDiv.appendChild(img);

            // 添加文字显示区域
            const textDiv = document.createElement('div');
            textDiv.className = 'text-display';
            textDiv.textContent = config.text;
            pageDiv.appendChild(textDiv);

            // 添加按钮区域（如果有按钮）
            if (config.buttons && config.buttons.length > 0) {
                const buttonContainer = document.createElement('div');
                buttonContainer.className = 'button-options';
                
                config.buttons.forEach((buttonRow, rowIndex) => {
                    const rowDiv = document.createElement('div');
                    rowDiv.className = 'button-row';
                    
                    buttonRow.forEach(buttonConfig => {
                        const button = document.createElement('button');
                        button.className = 'option-btn';
                        button.id = buttonConfig.id;
                        button.textContent = buttonConfig.text;
                        
                        // 存储正确答案信息
                        button.dataset.correct = buttonConfig.correct;
                        
                        button.addEventListener('click', () => handleOptionClick(buttonConfig.id, buttonConfig.correct, rowIndex));
                        rowDiv.appendChild(button);
                    });
                    
                    buttonContainer.appendChild(rowDiv);
                });
                
                pageDiv.appendChild(buttonContainer);
            }

            // 添加Continue按钮
            const continueBtn = document.createElement('button');
            continueBtn.className = 'continue-btn';
            continueBtn.textContent = 'Continue';
            continueBtn.addEventListener('click', () => handleContinue(pageId, config.nextPage));
            
            // 初始状态下Continue按钮不可用（如果有选项需要选择）
            if (config.buttons && config.buttons.length > 0) {
                continueBtn.disabled = true;
            }
            
            pageDiv.appendChild(continueBtn);
            container.appendChild(pageDiv);

            // 更新当前页面
            currentPage = pageId;
            
            // 更新玩家进度
            updateProgress();
        }

        // 处理选项点击
        function handleOptionClick(buttonId, isCorrect, rowIndex) {
            // 禁用同一行中的所有按钮
            const rowButtons = document.querySelectorAll(`.button-row:nth-child(${rowIndex + 1}) .option-btn`);
            rowButtons.forEach(btn => {
                btn.disabled = true;
            });
            
            // 高亮选中的按钮
            const selectedButton = document.getElementById(buttonId);
            selectedButton.classList.add('selected');
            
            if (isCorrect) {
                selectedButton.classList.add('correct');
                score += 6.7;
                correctAnswers++;
            } else {
                selectedButton.classList.add('incorrect');
            }
            
            // 存储答案
            selectedAnswers[buttonId] = isCorrect;
            
            // 检查是否所有行都已选择，如果是则启用Continue按钮
            const allRowsSelected = checkAllRowsSelected();
            if (allRowsSelected) {
                document.querySelector('.continue-btn').disabled = false;
            }
        }

        // 检查是否所有行都已选择
        function checkAllRowsSelected() {
            const config = pageConfigs[currentPage];
            if (!config.buttons) return true;
            
            for (let i = 0; i < config.buttons.length; i++) {
                const rowButtons = document.querySelectorAll(`.button-row:nth-child(${i + 1}) .option-btn`);
                const rowSelected = Array.from(rowButtons).some(btn => btn.classList.contains('selected'));
                
                if (!rowSelected) {
                    return false;
                }
            }
            
            return true;
        }

        // 处理Continue按钮点击
        function handleContinue(currentPageId, nextPageId) {
            if (nextPageId === 2213) {
                // 游戏结束，跳转到排名页面
                finishGame();
            } else {
                // 加载下一页
                loadPage(nextPageId);
                // 预加载下一张图片
                preloadNextImage(nextPageId);
            }
        }

        // 预加载下一张图片
        function preloadNextImage(pageId) {
            const nextPageId = pageConfigs[pageId].nextPage;
            if (nextPageId && pageConfigs[nextPageId]) {
                const img = new Image();
                img.src = `images/${pageConfigs[nextPageId].image}`;
            }
        }

        // 更新玩家进度
        function updateProgress() {
            const pageNumber = parseInt(currentPage.toString().slice(2)); // 从2101中提取01
            const progress = Math.round((pageNumber / 21) * 100);
            
            // 更新本地变量
            timeSpent = Math.floor((Date.now() - startTime) / 1000);
            
            // 实时更新到Firebase
            updatePlayerData();
            
            return progress;
        }

        // 更新玩家数据到Firebase
        async function updatePlayerData() {
            if (!currentRoomId || !playerId) return;
            
            try {
                const progress = updateProgress();
                
                await db.collection('rooms').doc(currentRoomId).update({
                    [`players.${playerId}.score`]: score,
                    [`players.${playerId}.correctAnswers`]: correctAnswers,
                    [`players.${playerId}.progress`]: progress,
                    [`players.${playerId}.timeSpent`]: timeSpent,
                    [`players.${playerId}.updatedAt`]: firebase.firestore.FieldValue.serverTimestamp()
                });
            } catch (error) {
                console.error("Error updating player data:", error);
            }
        }

        // 完成游戏
        async function finishGame() {
            // 停止定时更新
            clearInterval(updateInterval);
            
            // 计算最终分数
            timeSpent = Math.floor((Date.now() - startTime) / 1000);
            const timeScore = Math.ceil(timeSpent / 60) * 2;
            let totalScore = Math.round(score - timeScore);
            totalScore = Math.min(Math.max(totalScore, 0), 100);
            
            const accuracy = ((correctAnswers / 15) * 100).toFixed(1);
            
            // 更新最终成绩到Firebase
            try {
                await db.collection('rooms').doc(currentRoomId).update({
                    [`players.${playerId}.score`]: totalScore,
                    [`players.${playerId}.correctAnswers`]: correctAnswers,
                    [`players.${playerId}.accuracy`]: accuracy,
                    [`players.${playerId}.timeSpent`]: timeSpent,
                    [`players.${playerId}.status`]: 'finished',
                    [`players.${playerId}.finishedAt`]: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // 跳转到排名页面
                window.location.href = `ranking.html?room=${currentRoomId}&player=${playerId}`;
            } catch (error) {
                console.error("Error finishing game:", error);
                alert("Error finishing game. Please try again.");
            }
        }

        // 页面加载完成后初始化游戏
        window.addEventListener('load', initGame);
    </script>
</body>
</html>
