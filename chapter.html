<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>英语时态之旅 - 游戏章节</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <style>
        /* 章节页面特定样式 */
        #game-container {
            position: relative;
            width: 100%;
            height: 100vh;
            overflow: hidden;
            background-color: black;
        }
        
        .game-page {
            display: none;
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
        }
        
        .game-page.active {
            display: block;
        }
        
        .page-image {
            width: 100%;
            height: auto;
            display: block;
        }
        
        .text-container {
            position: absolute;
            bottom: 25%;
            width: 100%;
            padding: 15px;
            background-color: rgba(0, 0, 0, 0.7);
            text-align: center;
            font-size: 18px;
            min-height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .buttons-container {
            position: absolute;
            bottom: 10%;
            width: 100%;
            padding: 0 10px;
        }
        
        .button-row {
            display: flex;
            justify-content: space-around;
            margin-bottom: 10px;
        }
        
        .answer-btn {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 12px 5px;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            width: 30%;
            min-height: 40px;
            transition: all 0.3s;
        }
        
        .answer-btn.selected {
            background-color: #0056b3;
            transform: scale(1.05);
        }
        
        .answer-btn.correct {
            background-color: #28a745;
        }
        
        .answer-btn.incorrect {
            background-color: #dc3545;
        }
        
        .answer-btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }
        
        .continue-btn {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #007bff;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            z-index: 10;
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            color: white;
            font-size: 20px;
        }
        
        /* 动画效果 */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .fade-in {
            animation: fadeIn 0.5s forwards;
        }
    </style>
</head>
<body>
    <div id="game-container">
        <!-- 动态加载的游戏画面将在这里显示 -->
        <div class="loading-overlay" id="loading-overlay">
            <div>Loading game...</div>
        </div>
    </div>

    <script>
        // Firebase配置
        const firebaseConfig = {
            apiKey: "AIzaSyDHRYTBU74r31MPYVAAnRMwKM76c_-BduQ",
            authDomain: "tetrisonline-ca400.firebaseapp.com",
            projectId: "tetrisonline-ca400",
            storageBucket: "tetrisonline-ca400.firebasestorage.app",
            messagingSenderId: "58207939196",
            appId: "1:58207939196:web:b34f403204096084ee37f9",
            measurementId: "G-GG7GNEQ718"
        };

        // 初始化Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // 游戏状态
        const urlParams = new URLSearchParams(window.location.search);
        const roomId = urlParams.get('room');
        const playerId = urlParams.get('player');
        
        let currentPage = 2101; // 起始页面ID
        let score = 0;
        let correctAnswers = 0;
        let startTime = Date.now();
        let selectedAnswers = {};
        let preloadedImages = {};
        let playerRef = null;
        let roomRef = null;

        // 所有页面配置
        const pageConfigs = {
            2101: {
                image: "画面01.jpg",
                text: "Arturo: Hello, I'm Arturo Valdez.",
                buttons: [],
                nextPage: 2102
            },
            2102: {
                image: "画面02.jpg",
                text: "Alexa: Hi. My name (1) Alexandra Costa, but please (2) me Alexa.",
                buttons: [
                    [
                        { id: "1-1", text: "is", correct: true },
                        { id: "1-2", text: "am", correct: false },
                        { id: "1-3", text: "are", correct: false }
                    ],
                    [
                        { id: "2-1", text: "calls", correct: false },
                        { id: "2-2", text: "call", correct: true },
                        { id: "2-3", text: "calling", correct: false }
                    ]
                ],
                nextPage: 2103
            },
            2103: {
                image: "画面03.jpg",
                text: "Arturo: OK. Where (3) you from, Alexa?",
                buttons: [
                    [
                        { id: "3-1", text: "is", correct: false },
                        { id: "3-2", text: "are", correct: true },
                        { id: "3-3", text: "am", correct: false }
                    ]
                ],
                nextPage: 2104
            },
            2104: {
                image: "画面04.jpg",
                text: "Alexa: Brazil. How about you?",
                buttons: [],
                nextPage: 2105
            },
            2105: {
                image: "画面05.jpg",
                text: "Arturo: I'm from Mexico. I (4) here in the city now, but my family (5) in a small town near Guadalajara.",
                buttons: [
                    [
                        { id: "4-1", text: "lives", correct: true },
                        { id: "4-2", text: "live", correct: false },
                        { id: "4-3", text: "living", correct: false }
                    ],
                    [
                        { id: "5-1", text: "lives", correct: true },
                        { id: "5-2", text: "live", correct: false },
                        { id: "5-3", text: "are living", correct: false }
                    ]
                ],
                nextPage: 2106
            },
            2106: {
                image: "画面06.jpg",
                text: "Alexa: Oh, I (6) Mexico! It (7) really beautiful. My brother (8) Mexico, too. Oh, good. Soo-jin (9) here.",
                buttons: [
                    [
                        { id: "6-1", text: "loves", correct: false },
                        { id: "6-2", text: "love", correct: true },
                        { id: "6-3", text: "loving", correct: false }
                    ],
                    [
                        { id: "7-1", text: "is", correct: true },
                        { id: "7-2", text: "am", correct: false },
                        { id: "7-3", text: "are", correct: false }
                    ],
                    [
                        { id: "8-1", text: "loves", correct: true },
                        { id: "8-2", text: "love", correct: false },
                        { id: "8-3", text: "loving", correct: false }
                    ],
                    [
                        { id: "9-1", text: "is", correct: true },
                        { id: "9-2", text: "are", correct: false },
                        { id: "9-3", text: "am", correct: false }
                    ]
                ],
                nextPage: 2107
            },
            2107: {
                image: "画面07.jpg",
                text: "Arturo: Who (10) Soo-jin? She (11) familiar.",
                buttons: [
                    [
                        { id: "10-1", text: "is", correct: true },
                        { id: "10-2", text: "are", correct: false },
                        { id: "10-3", text: "am", correct: false }
                    ],
                    [
                        { id: "11-1", text: "looks", correct: true },
                        { id: "11-2", text: "look", correct: false },
                        { id: "11-3", text: "looking", correct: false }
                    ]
                ],
                nextPage: 2108
            },
            2108: {
                image: "画面08.jpg",
                text: "Alexa: She (12) my classmate. We (13) in the same business class. We (14) our class every Monday and Wednesday.",
                buttons: [
                    [
                        { id: "12-1", text: "is", correct: false },
                        { id: "12-2", text: "are", correct: true },
                        { id: "12-3", text: "am", correct: false }
                    ],
                    [
                        { id: "13-1", text: "is", correct: false },
                        { id: "13-2", text: "are", correct: true },
                        { id: "13-3", text: "am", correct: false }
                    ],
                    [
                        { id: "14-1", text: "has", correct: false },
                        { id: "14-2", text: "have", correct: true },
                        { id: "14-3", text: "having", correct: false }
                    ]
                ],
                nextPage: 2109
            },
            2109: {
                image: "画面09.jpg",
                text: "Arturo: Where (15) she from?",
                buttons: [
                    [
                        { id: "15-1", text: "is", correct: false },
                        { id: "15-2", text: "are", correct: true },
                        { id: "15-3", text: "am", correct: false }
                    ]
                ],
                nextPage: 2110
            },
            2110: {
                image: "画面10.jpg",
                text: "Alexa: South Korea. She (16) marketing. She (17) the classes (18) very interesting. Let's go and say hello. Sorry, what (19) your last name again? Vargas?",
                buttons: [
                    [
                        { id: "16-1", text: "studies", correct: true },
                        { id: "16-2", text: "study", correct: false },
                        { id: "16-3", text: "studying", correct: false }
                    ],
                    [
                        { id: "17-1", text: "says", correct: true },
                        { id: "17-2", text: "say", correct: false },
                        { id: "17-3", text: "saying", correct: false }
                    ],
                    [
                        { id: "18-1", text: "is", correct: false },
                        { id: "18-2", text: "are", correct: true },
                        { id: "18-3", text: "am", correct: false }
                    ],
                    [
                        { id: "19-1", text: "is", correct: true },
                        { id: "19-2", text: "are", correct: false },
                        { id: "19-3", text: "am", correct: false }
                    ]
                ],
                nextPage: 2111
            },
            2111: {
                image: "画面11.jpg",
                text: "Arturo: Actually, it (20) Valdez",
                buttons: [
                    [
                        { id: "20-1", text: "is", correct: true },
                        { id: "20-2", text: "are", correct: false },
                        { id: "20-3", text: "am", correct: false }
                    ]
                ],
                nextPage: 2112
            },
            2112: {
                image: "画面12.jpg",
                text: "Alexa: How (21) you spell that?",
                buttons: [
                    [
                        { id: "21-1", text: "is", correct: false },
                        { id: "21-2", text: "are", correct: true },
                        { id: "21-3", text: "am", correct: false }
                    ]
                ],
                nextPage: 2213
            },
            2213: {
                image: null, // 排名页面没有图片
                text: "Game Over! Your results:",
                buttons: [],
                nextPage: null
            }
        };

        // 初始化游戏
        async function initGame() {
            try {
                // 检查必要的参数
                if (!roomId || !playerId) {
                    alert("Missing room or player information. Redirecting to start page.");
                    window.location.href = "index.html";
                    return;
                }
                
                // 设置Firebase引用
                roomRef = db.collection('rooms').doc(roomId);
                playerRef = roomRef.collection('players').doc(playerId);
                
                // 检查房间是否存在
                const roomDoc = await roomRef.get();
                if (!roomDoc.exists) {
                    alert("Room does not exist. Redirecting to start page.");
                    window.location.href = "index.html";
                    return;
                }
                
                // 开始计时
                startTime = Date.now();
                
                // 预加载第一张图片
                preloadImage(pageConfigs[currentPage].image);
                
                // 显示第一页
                showPage(currentPage);
                
                // 启动Firebase同步
                startFirebaseSync();
                
                // 隐藏加载界面
                document.getElementById('loading-overlay').style.display = 'none';
            } catch (error) {
                console.error('Error initializing game:', error);
                alert('Error initializing game. Please try again.');
            }
        }

        // 显示页面
        function showPage(pageId) {
            const config = pageConfigs[pageId];
            if (!config) {
                console.error('No configuration found for page:', pageId);
                return;
            }
            
            // 创建页面容器
            const pageDiv = document.createElement('div');
            pageDiv.id = `page-${pageId}`;
            pageDiv.className = 'game-page active';
            
            // 添加图片（如果不是排名页面）
            if (config.image) {
                const img = document.createElement('img');
                img.src = `images/${config.image}`;
                img.className = 'page-image fade-in';
                img.alt = `Page ${pageId}`;
                pageDiv.appendChild(img);
            }
            
            // 添加文本容器
            const textDiv = document.createElement('div');
            textDiv.className = 'text-container';
            textDiv.innerHTML = `<p>${config.text}</p>`;
            pageDiv.appendChild(textDiv);
            
            // 添加按钮容器（如果有按钮）
            if (config.buttons && config.buttons.length > 0) {
                const buttonsContainer = document.createElement('div');
                buttonsContainer.className = 'buttons-container';
                
                config.buttons.forEach((row, rowIndex) => {
                    const rowDiv = document.createElement('div');
                    rowDiv.className = 'button-row';
                    
                    row.forEach(btnConfig => {
                        const button = document.createElement('button');
                        button.id = `${pageId}-${btnConfig.id}`;
                        button.className = 'answer-btn';
                        button.textContent = btnConfig.text;
                        button.dataset.correct = btnConfig.correct;
                        button.dataset.buttonId = btnConfig.id;
                        
                        // 如果之前已经选择过这个按钮，显示选择状态
                        if (selectedAnswers[pageId] && selectedAnswers[pageId].buttonId === btnConfig.id) {
                            button.classList.add('selected');
                            if (selectedAnswers[pageId].isCorrect) {
                                button.classList.add('correct');
                            } else {
                                button.classList.add('incorrect');
                            }
                            button.disabled = true;
                        }
                        
                        button.addEventListener('click', function() {
                            handleAnswerClick(pageId, btnConfig.id, btnConfig.correct, rowIndex);
                        });
                        
                        rowDiv.appendChild(button);
                    });
                    
                    buttonsContainer.appendChild(rowDiv);
                });
                
                pageDiv.appendChild(buttonsContainer);
            }
            
            // 添加继续按钮（如果不是排名页面）
            if (pageId !== 2213) {
                const continueBtn = document.createElement('button');
                continueBtn.id = `continue-${pageId}`;
                continueBtn.className = 'continue-btn';
                continueBtn.textContent = 'Continue';
                
                // 如果有按钮且未选择所有答案，禁用继续按钮
                if (config.buttons && config.buttons.length > 0) {
                    const allRowsSelected = config.buttons.every((row, rowIndex) => {
                        return selectedAnswers[pageId] && selectedAnswers[pageId][`row-${rowIndex}`];
                    });
                    
                    if (!allRowsSelected) {
                        continueBtn.disabled = true;
                        continueBtn.style.opacity = '0.5';
                    }
                }
                
                continueBtn.addEventListener('click', function() {
                    goToNextPage(config.nextPage);
                });
                
                pageDiv.appendChild(continueBtn);
            } else {
                // 排名页面特殊处理
                showRankingPage(pageDiv);
            }
            
            // 清空容器并添加新页面
            const gameContainer = document.getElementById('game-container');
            gameContainer.innerHTML = '';
            gameContainer.appendChild(pageDiv);
            
            // 更新进度
            updateProgress(pageId);
            
            // 预加载下一页的图片
            if (config.nextPage && pageConfigs[config.nextPage] && pageConfigs[config.nextPage].image) {
                preloadImage(pageConfigs[config.nextPage].image);
            }
        }

        // 处理答案选择
        function handleAnswerClick(pageId, buttonId, isCorrect, rowIndex) {
            const button = document.getElementById(`${pageId}-${buttonId}`);
            
            // 禁用同一行的其他按钮
            const rowButtons = document.querySelectorAll(`#page-${pageId} .button-row:nth-child(${rowIndex + 1}) .answer-btn`);
            rowButtons.forEach(btn => {
                btn.disabled = true;
            });
            
            // 高亮选中的按钮
            button.classList.add('selected');
            
            if (isCorrect) {
                button.classList.add('correct');
                score += 6.7;
                correctAnswers++;
            } else {
                button.classList.add('incorrect');
            }
            
            // 记录选择的答案
            if (!selectedAnswers[pageId]) {
                selectedAnswers[pageId] = {};
            }
            selectedAnswers[pageId][`row-${rowIndex}`] = {
                buttonId: buttonId,
                isCorrect: isCorrect
            };
            
            // 启用继续按钮（如果所有行都已选择）
            const config = pageConfigs[pageId];
            const allRowsSelected = config.buttons.every((row, idx) => {
                return selectedAnswers[pageId] && selectedAnswers[pageId][`row-${idx}`];
            });
            
            if (allRowsSelected) {
                const continueBtn = document.getElementById(`continue-${pageId}`);
                if (continueBtn) {
                    continueBtn.disabled = false;
                    continueBtn.style.opacity = '1';
                }
            }
            
            // 更新Firebase中的玩家数据
            updatePlayerData();
        }

        // 转到下一页
        function goToNextPage(nextPageId) {
            if (!nextPageId) {
                // 游戏结束，跳转到排行榜
                endGame();
                return;
            }
            
            currentPage = nextPageId;
            showPage(currentPage);
        }

        // 预加载图片
        function preloadImage(imageName) {
            if (!imageName || preloadedImages[imageName]) return;
            
            const img = new Image();
            img.src = `images/${imageName}`;
            preloadedImages[imageName] = true;
        }

        // 更新进度
        function updateProgress(pageId) {
            const pageNum = parseInt(pageId.toString().substring(1)) - 2100;
            const progress = Math.floor((pageNum / 21) * 100);
            
            // 更新Firebase中的进度
            if (playerRef) {
                playerRef.update({
                    progress: progress,
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                }).catch(error => {
                    console.error('Error updating progress:', error);
                });
            }
        }

        // 更新玩家数据到Firebase
        async function updatePlayerData() {
            const timeSpent = Math.floor((Date.now() - startTime) / 1000);
            const accuracy = correctAnswers > 0 ? Math.round((correctAnswers / 15) * 100) / 100 : 0;
            const totalScore = calculateTotalScore();
            
            try {
                await playerRef.update({
                    score: totalScore,
                    accuracy: accuracy,
                    timeSpent: timeSpent,
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                });
            } catch (error) {
                console.error('Error updating player data:', error);
            }
        }

        // 计算总分
        function calculateTotalScore() {
            const timeSpentMinutes = Math.floor((Date.now() - startTime) / 60000);
            const timeScore = timeSpentMinutes * 2 + 1; // 每分钟2分，不满一分钟按1分计算
            
            let totalScore = score + timeScore;
            return Math.min(Math.floor(totalScore), 100); // 不超过100分
        }

        // 开始Firebase同步
        function startFirebaseSync() {
            // 每3秒同步一次数据
            setInterval(updatePlayerData, 3000);
        }

        // 显示排名页面
        function showRankingPage(container) {
            // 创建排名页面内容
            const rankingDiv = document.createElement('div');
            rankingDiv.className = 'ranking-container';
            rankingDiv.innerHTML = `
                <h2>Game Completed!</h2>
                <div class="player-stats">
                    <p>Your Score: <span id="final-score">${calculateTotalScore()}</span></p>
                    <p>Accuracy: <span id="final-accuracy">${(correctAnswers / 15 * 100).toFixed(1)}%</span></p>
                    <p>Time Spent: <span id="final-time">${formatTime(Math.floor((Date.now() - startTime) / 1000))}</span></p>
                </div>
                <div class="room-info">
                    <p>Room: ${roomId}</p>
                    <p>Players: <span id="player-count">0</span></p>
                </div>
                <div class="ranking-header">
                    <h3>Top 10 Players</h3>
                </div>
                <table class="ranking-table">
                    <thead>
                        <tr>
                            <th>Rank</th>
                            <th>Name</th>
                            <th>Score</th>
                            <th>Accuracy</th>
                            <th>Time</th>
                        </tr>
                    </thead>
                    <tbody id="ranking-body">
                        <!-- 排名数据将通过JavaScript动态添加 -->
                    </tbody>
                </table>
            `;
            
            container.appendChild(rankingDiv);
            
            // 获取并显示排名数据
            loadRankingData();
        }

        // 加载排名数据
        async function loadRankingData() {
            try {
                // 获取所有玩家数据并按分数排序
                const playersSnapshot = await roomRef.collection('players')
                    .orderBy('score', 'desc')
                    .limit(10)
                    .get();
                
                const rankingBody = document.getElementById('ranking-body');
                rankingBody.innerHTML = '';
                
                let rank = 1;
                playersSnapshot.forEach(doc => {
                    const player = doc.data();
                    const row = document.createElement('tr');
                    
                    // 高亮显示当前玩家
                    if (doc.id === playerId) {
                        row.classList.add('current-player');
                    }
                    
                    row.innerHTML = `
                        <td>${rank}</td>
                        <td>${player.nickname || 'Unknown'}</td>
                        <td>${player.score || 0}</td>
                        <td>${player.accuracy ? (player.accuracy * 100).toFixed(1) + '%' : '0%'}</td>
                        <td>${formatTime(player.timeSpent || 0)}</td>
                    `;
                    
                    rankingBody.appendChild(row);
                    rank++;
                });
                
                // 更新玩家数量
                const playerCount = await roomRef.collection('players').count().get();
                document.getElementById('player-count').textContent = playerCount.data().count;
                
            } catch (error) {
                console.error('Error loading ranking data:', error);
            }
        }

        // 格式化时间显示
        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            return `${minutes}:${remainingSeconds < 10 ? '0' : ''}${remainingSeconds}`;
        }

        // 结束游戏
        async function endGame() {
            // 计算最终得分
            const finalScore = calculateTotalScore();
            const accuracy = (correctAnswers / 15 * 100).toFixed(1);
            const timeSpent = Math.floor((Date.now() - startTime) / 1000);
            
            // 更新Firebase中的玩家状态为已完成
            try {
                await playerRef.update({
                    status: 'finished',
                    score: finalScore,
                    accuracy: accuracy,
                    timeSpent: timeSpent,
                    progress: 100,
                    finishedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // 显示排名页面
                currentPage = 2213;
                showPage(currentPage);
                
            } catch (error) {
                console.error('Error ending game:', error);
                alert('Error saving game results. Please try again.');
            }
        }

        // 初始化游戏
        window.addEventListener('load', initGame);
    </script>
</body>
</html>
