<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>英语时态之旅 - 游戏</title>
    <link rel="stylesheet" href="style.css">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
</head>
<body>
    <!-- 游戏画面容器 -->
    <div id="game-container">
        <!-- 动态加载的游戏画面将在这里显示 -->
    </div>

    <!-- 排名画面 -->
    <div id="ranking-screen" class="screen">
        <div class="top-info">
            <div>Room: <span id="room-id-display"></span></div>
            <div>Players: <span id="player-count">0</span></div>
        </div>
        <div class="ranking-table-container">
            <table id="ranking-table">
                <thead>
                    <tr>
                        <th>Rank</th>
                        <th>Name</th>
                        <th>Score</th>
                        <th>Accuracy</th>
                        <th>Time</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- 排行榜数据将动态填充 -->
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // Firebase配置
        const firebaseConfig = {
            apiKey: "AIzaSyDHRYTBU74r31MPYVAAnRMwKM76c_-BduQ",
            authDomain: "tetrisonline-ca400.firebaseapp.com",
            projectId: "tetrisonline-ca400",
            storageBucket: "tetrisonline-ca400.firebasestorage.app",
            messagingSenderId: "58207939196",
            appId: "1:58207939196:web:b34f403204096084ee37f9",
            measurementId: "G-GG7GNEQ718"
        };

        // 初始化Firebase
        let db;
        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            console.log("Firebase initialized successfully");
        } catch (error) {
            console.error("Firebase initialization error:", error);
            alert("Database connection failed. Please refresh the page.");
        }

        // 游戏数据
        const gameData = {
            currentPage: 1,
            score: 0,
            startTime: null,
            elapsedTime: 0,
            selectedAnswers: {},
            playerId: null,
            roomId: null,
            nickname: null,
            isTeacher: false
        };

        // 游戏画面配置
        const scenes = [
            { id: 2101, image: '画面01.jpg', text: "Arturo: Hello, I'm Arturo Valdez.", buttons: [] },
            { 
                id: 2102, 
                image: '画面02.jpg', 
                text: "Alexa: Hi. My name (1) Alexandra Costa, but please (2) me Alexa.", 
                buttons: [
                    { group: 1, options: [
                        { id: '1-1', text: 'is', correct: true },
                        { id: '1-2', text: 'am', correct: false },
                        { id: '1-3', text: 'are', correct: false }
                    ]},
                    { group: 2, options: [
                        { id: '2-1', text: 'calls', correct: false },
                        { id: '2-2', text: 'call', correct: true },
                        { id: '2-3', text: 'calling', correct: false }
                    ]}
                ]
            },
            { 
                id: 2103, 
                image: '画面03.jpg', 
                text: "Arturo: OK. Where (3) you from, Alexa?", 
                buttons: [
                    { group: 3, options: [
                        { id: '3-1', text: 'is', correct: false },
                        { id: '3-2', text: 'are', correct: true },
                        { id: '3-3', text: 'am', correct: false }
                    ]}
                ]
            },
            { id: 2104, image: '画面04.jpg', text: "Alexa: Brazil. How about you?", buttons: [] },
            { 
                id: 2105, 
                image: '画面05.jpg', 
                text: "Arturo: I'm from Mexico. I (4) here in the city now, but my family (5) in a small town near Guadalajara.", 
                buttons: [
                    { group: 4, options: [
                        { id: '4-1', text: 'lives', correct: true },
                        { id: '4-2', text: 'live', correct: false },
                        { id: '4-3', text: 'living', correct: false }
                    ]},
                    { group: 5, options: [
                        { id: '5-1', text: 'lives', correct: true },
                        { id: '5-2', text: 'live', correct: false },
                        { id: '5-3', text: 'are living', correct: false }
                    ]}
                ]
            },
            { 
                id: 2106, 
                image: '画面06.jpg', 
                text: "Alexa: Oh, I (6) Mexico! It (7) really beautiful. My brother (8) Mexico, too. Oh, good. Soo-jin (9) here.", 
                buttons: [
                    { group: 6, options: [
                        { id: '6-1', text: 'loves', correct: false },
                        { id: '6-2', text: 'love', correct: true },
                        { id: '6-3', text: 'loving', correct: false }
                    ]},
                    { group: 7, options: [
                        { id: '7-1', text: 'is', correct: true },
                        { id: '7-2', text: 'am', correct: false },
                        { id: '7-3', text: 'are', correct: false }
                    ]},
                    { group: 8, options: [
                        { id: '8-1', text: 'loves', correct: true },
                        { id: '8-2', text: 'love', correct: false },
                        { id: '8-3', text: 'loving', correct: false }
                    ]},
                    { group: 9, options: [
                        { id: '9-1', text: 'is', correct: true },
                        { id: '9-2', text: 'are', correct: false },
                        { id: '9-3', text: 'am', correct: false }
                    ]}
                ]
            },
            { 
                id: 2107, 
                image: '画面07.jpg', 
                text: "Arturo: Who (10) Soo-jin? She (11) familiar.", 
                buttons: [
                    { group: 10, options: [
                        { id: '10-1', text: 'is', correct: true },
                        { id: '10-2', text: 'are', correct: false },
                        { id: '10-3', text: 'am', correct: false }
                    ]},
                    { group: 11, options: [
                        { id: '11-1', text: 'looks', correct: true },
                        { id: '11-2', text: 'look', correct: false },
                        { id: '11-3', text: 'looking', correct: false }
                    ]}
                ]
            },
            { 
                id: 2108, 
                image: '画面08.jpg', 
                text: "Alexa: She (12) my classmate. We (13) in the same business class. We (14) our class every Monday and Wednesday.", 
                buttons: [
                    { group: 12, options: [
                        { id: '12-1', text: 'is', correct: false },
                        { id: '12-2', text: 'are', correct: true },
                        { id: '12-3', text: 'am', correct: false }
                    ]},
                    { group: 13, options: [
                        { id: '13-1', text: 'is', correct: false },
                        { id: '13-2', text: 'are', correct: true },
                        { id: '13-3', text: 'am', correct: false }
                    ]},
                    { group: 14, options: [
                        { id: '14-1', text: 'has', correct: false },
                        { id: '14-2', text: 'have', correct: true },
                        { id: '14-3', text: 'having', correct: false }
                    ]}
                ]
            },
            { 
                id: 2109, 
                image: '画面09.jpg', 
                text: "Arturo: Where (15) she from?", 
                buttons: [
                    { group: 15, options: [
                        { id: '15-1', text: 'is', correct: false },
                        { id: '15-2', text: 'are', correct: true },
                        { id: '15-3', text: 'am', correct: false }
                    ]}
                ]
            },
            { 
                id: 2110, 
                image: '画面10.jpg', 
                text: "Alexa: South Korea. She (16) marketing. She (17) the classes (18) very interesting. Let's go and say hello. Sorry, what (19) your last name again? Vargas?", 
                buttons: [
                    { group: 16, options: [
                        { id: '16-1', text: 'studies', correct: true },
                        { id: '16-2', text: 'study', correct: false },
                        { id: '16-3', text: 'studying', correct: false }
                    ]},
                    { group: 17, options: [
                        { id: '17-1', text: 'says', correct: true },
                        { id: '17-2', text: 'say', correct: false },
                        { id: '17-3', text: 'saying', correct: false }
                    ]},
                    { group: 18, options: [
                        { id: '18-1', text: 'is', correct: false },
                        { id: '18-2', text: 'are', correct: true },
                        { id: '18-3', text: 'am', correct: false }
                    ]},
                    { group: 19, options: [
                        { id: '19-1', text: 'is', correct: true },
                        { id: '19-2', text: 'are', correct: false },
                        { id: '19-3', text: 'am', correct: false }
                    ]}
                ]
            },
            { 
                id: 2111, 
                image: '画面11.jpg', 
                text: "Arturo: Actually, it (20) Valdez", 
                buttons: [
                    { group: 20, options: [
                        { id: '20-1', text: 'is', correct: true },
                        { id: '20-2', text: 'are', correct: false },
                        { id: '20-3', text: 'am', correct: false }
                    ]}
                ]
            },
            { 
                id: 2112, 
                image: '画面12.jpg', 
                text: "Alexa: How (21) you spell that?", 
                buttons: [
                    { group: 21, options: [
                        { id: '21-1', text: 'is', correct: false },
                        { id: '21-2', text: 'are', correct: true },
                        { id: '21-3', text: 'am', correct: false }
                    ]}
                ]
            }
        ];

        // DOM元素
        const gameContainer = document.getElementById('game-container');
        const rankingScreen = document.getElementById('ranking-screen');
        const roomIdDisplay = document.getElementById('room-id-display');
        const playerCountDisplay = document.getElementById('player-count');
        const rankingTable = document.getElementById('ranking-table');

        // 初始化游戏
        async function initGame() {
            // 获取URL参数
            const urlParams = new URLSearchParams(window.location.search);
            gameData.roomId = urlParams.get('room');
            gameData.nickname = decodeURIComponent(urlParams.get('nickname') || '');
            gameData.isTeacher = urlParams.get('teacher') === 'true';
            
            if (gameData.isTeacher) {
                // 老师直接显示排名画面
                showRankingScreen();
                startRoomMonitoring();
                return;
            }
            
            if (!gameData.roomId || !gameData.nickname) {
                alert('Invalid room or nickname. Redirecting to start page.');
                window.location.href = 'index.html';
                return;
            }
            
            // 显示房间ID
            roomIdDisplay.textContent = gameData.roomId;
            
            // 初始化玩家数据
            await initializePlayer();
            
            // 开始计时
            gameData.startTime = Date.now();
            updateElapsedTime();
            
            // 显示第一个场景
            showScene(1);
            
            // 开始房间监控
            startRoomMonitoring();
        }

        // 初始化玩家数据
        async function initializePlayer() {
            try {
                // 生成玩家ID
                gameData.playerId = generatePlayerId();
                
                // 创建玩家文档
                await db.collection('rooms').doc(gameData.roomId).collection('players').doc(gameData.playerId).set({
                    nickname: gameData.nickname,
                    score: 0,
                    accuracy: 0,
                    progress: 0,
                    elapsedTime: 0,
                    finished: false,
                    joinedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // 更新玩家计数
                await updatePlayerCount(1);
            } catch (error) {
                console.error("Error initializing player:", error);
                alert("Error initializing player. Please refresh the page.");
            }
        }

        // 生成玩家ID
        function generatePlayerId() {
            return Math.random().toString(36).substring(2) + Date.now().toString(36);
        }

        // 更新玩家计数
        async function updatePlayerCount(change) {
            try {
                const roomRef = db.collection('rooms').doc(gameData.roomId);
                await roomRef.update({
                    playerCount: firebase.firestore.FieldValue.increment(change)
                });
            } catch (error) {
                console.error("Error updating player count:", error);
            }
        }

        // 更新经过的时间
        function updateElapsedTime() {
            if (gameData.startTime && !gameData.isTeacher) {
                gameData.elapsedTime = Math.floor((Date.now() - gameData.startTime) / 1000);
                
                // 每3秒更新一次数据库
                if (gameData.elapsedTime % 3 === 0) {
                    updatePlayerData();
                }
                
                // 设置下一次更新
                setTimeout(updateElapsedTime, 1000);
            }
        }

        // 更新玩家数据到数据库
        async function updatePlayerData() {
            try {
                const accuracy = calculateAccuracy();
                const progress = calculateProgress();
                
                await db.collection('rooms').doc(gameData.roomId).collection('players').doc(gameData.playerId).update({
                    score: gameData.score,
                    accuracy: accuracy,
                    progress: progress,
                    elapsedTime: gameData.elapsedTime,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
            } catch (error) {
                console.error("Error updating player data:", error);
            }
        }

        // 计算正确率
        function calculateAccuracy() {
            const totalQuestions = 15;
            const correctAnswers = Object.values(gameData.selectedAnswers).filter(answer => answer).length;
            return totalQuestions > 0 ? (correctAnswers / totalQuestions) * 100 : 0;
        }

        // 计算进度
        function calculateProgress() {
            return Math.floor((gameData.currentPage / 12) * 100);
        }

        // 显示场景
        function showScene(sceneNumber) {
            if (sceneNumber > scenes.length) {
                // 游戏结束，显示排名
                finishGame();
                return;
            }
            
            const scene = scenes[sceneNumber - 1];
            gameData.currentPage = sceneNumber;
            
            // 创建场景HTML
            const sceneHTML = `
                <div class="scene" data-scene-id="${scene.id}">
                    <img src="images/${scene.image}" alt="Scene ${scene.id}" class="scene-image">
                    <div class="text-container">
                        <p>${scene.text}</p>
                    </div>
                    <div class="buttons-container">
                        ${scene.buttons.map(buttonGroup => `
                            <div class="button-group">
                                ${buttonGroup.options.map(option => `
                                    <button class="answer-btn" data-btn-id="${option.id}" data-correct="${option.correct}">${option.text}</button>
                                `).join('')}
                            </div>
                        `).join('')}
                    </div>
                    <button class="continue-btn">Continue</button>
                </div>
            `;
            
            // 更新游戏容器
            gameContainer.innerHTML = sceneHTML;
            
            // 添加按钮事件监听器
            const answerButtons = gameContainer.querySelectorAll('.answer-btn');
            answerButtons.forEach(button => {
                button.addEventListener('click', handleAnswerClick);
            });
            
            // 添加继续按钮事件监听器
            const continueButton = gameContainer.querySelector('.continue-btn');
            continueButton.addEventListener('click', handleContinueClick);
            
            // 预加载下一张图片
            if (sceneNumber < scenes.length) {
                preloadImage(`images/${scenes[sceneNumber].image}`);
            }
            
            // 更新玩家进度
            updatePlayerData();
        }

        // 处理答案点击
        function handleAnswerClick(event) {
            const button = event.target;
            const buttonId = button.dataset.btnId;
            const isCorrect = button.dataset.correct === 'true';
            
            // 获取按钮组
            const groupId = buttonId.split('-')[0];
            const buttonGroup = button.closest('.button-group');
            
            // 取消组内其他按钮的选中状态
            buttonGroup.querySelectorAll('.answer-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            
            // 设置当前按钮为选中状态
            button.classList.add('selected');
            
            // 存储答案选择
            gameData.selectedAnswers[groupId] = isCorrect;
        }

        // 处理继续点击
        function handleContinueClick() {
            // 计算当前页面的得分
            calculateScoreForCurrentPage();
            
            // 显示下一个场景
            showScene(gameData.currentPage + 1);
        }

        // 计算当前页面的得分
        function calculateScoreForCurrentPage() {
            const scene = scenes[gameData.currentPage - 1];
            
            scene.buttons.forEach(buttonGroup => {
                const groupId = buttonGroup.group;
                if (gameData.selectedAnswers[groupId]) {
                    gameData.score++;
                }
            });
        }

        // 完成游戏
        async function finishGame() {
            try {
                // 计算最终得分
                calculateFinalScore();
                
                // 更新玩家状态为已完成
                await db.collection('rooms').doc(gameData.roomId).collection('players').doc(gameData.playerId).update({
                    finished: true,
                    score: gameData.score,
                    accuracy: calculateAccuracy(),
                    elapsedTime: gameData.elapsedTime,
                    completedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // 显示排名画面
                showRankingScreen();
            } catch (error) {
                console.error("Error finishing game:", error);
                alert("Error finishing game. Please refresh the page.");
            }
        }

        // 计算最终得分
        function calculateFinalScore() {
            // 计算时间分数（每满一分钟2分，不满一分钟1分）
            const minutes = Math.floor(gameData.elapsedTime / 60);
            const seconds = gameData.elapsedTime % 60;
            const timeScore = minutes * 2 + (seconds > 0 ? 1 : 0);
            
            // 总分数 = 正确答案数 + 时间分数（不超过100）
            gameData.score = Math.min(gameData.score + timeScore, 100);
        }

        // 显示排名画面
        function showRankingScreen() {
            gameContainer.style.display = 'none';
            rankingScreen.style.display = 'block';
            
            // 加载排名数据
            loadRankingData();
        }

        // 开始房间监控
        function startRoomMonitoring() {
            // 监听玩家数量变化
            db.collection('rooms').doc(gameData.roomId).onSnapshot((doc) => {
                if (doc.exists) {
                    const data = doc.data();
                    playerCountDisplay.textContent = data.playerCount || 0;
                }
            });
            
            // 监听玩家数据变化
            db.collection('rooms').doc(gameData.roomId).collection('players')
                .orderBy('score', 'desc')
                .limit(10)
                .onSnapshot((snapshot) => {
                    updateRankingTable(snapshot);
                });
        }

        // 加载排名数据
        async function loadRankingData() {
            try {
                const snapshot = await db.collection('rooms').doc(gameData.roomId).collection('players')
                    .orderBy('score', 'desc')
                    .limit(10)
                    .get();
                
                updateRankingTable(snapshot);
            } catch (error) {
                console.error("Error loading ranking data:", error);
            }
        }

        // 更新排名表格
        function updateRankingTable(snapshot) {
            const tbody = rankingTable.querySelector('tbody');
            tbody.innerHTML = '';
            
            let rank = 1;
            snapshot.forEach((doc) => {
                const player = doc.data();
                const row = document.createElement('tr');
                
                // 高亮显示当前玩家
                if (doc.id === gameData.playerId) {
                    row.classList.add('highlight');
                }
                
                // 格式化时间
                const minutes = Math.floor(player.elapsedTime / 60);
                const seconds = player.elapsedTime % 60;
                const timeFormatted = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                
                row.innerHTML = `
                    <td>${rank}</td>
                    <td>${player.nickname}</td>
                    <td>${player.score || 0}</td>
                    <td>${player.accuracy ? player.accuracy.toFixed(1) + '%' : '0.0%'}</td>
                    <td>${timeFormatted}</td>
                `;
                
                tbody.appendChild(row);
                rank++;
            });
        }

        // 预加载图片
        function preloadImage(src) {
            return new Promise((resolve) => {
                const img = new Image();
                img.src = src;
                img.onload = resolve;
            });
        }

        // 初始化游戏
        document.addEventListener('DOMContentLoaded', initGame);
    </script>
</body>
</html>
