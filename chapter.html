<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ëã±ËØ≠Êó∂ÊÄÅ‰πãÊóÖ - Ê∏∏Êàè</title>
    <link rel="stylesheet" href="style.css">
    <!-- Firebase App (the core Firebase SDK) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <!-- Firebase Database -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üìö</text></svg>">
</head>
<body>
    <!-- Ê∏∏ÊàèÈ°µÈù¢ÂÆπÂô® -->
    <div id="game-container">
        <!-- ÊâÄÊúâÊ∏∏ÊàèÁîªÈù¢Â∞ÜÂä®ÊÄÅÂä†ËΩΩÂà∞ËøôÈáå -->
    </div>

    <script>
        // FirebaseÈÖçÁΩÆ
        const firebaseConfig = {
            apiKey: "AIzaSyDHRYTBU74r31MPYVAAnRMwKM76c_-BduQ",
            authDomain: "tetrisonline-ca400.firebaseapp.com",
            projectId: "tetrisonline-ca400",
            storageBucket: "tetrisonline-ca400.firebasestorage.app",
            messagingSenderId: "58207939196",
            appId: "1:58207939196:web:b34f403204096084ee37f9",
            measurementId: "G-GG7GNEQ718"
        };

        // ÂàùÂßãÂåñFirebase
        let firebaseInitialized = false;
        try {
            firebase.initializeApp(firebaseConfig);
            firebaseInitialized = true;
            console.log("Firebase initialized successfully");
        } catch (error) {
            console.error("Firebase initialization error:", error);
            alert("Failed to initialize the game. Please refresh the page and try again.");
        }

        // ÂÖ®Â±ÄÂèòÈáè
        let currentPage = 2101;
        let roomId = null;
        let playerId = null;
        let isTeacher = false;
        let selectedAnswers = {};
        let playerData = {
            correctAnswers: 0,
            startTime: Date.now(),
            progress: 0,
            finished: false
        };
        let preloadedImages = {};

        // È°µÈù¢Êï∞ÊçÆÂÆö‰πâ
        const pageData = {
            2101: {
                image: "ÁîªÈù¢01.jpg",
                text: "Arturo: Hello, I'm Arturo Valdez.",
                buttons: [],
                nextPage: 2102
            },
            2102: {
                image: "ÁîªÈù¢02.jpg",
                text: "Alexa: Hi. My name Ôºà1Ôºâ Alexandra Costa, but please Ôºà2Ôºâ me Alexa.",
                buttons: [
                    {
                        id: "1",
                        options: [
                            { text: "is", correct: true },
                            { text: "am", correct: false },
                            { text: "are", correct: false }
                        ]
                    },
                    {
                        id: "2",
                        options: [
                            { text: "calls", correct: false },
                            { text: "call", correct: true },
                            { text: "calling", correct: false }
                        ]
                    }
                ],
                nextPage: 2103
            },
            2103: {
                image: "ÁîªÈù¢03.jpg",
                text: "Arturo: OK. Where Ôºà3Ôºâ you from, Alexa?",
                buttons: [
                    {
                        id: "3",
                        options: [
                            { text: "is", correct: false },
                            { text: "are", correct: true },
                            { text: "am", correct: false }
                        ]
                    }
                ],
                nextPage: 2104
            },
            2104: {
                image: "ÁîªÈù¢04.jpg",
                text: "Alexa: Brazil. How about you?",
                buttons: [],
                nextPage: 2105
            },
            2105: {
                image: "ÁîªÈù¢05.jpg",
                text: "Arturo: I'm from Mexico. I Ôºà4Ôºâ here in the city now, but my family Ôºà5Ôºâ in a small town near Guadalajara.",
                buttons: [
                    {
                        id: "4",
                        options: [
                            { text: "lives", correct: true },
                            { text: "live", correct: false },
                            { text: "living", correct: false }
                        ]
                    },
                    {
                        id: "5",
                        options: [
                            { text: "lives", correct: true },
                            { text: "live", correct: false },
                            { text: "are living", correct: false }
                        ]
                    }
                ],
                nextPage: 2106
            },
            2106: {
                image: "ÁîªÈù¢06.jpg",
                text: "Alexa: Oh, I Ôºà6Ôºâ Mexico! It Ôºà7Ôºâ really beautiful. My brother Ôºà8Ôºâ Mexico, too. Oh, good. Soo-jin Ôºà9Ôºâ here.",
                buttons: [
                    {
                        id: "6",
                        options: [
                            { text: "loves", correct: false },
                            { text: "love", correct: true },
                            { text: "loving", correct: false }
                        ]
                    },
                    {
                        id: "7",
                        options: [
                            { text: "is", correct: true },
                            { text: "am", correct: false },
                            { text: "are", correct: false }
                        ]
                    },
                    {
                        id: "8",
                        options: [
                            { text: "loves", correct: true },
                            { text: "love", correct: false },
                            { text: "loving", correct: false }
                        ]
                    },
                    {
                        id: "9",
                        options: [
                            { text: "is", correct: true },
                            { text: "are", correct: false },
                            { text: "am", correct: false }
                        ]
                    }
                ],
                nextPage: 2107
            },
            2107: {
                image: "ÁîªÈù¢07.jpg",
                text: "Arturo: Who Ôºà10Ôºâ Soo-jin? She Ôºà11Ôºâ familiar.",
                buttons: [
                    {
                        id: "10",
                        options: [
                            { text: "is", correct: true },
                            { text: "are", correct: false },
                            { text: "am", correct: false }
                        ]
                    },
                    {
                        id: "11",
                        options: [
                            { text: "looks", correct: true },
                            { text: "look", correct: false },
                            { text: "looking", correct: false }
                        ]
                    }
                ],
                nextPage: 2108
            },
            2108: {
                image: "ÁîªÈù¢08.jpg",
                text: "Alexa: She Ôºà12Ôºâ my classmate. We Ôºà13Ôºâ in the same business class. We Ôºà14Ôºâ our class every Monday and Wednesday.",
                buttons: [
                    {
                        id: "12",
                        options: [
                            { text: "is", correct: false },
                            { text: "are", correct: true },
                            { text: "am", correct: false }
                        ]
                    },
                    {
                        id: "13",
                        options: [
                            { text: "is", correct: false },
                            { text: "are", correct: true },
                            { text: "am", correct: false }
                        ]
                    },
                    {
                        id: "14",
                        options: [
                            { text: "has", correct: false },
                            { text: "have", correct: true },
                            { text: "having", correct: false }
                        ]
                    }
                ],
                nextPage: 2109
            },
            2109: {
                image: "ÁîªÈù¢09.jpg",
                text: "Arturo: Where Ôºà15Ôºâ she from?",
                buttons: [
                    {
                        id: "15",
                        options: [
                            { text: "is", correct: false },
                            { text: "are", correct: true },
                            { text: "am", correct: false }
                        ]
                    }
                ],
                nextPage: 2110
            },
            2110: {
                image: "ÁîªÈù¢10.jpg",
                text: "Alexa: South Korea. She Ôºà16Ôºâ marketing. She Ôºà17Ôºâ the classes Ôºà18Ôºâ very interesting. Let's go and say hello. Sorry, what Ôºà19Ôºâ your last name again? Vargas?",
                buttons: [
                    {
                        id: "16",
                        options: [
                            { text: "studies", correct: true },
                            { text: "study", correct: false },
                            { text: "studying", correct: false }
                        ]
                    },
                    {
                        id: "17",
                        options: [
                            { text: "says", correct: true },
                            { text: "say", correct: false },
                            { text: "saying", correct: false }
                        ]
                    },
                    {
                        id: "18",
                        options: [
                            { text: "is", correct: false },
                            { text: "are", correct: true },
                            { text: "am", correct: false }
                        ]
                    },
                    {
                        id: "19",
                        options: [
                            { text: "is", correct: true },
                            { text: "are", correct: false },
                            { text: "am", correct: false }
                        ]
                    }
                ],
                nextPage: 2111
            },
            2111: {
                image: "ÁîªÈù¢11.jpg",
                text: "Arturo: Actually, it Ôºà20Ôºâ Valdez",
                buttons: [
                    {
                        id: "20",
                        options: [
                            { text: "is", correct: true },
                            { text: "are", correct: false },
                            { text: "am", correct: false }
                        ]
                    }
                ],
                nextPage: 2112
            },
            2112: {
                image: "ÁîªÈù¢12.jpg",
                text: "Alexa: How Ôºà21Ôºâ you spell that?",
                buttons: [
                    {
                        id: "21",
                        options: [
                            { text: "is", correct: false },
                            { text: "are", correct: true },
                            { text: "am", correct: false }
                        ]
                    }
                ],
                nextPage: 2113
            }
        };

        // ÂàùÂßãÂåñÊ∏∏Êàè
        document.addEventListener('DOMContentLoaded', function() {
            // Ëé∑ÂèñURLÂèÇÊï∞
            const urlParams = new URLSearchParams(window.location.search);
            roomId = urlParams.get('room');
            playerId = urlParams.get('player');
            isTeacher = urlParams.get('teacher') === 'true';
            
            if (!roomId) {
                alert("Invalid room. Redirecting to start page.");
                window.location.href = "index.html";
                return;
            }
            
            if (isTeacher) {
                // ËÄÅÂ∏àÁõ¥Êé•ÊòæÁ§∫ÊéíË°åÊ¶ú
                showLeaderboard();
                startLeaderboardUpdates();
            } else if (!playerId) {
                alert("Invalid player. Redirecting to start page.");
                window.location.href = "index.html";
                return;
            } else {
                // Áé©ÂÆ∂Âä†ËΩΩÊ∏∏Êàè
                loadPlayerData();
                loadPage(currentPage);
                preloadNextImage(currentPage + 1);
            }
        });

        // Âä†ËΩΩÁé©ÂÆ∂Êï∞ÊçÆ
        function loadPlayerData() {
            if (!firebaseInitialized) return;
            
            const db = firebase.database();
            const playerRef = db.ref('rooms/' + roomId + '/players/' + playerId);
            
            playerRef.once('value')
                .then((snapshot) => {
                    if (snapshot.exists()) {
                        playerData = snapshot.val();
                    }
                })
                .catch((error) => {
                    console.error("Error loading player data:", error);
                });
        }

        // Âä†ËΩΩÈ°µÈù¢
        function loadPage(pageId) {
            const page = pageData[pageId];
            if (!page) {
                if (pageId === 2113) {
                    showLeaderboard();
                    startLeaderboardUpdates();
                }
                return;
            }
            
            const gameContainer = document.getElementById('game-container');
            
            // ÂàõÂª∫È°µÈù¢ÂÖÉÁ¥†
            const pageElement = document.createElement('div');
            pageElement.className = 'page';
            pageElement.id = `page-${pageId}`;
            
            // Ê∑ªÂä†ÂõæÁâá
            const img = document.createElement('img');
            img.src = `images/${page.image}`;
            img.alt = `Page ${pageId}`;
            img.className = 'background-image fade-in';
            pageElement.appendChild(img);
            
            // Ê∑ªÂä†ÊñáÊú¨
            const textDiv = document.createElement('div');
            textDiv.className = 'text-content';
            textDiv.textContent = page.text;
            pageElement.appendChild(textDiv);
            
            // Ê∑ªÂä†ÊåâÈíÆÁªÑ
            if (page.buttons && page.buttons.length > 0) {
                const buttonsContainer = document.createElement('div');
                buttonsContainer.className = 'buttons-container';
                
                page.buttons.forEach(buttonGroup => {
                    const buttonGroupDiv = document.createElement('div');
                    buttonGroupDiv.className = 'button-group';
                    
                    buttonGroup.options.forEach(option => {
                        const button = document.createElement('button');
                        button.className = 'option-btn';
                        button.textContent = option.text;
                        button.dataset.correct = option.correct;
                        button.dataset.groupId = buttonGroup.id;
                        
                        button.addEventListener('click', function() {
                            // Â§ÑÁêÜÊåâÈíÆÈÄâÊã©
                            handleOptionSelect(buttonGroup.id, option.correct, button);
                        });
                        
                        buttonGroupDiv.appendChild(button);
                    });
                    
                    buttonsContainer.appendChild(buttonGroupDiv);
                });
                
                pageElement.appendChild(buttonsContainer);
            }
            
            // Ê∑ªÂä†ContinueÊåâÈíÆ
            const continueBtn = document.createElement('button');
            continueBtn.className = 'continue-btn';
            continueBtn.textContent = 'Continue';
            continueBtn.addEventListener('click', function() {
                // Â§ÑÁêÜÈ°µÈù¢Ë∑≥ËΩ¨
                handleContinue(pageId, page.nextPage);
            });
            pageElement.appendChild(continueBtn);
            
            // Ê∏ÖÁ©∫ÂÆπÂô®Âπ∂Ê∑ªÂä†Êñ∞È°µÈù¢
            gameContainer.innerHTML = '';
            gameContainer.appendChild(pageElement);
            
            // Êõ¥Êñ∞ÂΩìÂâçÈ°µÈù¢
            currentPage = pageId;
            
            // Êõ¥Êñ∞Áé©ÂÆ∂ËøõÂ∫¶
            updateProgress();
        }

        // Â§ÑÁêÜÈÄâÈ°πÈÄâÊã©
        function handleOptionSelect(groupId, isCorrect, button) {
            // È´ò‰∫ÆÈÄâ‰∏≠ÁöÑÊåâÈíÆ
            const group = button.parentElement;
            const buttons = group.querySelectorAll('.option-btn');
            buttons.forEach(btn => {
                btn.classList.remove('selected');
            });
            button.classList.add('selected');
            
            // ËÆ∞ÂΩïÈÄâÊã©
            selectedAnswers[groupId] = isCorrect;
        }

        // Â§ÑÁêÜContinueÊåâÈíÆÁÇπÂáª
        function handleContinue(currentPageId, nextPageId) {
            // ËÆ°ÁÆóÂΩìÂâçÈ°µÈù¢ÁöÑÂæóÂàÜ
            if (pageData[currentPageId].buttons && pageData[currentPageId].buttons.length > 0) {
                let pageScore = 0;
                
                pageData[currentPageId].buttons.forEach(buttonGroup => {
                    if (selectedAnswers[buttonGroup.id] === true) {
                        pageScore++;
                    }
                });
                
                // Êõ¥Êñ∞Áé©ÂÆ∂Êï∞ÊçÆ
                updatePlayerData(pageScore);
                
                // Ê∏ÖÁ©∫ÂΩìÂâçÈ°µÈù¢ÁöÑÈÄâÊã©
                selectedAnswers = {};
            }
            
            // Âä†ËΩΩ‰∏ã‰∏ÄÈ°µÊàñÊòæÁ§∫ÊéíË°åÊ¶ú
            if (nextPageId === 2113) {
                // Ê†áËÆ∞Ê∏∏ÊàèÂÆåÊàê
                markGameCompleted();
                showLeaderboard();
                startLeaderboardUpdates();
            } else {
                loadPage(nextPageId);
                preloadNextImage(nextPageId + 1);
            }
        }

        // Êõ¥Êñ∞Áé©ÂÆ∂Êï∞ÊçÆ
        function updatePlayerData(score) {
            if (!firebaseInitialized || !playerId) return;
            
            playerData.correctAnswers += score;
            
            const db = firebase.database();
            const playerRef = db.ref('rooms/' + roomId + '/players/' + playerId);
            
            playerRef.update({
                correctAnswers: playerData.correctAnswers
            }).catch((error) => {
                console.error("Error updating player data:", error);
            });
        }

        // Êõ¥Êñ∞ËøõÂ∫¶
        function updateProgress() {
            if (!firebaseInitialized || !playerId) return;
            
            // ËÆ°ÁÆóËøõÂ∫¶ (ÂΩìÂâçÈ°µÊï∞/12 * 100)
            const progress = Math.floor((currentPage - 2101) / 12 * 100);
            playerData.progress = progress;
            
            const db = firebase.database();
            const playerRef = db.ref('rooms/' + roomId + '/players/' + playerId);
            
            playerRef.update({
                progress: progress
            }).catch((error) => {
                console.error("Error updating progress:", error);
            });
        }

        // Ê†áËÆ∞Ê∏∏ÊàèÂÆåÊàê
        function markGameCompleted() {
            if (!firebaseInitialized || !playerId) return;
            
            const db = firebase.database();
            const playerRef = db.ref('rooms/' + roomId + '/players/' + playerId);
            
            // ËÆ°ÁÆóÊ∏∏ÊàèÁî®Êó∂ÔºàÂàÜÈíüÔºâ
            const endTime = Date.now();
            const timeSpent = Math.min(60, Math.ceil((endTime - playerData.startTime) / 60000));
            
            // ËÆ°ÁÆóÊó∂Èó¥ÂàÜÊï∞ÔºàÊØèÊª°‰∏ÄÂàÜÈíü2ÂàÜÔºå‰∏çÊª°‰∏ÄÂàÜÈíü1ÂàÜÔºâ
            const timeScore = timeSpent <= 1 ? 1 : timeSpent * 2;
            
            // ËÆ°ÁÆóÊÄªÂàÜÊï∞ÔºàN-Êó∂Èó¥ÂàÜÊï∞Ôºå‰∏çË∂ÖËøá100Ôºâ
            const totalScore = Math.min(100, playerData.correctAnswers - timeScore);
            
            // ËÆ°ÁÆóÊ≠£Á°ÆÁéá
            const accuracy = (playerData.correctAnswers / 15 * 100).toFixed(1);
            
            playerRef.update({
                finished: true,
                endTime: endTime,
                timeSpent: timeSpent,
                totalScore: totalScore,
                accuracy: accuracy,
                status: "completed"
            }).catch((error) => {
                console.error("Error marking game completed:", error);
            });
        }

        // È¢ÑÂä†ËΩΩ‰∏ã‰∏ÄÂº†ÂõæÁâá
        function preloadNextImage(nextPageId) {
            const nextPage = pageData[nextPageId];
            if (!nextPage) return;
            
            const img = new Image();
            img.src = `images/${nextPage.image}`;
            preloadedImages[nextPageId] = img;
        }

        // ÊòæÁ§∫ÊéíË°åÊ¶ú
        function showLeaderboard() {
            const gameContainer = document.getElementById('game-container');
            gameContainer.innerHTML = '';
            
            const leaderboardDiv = document.createElement('div');
            leaderboardDiv.className = 'leaderboard-page';
            leaderboardDiv.id = 'page-2113';
            
            // ÊàøÈó¥‰ø°ÊÅØ
            const roomInfoDiv = document.createElement('div');
            roomInfoDiv.className = 'room-info';
            roomInfoDiv.innerHTML = `
                <div>Room: ${roomId}</div>
                <div id="player-count">Players: 0</div>
            `;
            leaderboardDiv.appendChild(roomInfoDiv);
            
            // ÊéíË°åÊ¶ú
            const leaderboardTable = document.createElement('table');
            leaderboardTable.className = 'leaderboard-table';
            leaderboardTable.innerHTML = `
                <thead>
                    <tr>
                        <th>Rank</th>
                        <th>Name</th>
                        <th>Score</th>
                        <th>Accuracy</th>
                        <th>Time</th>
                    </tr>
                </thead>
                <tbody id="leaderboard-body">
                    <!-- ÊéíË°åÊ¶úÊï∞ÊçÆÂ∞ÜÈÄöËøáJavaScriptÂä®ÊÄÅÂ°´ÂÖÖ -->
                </tbody>
            `;
            leaderboardDiv.appendChild(leaderboardTable);
            
            gameContainer.appendChild(leaderboardDiv);
            
            // ÂàùÂßãÂä†ËΩΩÊéíË°åÊ¶úÊï∞ÊçÆ
            updateLeaderboard();
        }

        // ÂºÄÂßãÊéíË°åÊ¶úÊõ¥Êñ∞
        function startLeaderboardUpdates() {
            // ÊØè3ÁßíÊõ¥Êñ∞‰∏ÄÊ¨°ÊéíË°åÊ¶ú
            setInterval(updateLeaderboard, 3000);
        }

        // Êõ¥Êñ∞ÊéíË°åÊ¶ú
        function updateLeaderboard() {
            if (!firebaseInitialized || !roomId) return;
            
            const db = firebase.database();
            const roomRef = db.ref('rooms/' + roomId);
            
            roomRef.once('value')
                .then((snapshot) => {
                    if (snapshot.exists()) {
                        const roomData = snapshot.val();
                        const players = roomData.players || {};
                        
                        // Êõ¥Êñ∞Áé©ÂÆ∂Êï∞ÈáèÔºà‰∏çÂåÖÊã¨ËÄÅÂ∏àÔºâ
                        const playerCount = Object.keys(players).length;
                        document.getElementById('player-count').textContent = `Players: ${playerCount}`;
                        
                        // ÂáÜÂ§áÊéíË°åÊ¶úÊï∞ÊçÆ
                        const leaderboardData = [];
                        
                        for (const playerId in players) {
                            const player = players[playerId];
                            if (player.finished) {
                                leaderboardData.push({
                                    name: player.name,
                                    score: player.totalScore || 0,
                                    accuracy: player.accuracy || "0.0",
                                    time: player.timeSpent || 0,
                                    isCurrent: playerId === window.playerId
                                });
                            }
                        }
                        
                        // ÊåâÂàÜÊï∞ÊéíÂ∫è
                        leaderboardData.sort((a, b) => b.score - a.score);
                        
                        // Âè™ÊòæÁ§∫Ââç10Âêç
                        const top10 = leaderboardData.slice(0, 10);
                        
                        // Êõ¥Êñ∞ÊéíË°åÊ¶úË°®Ê†º
                        const tbody = document.getElementById('leaderboard-body');
                        tbody.innerHTML = '';
                        
                        top10.forEach((player, index) => {
                            const row = document.createElement('tr');
                            if (player.isCurrent) {
                                row.classList.add('current-player');
                            }
                            
                            row.innerHTML = `
                                <td>${index + 1}</td>
                                <td>${player.name}</td>
                                <td>${player.score}</td>
                                <td>${player.accuracy}%</td>
                                <td>${player.time}m</td>
                            `;
                            
                            tbody.appendChild(row);
                        });
                    }
                })
                .catch((error) => {
                    console.error("Error updating leaderboard:", error);
                });
        }
    </script>
</body>
</html>
