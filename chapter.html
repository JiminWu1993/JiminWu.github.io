// 游戏数据
const gameData = [
    // 画面01
    {
        id: 2101,
        image: "画面01.jpg",
        text: "Arturo: Hello, I'm Arturo Valdez.",
        buttons: [],
        continue: 2102
    },
    // 画面02
    {
        id: 2102,
        image: "画面02.jpg",
        text: "Alexa: Hi. My name (1) Alexandra Costa, but please (2) me Alexa.",
        buttons: [
            [
                { id: "1-1", text: "is", correct: true },
                { id: "1-2", text: "am", correct: false },
                { id: "1-3", text: "are", correct: false }
            ],
            [
                { id: "2-1", text: "calls", correct: false },
                { id: "2-2", text: "call", correct: true },
                { id: "2-3", text: "calling", correct: false }
            ]
        ],
        continue: 2103
    },
    // 画面03
    {
        id: 2103,
        image: "画面03.jpg",
        text: "Arturo: OK. Where (3) you from, Alexa?",
        buttons: [
            [
                { id: "1-1", text: "is", correct: false },
                { id: "1-2", text: "are", correct: true },
                { id: "1-3", text: "am", correct: false }
            ]
        ],
        continue: 2104
    },
    // 画面04
    {
        id: 2104,
        image: "画面04.jpg",
        text: "Alexa: Brazil. How about you?",
        buttons: [],
        continue: 2105
    },
    // 画面05
    {
        id: 2105,
        image: "画面05.jpg",
        text: "Arturo: I'm from Mexico. I (4) here in the city now, but my family (5) in a small town near Guadalajara.",
        buttons: [
            [
                { id: "1-1", text: "lives", correct: true },
                { id: "1-2", text: "live", correct: false },
                { id: "1-3", text: "living", correct: false }
            ],
            [
                { id: "2-1", text: "lives", correct: true },
                { id: "2-2", text: "live", correct: false },
                { id: "2-3", text: "are living", correct: false }
            ]
        ],
        continue: 2106
    },
    // 画面06
    {
        id: 2106,
        image: "画面06.jpg",
        text: "Alexa: Oh, I (6) Mexico! It (7) really beautiful. My brother (8) Mexico, too. Oh, good. Soo-jin (9) here.",
        buttons: [
            [
                { id: "1-1", text: "loves", correct: false },
                { id: "1-2", text: "love", correct: true },
                { id: "1-3", text: "loving", correct: false }
            ],
            [
                { id: "2-1", text: "is", correct: true },
                { id: "2-2", text: "am", correct: false },
                { id: "2-3", text: "are", correct: false }
            ],
            [
                { id: "3-1", text: "loves", correct: true },
                { id: "3-2", text: "love", correct: false },
                { id: "3-3", text: "loving", correct: false }
            ],
            [
                { id: "4-1", text: "is", correct: true },
                { id: "4-2", text: "are", correct: false },
                { id: "4-3", text: "am", correct: false }
            ]
        ],
        continue: 2107
    },
    // 画面07
    {
        id: 2107,
        image: "画面07.jpg",
        text: "Arturo: Who (10) Soo-jin? She (11) familiar.",
        buttons: [
            [
                { id: "1-1", text: "is", correct: true },
                { id: "1-2", text: "are", correct: false },
                { id: "1-3", text: "am", correct: false }
            ],
            [
                { id: "2-1", text: "looks", correct: true },
                { id: "2-2", text: "look", correct: false },
                { id: "2-3", text: "looking", correct: false }
            ]
        ],
        continue: 2108
    },
    // 画面08
    {
        id: 2108,
        image: "画面08.jpg",
        text: "Alexa: She (12) my classmate. We (13) in the same business class. We (14) our class every Monday and Wednesday.",
        buttons: [
            [
                { id: "1-1", text: "is", correct: false },
                { id: "1-2", text: "are", correct: true },
                { id: "1-3", text: "am", correct: false }
            ],
            [
                { id: "2-1", text: "is", correct: false },
                { id: "2-2", text: "are", correct: true },
                { id: "2-3", text: "am", correct: false }
            ],
            [
                { id: "3-1", text: "has", correct: false },
                { id: "3-2", text: "have", correct: true },
                { id: "3-3", text: "having", correct: false }
            ]
        ],
        continue: 2109
    },
    // 画面09
    {
        id: 2109,
        image: "画面09.jpg",
        text: "Arturo: Where (15) she from?",
        buttons: [
            [
                { id: "1-1", text: "is", correct: false },
                { id: "1-2", text: "are", correct: true },
                { id: "1-3", text: "am", correct: false }
            ]
        ],
        continue: 2110
    },
    // 画面10
    {
        id: 2110,
        image: "画面10.jpg",
        text: "Alexa: South Korea. She (16) marketing. She (17) the classes (18) very interesting. Let's go and say hello. Sorry, what (19) your last name again? Vargas?",
        buttons: [
            [
                { id: "1-1", text: "studies", correct: true },
                { id: "1-2", text: "study", correct: false },
                { id: "1-3", text: "studying", correct: false }
            ],
            [
                { id: "2-1", text: "says", correct: true },
                { id: "2-2", text: "say", correct: false },
                { id: "2-3", text: "saying", correct: false }
            ],
            [
                { id: "3-1", text: "is", correct: false },
                { id: "3-2", text: "are", correct: true },
                { id: "3-3", text: "am", extreme: false }
            ],
            [
                { id: "4-1", extreme: "is", correct: true },
                { id: "4-2", text: "are", correct: false },
                { id: "4-3", text: "am", correct: false }
            ]
        ],
        continue: 2111
    },
    // 画面11
    {
        id: 2111,
        image: "画面11.jpg",
        text: "Arturo: Actually, it (20) Valdez",
        buttons: [
            [
                { id: "1-1", text: "is", correct: true },
                { id: "极简-2", text: "are", correct: false },
                { id: "1-3", text: "am", correct: false }
            ]
        ],
        continue: 2112
    },
    // 画面12
    {
        id: 2112,
        image: "画面12.jpg",
        text: "Alexa: How (21) you spell that?",
        buttons: [
            [
                { id: "1-1", text: "is", correct: false },
                { id: "1-2", text极简 "are", correct: true },
                { id: "1-3", text: "am", correct: false }
            ]
        ],
        continue: 2113
    },
    // 画面13 (计分开始)
    {
        id: 2113,
        image: "画面13.jpg",
        text: "My name's Nick. My girlfriend's name (1) Karen. We (2) students. I (3) to university in Oxford.",
        buttons: [
            [
                { id: "1-1", text: "is", correct: true },
                { id: "1-2", text: "are", correct: false },
                { id: "1-3", text: "am", correct: false }
            ],
            [
                { id: "2-1", text: "is", correct: false },
                { id: "2-2", text: "are", correct: true },
                { id: "2-3", text: "am", correct: false }
            ],
            [
                { id: "3-1", text: "go", correct: true },
                { id: "3-2", text: "goes", correct: false },
                { id: "3-3", text: "going", correct: false }
            ]
        ],
        continue: 2114
    },
    // 画面14 (计分)
    {
        id: 2114,
        image: "画面14.jpg",
        text: "Karen (4) go to university in Oxford; she (5) to university in Cambridge. She (6) in Cambridge.",
        buttons: [
            [
                { id: "1-1", text: "don't", correct: false },
                { id: "1-2", text: "isn't", correct: false },
                { id: "1-3", text: "doesn't", correct: true }
            ],
            [
                { id: "2-极简", text: "go", correct: false },
                { id: "2-2", text: "goes", correct: true },
                { id: "2-3", text: "going", correct: false }
            ],
            [
                { id: "3-1", text: "lives", correct: true },
                { id: "3-2", text: "live", correct: false },
                { id: "3-3", text: "living", correct: false }
            ]
        ],
        continue: 2115
    },
    // 画面15 (计分)
    {
        id: 2115,
        image: "画面15.jpg",
        text: "I (7) with my parents in Woodstock, which (8) a small town near Oxford.",
        buttons: [
            [
                { id: "1-1", text: "lives", correct: false },
                { id: "1-2", text: "live", correct: true },
                { id: "1-3", text: "living", correct: false }
            ],
            [
                { id: "2-1", text: "is", correct: true },
                { id: "2-2", text: "are", correct: false },
                { id: "2-3", text: "am", correct: false }
极简           ]
        ],
        continue: 2116
    },
    // 画面16 (计分)
    {
        id: 2116,
        image: "画面16.jpg",
        text: "It (9) difficult sometimes because we (10) each other only on weekends.",
        buttons: [
            [
                { id: "1-1", text: "is", correct: true },
                { id: "1-2", text: "are", correct: false },
                { id: "1-3", text: "am", correct: false }
            ],
            [
                { id: "2-1", text: "see", correct: true },
                { id: "2-2", text: "sees", correct: false },
                { id: "2-3", text: "seeing", correct: false }
            ]
        ],
        continue: 2117
    },
    // 画面17 (计分)
    {
        id: 2117,
        image: "画面17.jpg",
        text: "Karen (11) history, and she (12) her course. She (13) the architecture in Cambridge (14) beautiful.",
        buttons: [
            [
                { id: "1-1", text: "studies", correct: true },
                { id: "1-2", text: "study", correct: false },
                { id: "1-3", text: "studying", correct: false }
            ],
            [
                { id: "2-1", text: "love", correct: false },
                { id: "2-2", text: "loves", correct: true },
                { id: "2-3", text: "loving", correct: false }
            ],
            [
                { id: "3-1", text: "says", correct: true },
                { id: "3-2", text: "say", correct: false },
                { id: "3-3", text: "saying", correct: false }
            ],
            [
                { id: "4-1", text: "is", correct: true },
                { id: "4-2", text: "are", correct: false },
                { id: "4-3", text: "am", correct: false }
            ]
        ],
        continue: 2118
    },
    // 画面18 (计分)
    {
        id: 2118,
        image: "画面18.jpg",
        text: "I (15) philosophy and politics, so my courses (16) very different from hers.",
        buttons: [
            [
                { id: "1-1", text: "studies", correct: false },
                { id: "1-2", text: "study", correct: true },
                { id: "1-3", text: "studying", correct: false }
            ],
            [
                { id: "2-1", text: "极简", correct: false },
                { id: "2-2", text: "are", correct: true },
                { id: "2-3", text: "am", correct: false }
            ]
        ],
        continue: 2119
    },
    // 画面19 (计分)
    {
        id: 2119,
        image: "画面19.jpg",
        text: "I (17) living in Woodstock because my family (18) there and it (19) quiet, but I (20) Karen a lot.",
        buttons: [
            [
                { id: "1-1", text: "like", correct: true },
                { id: "1-2", text: "likes", correct: false },
                { id: "1-3", text: "liking", correct: false }
            ],
            [
                { id: "2-1", text: "is", correct: true },
                { id: "2-2", text: "are", correct: false },
                { id: "2-3", text极简 "am", correct: false }
            ],
            [
                { id: "3-1", text: "is", correct: true },
                { id: "3-2", text: "are", correct: false },
                { id: "3-3", text: "am", correct: false }
            ],
            [
                { id: "4-1", text: "miss", correct: true },
                { id: "4-2", text: "misses", correct: false },
                { id: "4-3", text: "missing", correct: false }
            ]
        ],
        continue: 2120
    },
    // 画面20 (计分)
    {
        id: 2120,
        image: "画面20.jpg",
        text: "We (21) on the phone every night and we (22) each other whenever we can.",
        buttons: [
            [
                { id: "1-1", text: "talk", correct: true },
                { id: "1-2", text: "talks", correct: false },
                { id: "1-3", text: "talking", correct: false }
            ],
            [
                { id: "2-1", text: "visit", correct: true },
                { id: "2-2", text: "visits", correct: false },
                { id: "2-3", text: "visiting", correct: false }
            ]
        ],
        continue: 2121
    },
    // 画面21 (得分画面)
    {
        id: 2121,
        image: "", // 根据得分动态决定
        text: "",
        buttons: [],
        continue: null
    }
];

// 游戏状态管理
let currentScreen = 0;
let score = 0;
let selectedAnswers = {};
let preloadedImages = [];

// DOM加载完成后初始化游戏
document.addEventListener('DOMContentLoaded', function() {
    // 初始化开始屏幕
    document.getElementById('start-btn').addEventListener('click', startGame);
    
    // 预加载第一张图片
    preloadImage(gameData[0].image);
});

// 开始游戏
function startGame() {
    currentScreen = 0;
    score = 0;
    selectedAnswers = {};
    
    // 隐藏开始屏幕
    document.getElementById('start-screen').style.display = 'none';
    
    // 显示第一个游戏画面
    showScreen(currentScreen);
}

// 显示指定屏幕
function showScreen(screenIndex) {
    const screenData = gameData[screenIndex];
    const gameContainer = document.getElementById('game-container');
    
    // 清空游戏容器
    gameContainer.innerHTML = '';
    
    // 创建屏幕元素
    const screen = document.createElement('div');
    screen.className = 'screen';
    screen.id = `screen-${screenData.id}`;
    
    // 添加图片
    const imgContainer = document.createElement('div');
    imgContainer.className = 'image-container';
    
    const img = document.createElement('img');
    img.src = `images/${screenData.image}`;
    img.alt = `Scene ${screenData.id}`;
    img.className = 'scene-image';
    
    // 添加淡入效果
    img.style.opacity = 0;
    setTimeout(() => {
        img.style.opacity = 1;
    }, 50);
    
    imgContainer.appendChild(img);
    screen.appendChild(imgContainer);
    
    // 添加文本
    const textContainer = document.createElement('div');
    textContainer.className = 'text-container';
    textContainer.textContent = screenData.text;
    screen.appendChild(textContainer);
    
    // 添加按钮区域
    const buttonsContainer = document.createElement('div');
    buttonsContainer.className = 'buttons-container';
    
    // 添加选项按钮（如果有）
    if (screenData.buttons && screenData.buttons.length > 0) {
        screenData.buttons.forEach((buttonRow, rowIndex) => {
            const rowDiv = document.createElement('div');
            rowDiv.className = 'button-row';
            
            buttonRow.forEach((buttonData, colIndex) => {
                const button = document.createElement('button');
                button.className = 'option-btn';
                button.id = buttonData.id;
                button.textContent = buttonData.text;
                
                // 检查是否已选择此按钮
                if (selectedAnswers[`${screenData.id}-${rowIndex}`] === buttonData.id) {
                    button.classList.add('selected');
                }
                
                button.addEventListener('click', function() {
                    // 处理按钮选择
                    handleOptionSelect(screenData.id, rowIndex, buttonData.id, buttonData.correct);
                    
                    // 高亮当前选择，暗淡同行其他按钮
                    const allButtonsInRow = rowDiv.querySelectorAll('.option-btn');
                    allButtonsInRow.forEach(btn => {
                        btn.classList.remove('selected');
                    });
                    this.classList.add('selected');
                });
                
                rowDiv.appendChild(button);
            });
            
            buttonsContainer.appendChild(rowDiv);
        });
    }
    
    screen.appendChild(buttonsContainer);
    
    // 添加Continue按钮
    if (screenData.continue !== null) {
        const continueBtn = document.createElement('button');
        continueBtn.className = 'continue-btn';
        continueBtn.textContent = 'Continue';
        continueBtn.addEventListener('click', function() {
            // 处理计分（从第22组按钮开始计分）
            if (screenData.id >= 2113) {
                calculateScore(screenData.id);
            }
            
            // 预加载下一张图片
            const nextScreenIndex = screenIndex + 1;
            if (nextScreenIndex < gameData.length) {
                preloadImage(gameData[nextScreenIndex].image);
            }
            
            // 跳转到下一屏幕
            currentScreen = nextScreenIndex;
            showScreen(currentScreen);
        });
        
        screen.appendChild(continueBtn);
    }
    
    // 将屏幕添加到游戏容器
    gameContainer.appendChild(screen);
}

// 处理选项选择
function handleOptionSelect(screenId, rowIndex, buttonId, isCorrect) {
    // 存储选择的答案
    selectedAnswers[`${screenId}-${rowIndex}`] = buttonId;
    
    // 如果是计分屏幕（从2113开始），存储正确答案信息
    if (screenId >= 2113) {
        selectedAnswers[`${screenId}-${rowIndex}-correct`] = isCorrect;
    }
}

// 计算得分
function calculateScore(screenId) {
    // 计算当前屏幕的得分
    const screenData = gameData.find(screen => screen.id === screenId);
    
    if (screenData.buttons && screenData.buttons.length > 0) {
        screenData.buttons.forEach((buttonRow, rowIndex) => {
            const buttonId = selectedAnswers[`${screenId}-${rowIndex}`];
            const isCorrect = selectedAnswers[`${screenId}-${rowIndex}-correct`];
            
            if (isCorrect) {
                score += 1;
            }
        });
    }
    
    // 如果是最后一个计分屏幕，显示最终得分
    if (screenId === 2120) {
        showScoreScreen();
    }
}

// 显示得分屏幕
function showScoreScreen() {
    const gameContainer = document.getElementById('game-container');
    gameContainer.innerHTML = '';
    
    const screen = document.createElement('div');
    screen.className = 'screen';
    screen.id = 'score-screen';
    
    // 计算最终得分（满分22分，转换为100分制）
    const finalScore = Math.floor(score * (100 / 22));
    
    // 添加图片
    const imgContainer = document.createElement('div');
    imgContainer.className = 'image-container';
    
    const img = document.createElement('img');
    img.src = `images/${finalScore >= 60 ? '及格.jpg' : '不及格.jpg'}`;
    img.alt = finalScore >= 60 ? 'Pass' : 'Fail';
    img.className = 'scene-image';
    
    imgContainer.appendChild(img);
    screen.appendChild(imgContainer);
    
    // 添加得分文本
    const scoreText = document.createElement('div');
    scoreText.className = 'score-text';
    scoreText.textContent = `得分: ${finalScore}`;
    screen.appendChild(scoreText);
    
    // 添加重新开始按钮
    const restartBtn = document.createElement('button');
    restartBtn.className = 'continue-btn';
    restartBtn.textContent = '再玩一次';
    restartBtn.addEventListener('click', function() {
        startGame();
    });
    
    screen.appendChild(restartBtn);
    
    gameContainer.appendChild(screen);
}

// 预加载图片
function preloadImage(imageName) {
    // 检查是否已预加载
    if (!imageName || preloadedImages.includes(imageName)) return;
    
    const img = new Image();
    img.src = `images/${imageName}`;
    preloadedImages.push(imageName);
}
