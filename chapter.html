<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>英语时态之旅 - 游戏</title>
    <link rel="stylesheet" href="style.css">
    <!-- Firebase App (核心SDK) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <!-- Firebase Database -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
</head>
<body>
    <!-- 游戏页面容器 -->
    <div id="pages-container">
        <!-- 所有游戏页面将通过JavaScript动态生成 -->
    </div>

    <!-- 排名页面 -->
    <div id="page-2113" class="page">
        <div class="ranking-header">
            <div class="room-info">
                <span>房间号: <span id="room-number-display"></span></span>
                <span>玩家人数: <span id="player-count">0</span></span>
            </div>
        </div>
        <div class="ranking-table-container">
            <table class="ranking-table">
                <thead>
                    <tr>
                        <th>排名</th>
                        <th>名称</th>
                        <th>总分数</th>
                        <th>正确率</th>
                        <th>用时</th>
                    </tr>
                </thead>
                <tbody id="ranking-body">
                    <!-- 排名数据将通过JavaScript动态生成 -->
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // Firebase配置
        const firebaseConfig = {
            apiKey: "AIzaSyDHRYTBU74r31MPYVAAnRMwKM76c_-BduQ",
            authDomain: "tetrisonline-ca400.firebaseapp.com",
            projectId: "tetrisonline-ca400",
            storageBucket: "tetrisonline-ca400.firebasestorage.app",
            messagingSenderId: "58207939196",
            appId: "1:58207939196:web:b34f403204096084ee37f9",
            measurementId: "G-GG7GNEQ718"
        };

        // 初始化Firebase
        let firebaseInitialized = false;
        try {
            firebase.initializeApp(firebaseConfig);
            firebaseInitialized = true;
            console.log("Firebase initialized successfully");
        } catch (error) {
            console.error("Firebase initialization error:", error);
            alert("Failed to initialize Firebase. Please check your connection and refresh the page.");
        }

        // 全局变量
        let roomNumber = '';
        let playerId = '';
        let isTeacher = false;
        let currentPage = 2101;
        let selectedAnswers = {};
        let startTime = 0;
        let playerDataRef = null;
        let playerData = {
            progress: 0,
            score: 0,
            correctAnswers: 0,
            finished: false,
            totalTime: 0
        };

        // 页面数据
        const pagesData = {
            2101: {
                image: "画面01.jpg",
                text: "Arturo: Hello, I'm Arturo Valdez.",
                buttons: [],
                nextPage: 2102
            },
            2102: {
                image: "画面02.jpg",
                text: "Alexa: Hi. My name (1) Alexandra Costa, but please (2) me Alexa.",
                buttons: [
                    {
                        group: 1,
                        options: [
                            { id: "1-1", text: "is", correct: true },
                            { id: "1-2", text: "am", correct: false },
                            { id: "1-3", text: "are", correct: false }
                        ]
                    },
                    {
                        group: 2,
                        options: [
                            { id: "2-1", text: "calls", correct: false },
                            { id: "2-2", text: "call", correct: true },
                            { id: "2-3", text: "calling", correct: false }
                        ]
                    }
                ],
                nextPage: 2103
            },
            2103: {
                image: "画面03.jpg",
                text: "Arturo: OK. Where (3) you from, Alexa?",
                buttons: [
                    {
                        group: 3,
                        options: [
                            { id: "3-1", text: "is", correct: false },
                            { id: "3-2", text: "are", correct: true },
                            { id: "3-3", text: "am", correct: false }
                        ]
                    }
                ],
                nextPage: 2104
            },
            2104: {
                image: "画面04.jpg",
                text: "Alexa: Brazil. How about you?",
                buttons: [],
                nextPage: 2105
            },
            2105: {
                image: "画面05.jpg",
                text: "Arturo: I'm from Mexico. I (4) here in the city now, but my family (5) in a small town near Guadalajara.",
                buttons: [
                    {
                        group: 4,
                        options: [
                            { id: "4-1", text: "lives", correct: true },
                            { id: "4-2", text: "live", correct: false },
                            { id: "4-3", text: "living", correct: false }
                        ]
                    },
                    {
                        group: 5,
                        options: [
                            { id: "5-1", text: "lives", correct: true },
                            { id: "5-2", text: "live", correct: false },
                            { id: "5-3", text: "are living", correct: false }
                        ]
                    }
                ],
                nextPage: 2106
            },
            2106: {
                image: "画面06.jpg",
                text: "Alexa: Oh, I (6) Mexico! It (7) really beautiful. My brother (8) Mexico, too. Oh, good. Soo-jin (9) here.",
                buttons: [
                    {
                        group: 6,
                        options: [
                            { id: "6-1", text: "loves", correct: false },
                            { id: "6-2", text: "love", correct: true },
                            { id: "6-3", text: "loving", correct: false }
                        ]
                    },
                    {
                        group: 7,
                        options: [
                            { id: "7-1", text: "is", correct: true },
                            { id: "7-2", text: "am", correct: false },
                            { id: "7-3", text: "are", correct: false }
                        ]
                    },
                    {
                        group: 8,
                        options: [
                            { id: "8-1", text: "loves", correct: true },
                            { id: "8-2", text: "love", correct: false },
                            { id: "8-3", text: "loving", correct: false }
                        ]
                    },
                    {
                        group: 9,
                        options: [
                            { id: "9-1", text: "is", correct: true },
                            { id: "9-2", text: "are", correct: false },
                            { id: "9-3", text: "am", correct: false }
                        ]
                    }
                ],
                nextPage: 2107
            },
            2107: {
                image: "画面07.jpg",
                text: "Arturo: Who (10) Soo-jin? She (11) familiar.",
                buttons: [
                    {
                        group: 10,
                        options: [
                            { id: "10-1", text: "is", correct: true },
                            { id: "10-2", text: "are", correct: false },
                            { id: "10-3", text: "am", correct: false }
                        ]
                    },
                    {
                        group: 11,
                        options: [
                            { id: "11-1", text: "looks", correct: true },
                            { id: "11-2", text: "look", correct: false },
                            { id: "11-3", text: "looking", correct: false }
                        ]
                    }
                ],
                nextPage: 2108
            },
            2108: {
                image: "画面08.jpg",
                text: "Alexa: She (12) my classmate. We (13) in the same business class. We (14) our class every Monday and Wednesday.",
                buttons: [
                    {
                        group: 12,
                        options: [
                            { id: "12-1", text: "is", correct: false },
                            { id: "12-2", text: "are", correct: true },
                            { id: "12-3", text: "am", correct: false }
                        ]
                    },
                    {
                        group: 13,
                        options: [
                            { id: "13-1", text: "is", correct: false },
                            { id: "13-2", text: "are", correct: true },
                            { id: "13-3", text: "am", correct: false }
                        ]
                    },
                    {
                        group: 14,
                        options: [
                            { id: "14-1", text: "has", correct: false },
                            { id: "14-2", text: "have", correct: true },
                            { id: "14-3", text: "having", correct: false }
                        ]
                    }
                ],
                nextPage: 2109
            },
            2109: {
                image: "画面09.jpg",
                text: "Arturo: Where (15) she from?",
                buttons: [
                    {
                        group: 15,
                        options: [
                            { id: "15-1", text: "is", correct: false },
                            { id: "15-2", text: "are", correct: true },
                            { id: "15-3", text: "am", correct: false }
                        ]
                    }
                ],
                nextPage: 2110
            },
            2110: {
                image: "画面10.jpg",
                text: "Alexa: South Korea. She (16) marketing. She (17) the classes (18) very interesting. Let's go and say hello. Sorry, what (19) your last name again? Vargas?",
                buttons: [
                    {
                        group: 16,
                        options: [
                            { id: "16-1", text: "studies", correct: true },
                            { id: "16-2", text: "study", correct: false },
                            { id: "16-3", text: "studying", correct: false }
                        ]
                    },
                    {
                        group: 17,
                        options: [
                            { id: "17-1", text: "says", correct: true },
                            { id: "17-2", text: "say", correct: false },
                            { id: "17-3", text: "saying", correct: false }
                        ]
                    },
                    {
                        group: 18,
                        options: [
                            { id: "18-1", text: "is", correct: false },
                            { id: "18-2", text: "are", correct: true },
                            { id: "18-3", text: "am", correct: false }
                        ]
                    },
                    {
                        group: 19,
                        options: [
                            { id: "19-1", text: "is", correct: true },
                            { id: "19-2", text: "are", correct: false },
                            { id: "19-3", text: "am", correct: false }
                        ]
                    }
                ],
                nextPage: 2111
            },
            2111: {
                image: "画面11.jpg",
                text: "Arturo: Actually, it (20) Valdez",
                buttons: [
                    {
                        group: 20,
                        options: [
                            { id: "20-1", text: "is", correct: true },
                            { id: "20-2", text: "are", correct: false },
                            { id: "20-3", text: "am", correct: false }
                        ]
                    }
                ],
                nextPage: 2112
            },
            2112: {
                image: "画面12.jpg",
                text: "Alexa: How (21) you spell that?",
                buttons: [
                    {
                        group: 21,
                        options: [
                            { id: "21-1", text: "is", correct: false },
                            { id: "21-2", text: "are", correct: true },
                            { id: "21-3", text: "am", correct: false }
                        ]
                    }
                ],
                nextPage: 2113
            }
        };

        // 初始化游戏
        document.addEventListener('DOMContentLoaded', function() {
            // 获取URL参数
            const urlParams = new URLSearchParams(window.location.search);
            roomNumber = urlParams.get('room');
            playerId = urlParams.get('player');
            isTeacher = urlParams.get('teacher') === 'true';
            
            if (!roomNumber) {
                alert('Room number missing. Redirecting to home.');
                window.location.href = 'index.html';
                return;
            }
            
            // 初始化页面
            initializeGame();
            
            // 如果是老师，直接显示排名页面
            if (isTeacher) {
                showRankingPage();
                startRankingUpdates();
                return;
            }
            
            if (!playerId) {
                alert('Player ID missing. Redirecting to home.');
                window.location.href = 'index.html';
                return;
            }
            
            // 初始化玩家数据和Firebase监听
            initializePlayerData();
            
            // 显示第一页
            showPage(2101);
            
            // 开始计时
            startTime = Date.now();
        });

        // 初始化游戏页面
        function initializeGame() {
            const pagesContainer = document.getElementById('pages-container');
            
            // 为每个页面创建HTML
            for (const pageId in pagesData) {
                if (pagesData.hasOwnProperty(pageId)) {
                    const pageData = pagesData[pageId];
                    const pageDiv = document.createElement('div');
                    pageDiv.id = `page-${pageId}`;
                    pageDiv.className = 'page';
                    
                    // 添加背景图片
                    const img = document.createElement('img');
                    img.src = `images/${pageData.image}`;
                    img.alt = `Page ${pageId}`;
                    img.className = 'background-image';
                    pageDiv.appendChild(img);
                    
                    // 添加文本容器
                    const textContainer = document.createElement('div');
                    textContainer.className = 'text-container';
                    textContainer.innerHTML = `<p>${pageData.text}</p>`;
                    pageDiv.appendChild(textContainer);
                    
                    // 添加按钮容器
                    if (pageData.buttons && pageData.buttons.length > 0) {
                        const buttonsContainer = document.createElement('div');
                        buttonsContainer.className = 'buttons-container';
                        
                        pageData.buttons.forEach(buttonGroup => {
                            const groupContainer = document.createElement('div');
                            groupContainer.className = 'button-group';
                            
                            buttonGroup.options.forEach(option => {
                                const button = document.createElement('button');
                                button.id = option.id;
                                button.className = 'option-btn';
                                button.textContent = option.text;
                                button.dataset.correct = option.correct;
                                button.dataset.group = buttonGroup.group;
                                
                                button.addEventListener('click', function() {
                                    handleOptionClick(this);
                                });
                                
                                groupContainer.appendChild(button);
                            });
                            
                            buttonsContainer.appendChild(groupContainer);
                        });
                        
                        pageDiv.appendChild(buttonsContainer);
                    }
                    
                    // 添加Continue按钮
                    const continueBtn = document.createElement('button');
                    continueBtn.id = `continue-${pageId}`;
                    continueBtn.className = 'continue-btn';
                    continueBtn.textContent = 'Continue';
                    continueBtn.addEventListener('click', function() {
                        handleContinueClick(pageId);
                    });
                    pageDiv.appendChild(continueBtn);
                    
                    pagesContainer.appendChild(pageDiv);
                }
            }
        }

        // 处理选项按钮点击
        function handleOptionClick(button) {
            const group = button.dataset.group;
            const buttonsInGroup = document.querySelectorAll(`.option-btn[data-group="${group}"]`);
            
            // 取消同组中所有按钮的选中状态
            buttonsInGroup.forEach(btn => {
                btn.classList.remove('selected');
            });
            
            // 设置当前按钮为选中状态
            button.classList.add('selected');
            
            // 保存选择的答案
            selectedAnswers[group] = {
                id: button.id,
                correct: button.dataset.correct === 'true'
            };
        }

        // 处理Continue按钮点击
        function handleContinueClick(pageId) {
            const pageData = pagesData[pageId];
            const currentPageNum = parseInt(pageId);
            
            // 检查是否有按钮组需要评分
            if (pageData.buttons && pageData.buttons.length > 0) {
                let allAnswered = true;
                
                // 检查是否所有组都已选择
                pageData.buttons.forEach(group => {
                    if (!selectedAnswers[group.group]) {
                        allAnswered = false;
                    }
                });
                
                if (!allAnswered) {
                    alert('Please answer all questions before continuing.');
                    return;
                }
                
                // 计算得分
                let correctCount = 0;
                pageData.buttons.forEach(group => {
                    if (selectedAnswers[group.group].correct) {
                        correctCount++;
                    }
                });
                
                // 更新玩家数据
                playerData.correctAnswers += correctCount;
                playerData.score += correctCount;
                
                // 保存到Firebase
                updatePlayerData();
            }
            
            // 更新进度
            const progress = Math.round((currentPageNum - 2100) / 12 * 100);
            playerData.progress = progress;
            updatePlayerData();
            
            // 如果是最后一页，结束游戏
            if (currentPageNum === 2112) {
                finishGame();
                return;
            }
            
            // 显示下一页
            showPage(pageData.nextPage);
            
            // 预加载下一张图片
            if (pagesData[pageData.nextPage]) {
                preloadImage(`images/${pagesData[pageData.nextPage].image}`);
            }
        }

        // 显示指定页面
        function showPage(pageId) {
            // 隐藏所有页面
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            
            // 显示指定页面
            const pageToShow = document.getElementById(`page-${pageId}`);
            if (pageToShow) {
                pageToShow.classList.add('active');
                currentPage = pageId;
            }
        }

        // 显示排名页面
        function showRankingPage() {
            // 隐藏所有游戏页面
            document.querySelectorAll('#pages-container .page').forEach(page => {
                page.classList.remove('active');
            });
            
            // 显示排名页面
            document.getElementById('page-2113').classList.add('active');
            document.getElementById('room-number-display').textContent = roomNumber;
            
            // 开始排名更新
            startRankingUpdates();
        }

        // 完成游戏
        function finishGame() {
            // 计算总时间（分钟）
            const endTime = Date.now();
            const totalTimeMs = endTime - startTime;
            const totalTimeMinutes = Math.max(0, Math.min(60, totalTimeMs / 1000 / 60)); // 限制在0-60分钟
            
            // 计算时间分数（每满一分钟2分，不满一分钟1分）
            const fullMinutes = Math.floor(totalTimeMinutes);
            const timeScore = fullMinutes * 2 + (totalTimeMinutes > fullMinutes ? 1 : 0);
            
            // 计算总分数（N-时间分数，不超过100）
            const totalScore = Math.min(100, playerData.score - timeScore);
            
            // 计算正确率
            const accuracy = (playerData.correctAnswers / 15 * 100).toFixed(1);
            
            // 更新玩家数据
            playerData.finished = true;
            playerData.totalTime = totalTimeMinutes;
            playerData.finalScore = totalScore;
            playerData.accuracy = accuracy;
            playerData.progress = 100;
            
            // 保存到Firebase
            updatePlayerData()
                .then(() => {
                    // 显示排名页面
                    showRankingPage();
                })
                .catch(error => {
                    console.error('Error updating player data:', error);
                    alert('Error saving game results. Please try again.');
                });
        }

        // 初始化玩家数据
        function initializePlayerData() {
            if (!firebaseInitialized) return;
            
            const db = firebase.database();
            playerDataRef = db.ref('rooms/' + roomNumber + '/players/' + playerId);
            
            // 监听玩家数据变化
            playerDataRef.on('value', (snapshot) => {
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    playerData = { ...playerData, ...data };
                }
            });
            
            // 设置初始玩家数据
            playerDataRef.update({
                joinTime: startTime,
                status: 'playing',
                progress: 0,
                score: 0,
                correctAnswers: 0,
                finished: false
            });
        }

        // 更新玩家数据
        function updatePlayerData() {
            if (!firebaseInitialized || !playerDataRef) {
                return Promise.reject('Firebase not initialized');
            }
            
            return playerDataRef.update(playerData);
        }

        // 开始排名更新
        function startRankingUpdates() {
            if (!firebaseInitialized) return;
            
            const db = firebase.database();
            const roomRef = db.ref('rooms/' + roomNumber);
            
            // 监听房间数据变化
            roomRef.on('value', (snapshot) => {
                if (snapshot.exists()) {
                    const roomData = snapshot.val();
                    updateRankingDisplay(roomData);
                }
            });
        }

        // 更新排名显示
        function updateRankingDisplay(roomData) {
            // 更新玩家人数
            const playerCount = roomData.players ? Object.keys(roomData.players).length : 0;
            document.getElementById('player-count').textContent = playerCount;
            
            // 准备排名数据
            let players = [];
            if (roomData.players) {
                for (const playerId in roomData.players) {
                    const player = roomData.players[playerId];
                    if (player.finished) {
                        players.push({
                            id: playerId,
                            name: player.name,
                            score: player.finalScore || 0,
                            accuracy: player.accuracy || '0.0',
                            time: player.totalTime ? formatTime(player.totalTime) : '0:00'
                        });
                    }
                }
            }
            
            // 按分数排序
            players.sort((a, b) => b.score - a.score);
            
            // 只显示前10名
            players = players.slice(0, 10);
            
            // 更新排名表格
            const rankingBody = document.getElementById('ranking-body');
            rankingBody.innerHTML = '';
            
            players.forEach((player, index) => {
                const row = document.createElement('tr');
                if (player.id === playerId) {
                    row.classList.add('highlight');
                }
                
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${player.name}</td>
                    <td>${player.score}</td>
                    <td>${player.accuracy}%</td>
                    <td>${player.time}</td>
                `;
                
                rankingBody.appendChild(row);
            });
            
            // 如果没有玩家，显示空行
            if (players.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = '<td colspan="5">No players have finished yet</td>';
                rankingBody.appendChild(row);
            }
        }

        // 格式化时间显示
        function formatTime(minutes) {
            const fullMinutes = Math.floor(minutes);
            const seconds = Math.round((minutes - fullMinutes) * 60);
            return `${fullMinutes}:${seconds.toString().padStart(2, '0')}`;
        }

        // 预加载图片
        function preloadImage(src) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.onload = () => resolve(img);
                img.onerror = reject;
                img.src = src;
            });
        }
    </script>
</body>
</html>
