<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>English Tenses Journey - Game</title>
    <link rel="stylesheet" href="style.css">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
</head>
<body>
    <div id="game-container">
        <!-- Game screens will be dynamically loaded here -->
    </div>

    <div id="ranking-screen" class="screen">
        <div class="top-info">
            <div class="room-info">
                <span id="room-number-display">Room: </span>
                <span id="player-count-display">Players: </span>
            </div>
        </div>
        <div class="ranking-table-container">
            <table id="ranking-table">
                <thead>
                    <tr>
                        <th>Rank</th>
                        <th>Name</th>
                        <th>Score</th>
                        <th>Accuracy</th>
                        <th>Time</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Ranking data will be populated here -->
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDHRYTBU74r31MPYVAAnRMwKM76c_-BduQ",
            authDomain: "tetrisonline-ca400.firebaseapp.com",
            projectId: "tetrisonline-ca400",
            storageBucket: "tetrisonline-ca400.firebasestorage.app",
            messagingSenderId: "58207939196",
            appId: "1:58207939196:web:b34f403204096084ee37f9",
            measurementId: "G-GG7GNEQ718"
        };

        // Initialize Firebase
        let firebaseInitialized = false;
        try {
            firebase.initializeApp(firebaseConfig);
            firebaseInitialized = true;
            console.log("Firebase initialized successfully");
        } catch (error) {
            console.error("Firebase initialization error:", error);
            alert("Failed to initialize the game. Please refresh the page.");
        }

        const db = firebaseInitialized ? firebase.firestore() : null;

        // Game state
        let gameState = {
            currentPage: 2101,
            score: 0,
            startTime: null,
            elapsedTime: 0,
            selectedAnswers: {},
            playerId: null,
            roomId: null,
            role: null,
            nickname: null,
            finished: false
        };

        // Game content definition
        const gameContent = {
            2101: {
                image: "画面01.jpg",
                text: "Arturo: Hello, I'm Arturo Valdez.",
                buttons: [],
                nextPage: 2102
            },
            2102: {
                image: "画面02.jpg",
                text: "Alexa: Hi. My name (1) Alexandra Costa, but please (2) me Alexa.",
                buttons: [
                    {
                        id: "1-1",
                        options: [
                            { text: "is", correct: true },
                            { text: "am", correct: false },
                            { text: "are", correct: false }
                        ]
                    },
                    {
                        id: "2-1",
                        options: [
                            { text: "calls", correct: false },
                            { text: "call", correct: true },
                            { text: "calling", correct: false }
                        ]
                    }
                ],
                nextPage: 2103
            },
            2103: {
                image: "画面03.jpg",
                text: "Arturo: OK. Where (3) you from, Alexa?",
                buttons: [
                    {
                        id: "3-1",
                        options: [
                            { text: "is", correct: false },
                            { text: "are", correct: true },
                            { text: "am", correct: false }
                        ]
                    }
                ],
                nextPage: 2104
            },
            2104: {
                image: "画面04.jpg",
                text: "Alexa: Brazil. How about you?",
                buttons: [],
                nextPage: 2105
            },
            2105: {
                image: "画面05.jpg",
                text: "Arturo: I'm from Mexico. I (4) here in the city now, but my family (5) in a small town near Guadalajara.",
                buttons: [
                    {
                        id: "4-1",
                        options: [
                            { text: "lives", correct: true },
                            { text: "live", correct: false },
                            { text: "living", correct: false }
                        ]
                    },
                    {
                        id: "5-1",
                        options: [
                            { text: "lives", correct: true },
                            { text: "live", correct: false },
                            { text: "are living", correct: false }
                        ]
                    }
                ],
                nextPage: 2106
            },
            2106: {
                image: "画面06.jpg",
                text: "Alexa: Oh, I (6) Mexico! It (7) really beautiful. My brother (8) Mexico, too. Oh, good. Soo-jin (9) here.",
                buttons: [
                    {
                        id: "6-1",
                        options: [
                            { text: "loves", correct: false },
                            { text: "love", correct: true },
                            { text: "loving", correct: false }
                        ]
                    },
                    {
                        id: "7-1",
                        options: [
                            { text: "is", correct: true },
                            { text: "am", correct: false },
                            { text: "are", correct: false }
                        ]
                    },
                    {
                        id: "8-1",
                        options: [
                            { text: "loves", correct: true },
                            { text: "love", correct: false },
                            { text: "loving", correct: false }
                        ]
                    },
                    {
                        id: "9-1",
                        options: [
                            { text: "is", correct: true },
                            { text: "are", correct: false },
                            { text: "am", correct: false }
                        ]
                    }
                ],
                nextPage: 2107
            },
            2107: {
                image: "画面07.jpg",
                text: "Arturo: Who (10) Soo-jin? She (11) familiar.",
                buttons: [
                    {
                        id: "10-1",
                        options: [
                            { text: "is", correct: true },
                            { text: "are", correct: false },
                            { text: "am", correct: false }
                        ]
                    },
                    {
                        id: "11-1",
                        options: [
                            { text: "looks", correct: true },
                            { text: "look", correct: false },
                            { text: "looking", correct: false }
                        ]
                    }
                ],
                nextPage: 2108
            },
            2108: {
                image: "画面08.jpg",
                text: "Alexa: She (12) my classmate. We (13) in the same business class. We (14) our class every Monday and Wednesday.",
                buttons: [
                    {
                        id: "12-1",
                        options: [
                            { text: "is", correct: false },
                            { text: "are", correct: true },
                            { text: "am", correct: false }
                        ]
                    },
                    {
                        id: "13-1",
                        options: [
                            { text: "is", correct: false },
                            { text: "are", correct: true },
                            { text: "am", correct: false }
                        ]
                    },
                    {
                        id: "14-1",
                        options: [
                            { text: "has", correct: false },
                            { text: "have", correct: true },
                            { text: "having", correct: false }
                        ]
                    }
                ],
                nextPage: 2109
            },
            2109: {
                image: "画面09.jpg",
                text: "Arturo: Where (15) she from?",
                buttons: [
                    {
                        id: "15-1",
                        options: [
                            { text: "is", correct: false },
                            { text: "are", correct: true },
                            { text: "am", correct: false }
                        ]
                    }
                ],
                nextPage: 2110
            },
            2110: {
                image: "画面10.jpg",
                text: "Alexa: South Korea. She (16) marketing. She (17) the classes (18) very interesting. Let's go and say hello. Sorry, what (19) your last name again? Vargas?",
                buttons: [
                    {
                        id: "16-1",
                        options: [
                            { text: "studies", correct: true },
                            { text: "study", correct: false },
                            { text: "studying", correct: false }
                        ]
                    },
                    {
                        id: "17-1",
                        options: [
                            { text: "says", correct: true },
                            { text: "say", correct: false },
                            { text: "saying", correct: false }
                        ]
                    },
                    {
                        id: "18-1",
                        options: [
                            { text: "is", correct: false },
                            { text: "are", correct: true },
                            { text: "am", correct: false }
                        ]
                    },
                    {
                        id: "19-1",
                        options: [
                            { text: "is", correct: true },
                            { text: "are", correct: false },
                            { text: "am", correct: false }
                        ]
                    }
                ],
                nextPage: 2111
            },
            2111: {
                image: "画面11.jpg",
                text: "Arturo: Actually, it (20) Valdez",
                buttons: [
                    {
                        id: "20-1",
                        options: [
                            { text: "is", correct: true },
                            { text: "are", correct: false },
                            { text: "am", correct: false }
                        ]
                    }
                ],
                nextPage: 2112
            },
            2112: {
                image: "画面12.jpg",
                text: "Alexa: How (21) you spell that?",
                buttons: [
                    {
                        id: "21-1",
                        options: [
                            { text: "is", correct: false },
                            { text: "are", correct: true },
                            { text: "am", correct: false }
                        ]
                    }
                ],
                nextPage: 2113
            }
        };

        // DOM elements
        const gameContainer = document.getElementById('game-container');
        const rankingScreen = document.getElementById('ranking-screen');
        const roomNumberDisplay = document.getElementById('room-number-display');
        const playerCountDisplay = document.getElementById('player-count-display');
        const rankingTable = document.getElementById('ranking-table').querySelector('tbody');

        // Get URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        gameState.roomId = urlParams.get('room');
        gameState.nickname = urlParams.get('nickname');
        gameState.role = urlParams.get('role');

        // Preload next image
        function preloadNextImage(nextPageId) {
            if (gameContent[nextPageId]) {
                const img = new Image();
                img.src = `images/${gameContent[nextPageId].image}`;
            }
        }

        // Create game screen
        function createGameScreen(pageId) {
            const content = gameContent[pageId];
            if (!content) return null;

            const screen = document.createElement('div');
            screen.className = 'screen';
            screen.id = `page-${pageId}`;
            
            // Create image element
            const img = document.createElement('img');
            img.src = `images/${content.image}`;
            img.alt = `Page ${pageId}`;
            img.className = 'background-image fade-in';
            screen.appendChild(img);
            
            // Create text container
            const textContainer = document.createElement('div');
            textContainer.className = 'text-container';
            textContainer.innerHTML = `<p>${content.text}</p>`;
            screen.appendChild(textContainer);
            
            // Create buttons container if there are buttons
            if (content.buttons && content.buttons.length > 0) {
                const buttonsContainer = document.createElement('div');
                buttonsContainer.className = 'buttons-container';
                
                content.buttons.forEach(buttonGroup => {
                    const buttonGroupDiv = document.createElement('div');
                    buttonGroupDiv.className = 'button-group';
                    
                    buttonGroup.options.forEach(option => {
                        const button = document.createElement('button');
                        button.className = 'option-btn';
                        button.textContent = option.text;
                        button.dataset.correct = option.correct;
                        button.dataset.groupId = buttonGroup.id;
                        
                        button.addEventListener('click', () => {
                            // Deselect all buttons in the same group
                            document.querySelectorAll(`.option-btn[data-group-id="${buttonGroup.id}"]`).forEach(btn => {
                                btn.classList.remove('selected');
                            });
                            
                            // Select this button
                            button.classList.add('selected');
                            
                            // Store the selection
                            gameState.selectedAnswers[buttonGroup.id] = option.correct;
                        });
                        
                        buttonGroupDiv.appendChild(button);
                    });
                    
                    buttonsContainer.appendChild(buttonGroupDiv);
                });
                
                screen.appendChild(buttonsContainer);
            }
            
            // Create continue button
            const continueButton = document.createElement('button');
            continueButton.id = 'continue-btn';
            continueButton.className = 'continue-btn';
            continueButton.textContent = 'Continue';
            
            continueButton.addEventListener('click', () => {
                // Calculate score for current page
                calculatePageScore();
                
                // Preload next image
                preloadNextImage(content.nextPage);
                
                // Navigate to next page or finish game
                if (content.nextPage === 2113) {
                    finishGame();
                } else {
                    navigateToPage(content.nextPage);
                }
            });
            
            screen.appendChild(continueButton);
            
            return screen;
        }

        // Calculate score for current page
        function calculatePageScore() {
            const currentPage = gameState.currentPage;
            const content = gameContent[currentPage];
            
            if (!content.buttons) return;
            
            content.buttons.forEach(buttonGroup => {
                if (gameState.selectedAnswers[buttonGroup.id] === true) {
                    gameState.score++;
                }
            });
        }

        // Navigate to specific page
        function navigateToPage(pageId) {
            // Hide current screen
            const currentScreen = document.getElementById(`page-${gameState.currentPage}`);
            if (currentScreen) {
                currentScreen.classList.remove('active');
            }
            
            // Update current page
            gameState.currentPage = pageId;
            
            // Create and show new screen
            const newScreen = createGameScreen(pageId);
            if (newScreen) {
                gameContainer.innerHTML = '';
                gameContainer.appendChild(newScreen);
                newScreen.classList.add('active');
                
                // Update player progress in Firebase
                updatePlayerProgress();
            }
        }

        // Calculate time score
        function calculateTimeScore() {
            if (!gameState.startTime) return 0;
            
            const now = new Date();
            const elapsedMinutes = Math.floor((now - gameState.startTime) / 60000);
            gameState.elapsedTime = elapsedMinutes;
            
            // 2 points per full minute, 1 point for partial minute
            return elapsedMinutes > 0 ? elapsedMinutes * 2 + 1 : 0;
        }

        // Calculate total score
        function calculateTotalScore() {
            const timeScore = calculateTimeScore();
            let totalScore = gameState.score + timeScore;
            
            // Cap score at 100
            return Math.min(totalScore, 100);
        }

        // Calculate accuracy
        function calculateAccuracy() {
            const totalQuestions = 15; // Total number of questions in the game
            return totalQuestions > 0 ? (gameState.score / totalQuestions * 100).toFixed(1) : 0;
        }

        // Calculate progress
        function calculateProgress() {
            // Progress is based on current page (2101-2112 = 1-12)
            const pageNum = gameState.currentPage - 2100;
            return Math.round((pageNum / 12) * 100);
        }

        // Update player progress in Firebase
        async function updatePlayerProgress() {
            if (!firebaseInitialized || gameState.role === 'teacher' || !gameState.playerId) return;
            
            try {
                const progress = calculateProgress();
                const accuracy = calculateAccuracy();
                
                await db.collection('rooms').doc(gameState.roomId).update({
                    [`players.${gameState.playerId}.progress`]: progress,
                    [`players.${gameState.playerId}.accuracy`]: accuracy,
                    [`players.${gameState.playerId}.elapsedTime`]: gameState.elapsedTime,
                    [`players.${gameState.playerId}.lastUpdated`]: firebase.firestore.FieldValue.serverTimestamp()
                });
            } catch (error) {
                console.error("Error updating player progress:", error);
            }
        }

        // Finish game and show ranking
        async function finishGame() {
            gameState.finished = true;
            
            // Calculate final scores
            const totalScore = calculateTotalScore();
            const accuracy = calculateAccuracy();
            const elapsedTime = gameState.elapsedTime;
            
            // Update player data in Firebase
            if (firebaseInitialized && gameState.role === 'player' && gameState.playerId) {
                try {
                    await db.collection('rooms').doc(gameState.roomId).update({
                        [`players.${gameState.playerId}.finished`]: true,
                        [`players.${gameState.playerId}.score`]: totalScore,
                        [`players.${gameState.playerId}.accuracy`]: accuracy,
                        [`players.${gameState.playerId}.elapsedTime`]: elapsedTime,
                        [`players.${gameState.playerId}.completedAt`]: firebase.firestore.FieldValue.serverTimestamp()
                    });
                } catch (error) {
                    console.error("Error updating player completion:", error);
                }
            }
            
            // Show ranking screen
            showRankingScreen();
        }

        // Show ranking screen
        function showRankingScreen() {
            gameContainer.style.display = 'none';
            rankingScreen.style.display = 'block';
            
            // Update room info
            roomNumberDisplay.textContent = `Room: ${gameState.roomId}`;
            
            // Start listening for ranking updates
            listenForRankingUpdates();
        }

        // Listen for ranking updates from Firebase
        function listenForRankingUpdates() {
            if (!firebaseInitialized || !gameState.roomId) return;
            
            db.collection('rooms').doc(gameState.roomId).onSnapshot((doc) => {
                if (doc.exists) {
                    const roomData = doc.data();
                    
                    // Update player count (exclude teacher)
                    const players = roomData.players || {};
                    const playerCount = Object.keys(players).length;
                    playerCountDisplay.textContent = `Players: ${playerCount}`;
                    
                    // Update ranking table
                    updateRankingTable(players);
                }
            }, (error) => {
                console.error("Error listening to room updates:", error);
            });
        }

        // Update ranking table
        function updateRankingTable(players) {
            // Convert players object to array and filter out unfinished players
            const playersArray = Object.entries(players)
                .map(([id, data]) => ({ id, ...data }))
                .filter(player => player.finished);
            
            // Sort by score (descending)
            playersArray.sort((a, b) => b.score - a.score);
            
            // Clear current table
            rankingTable.innerHTML = '';
            
            // Add top 10 players to table
            const topPlayers = playersArray.slice(0, 10);
            
            topPlayers.forEach((player, index) => {
                const row = document.createElement('tr');
                
                // Highlight current player
                if (player.id === gameState.playerId) {
                    row.classList.add('highlighted');
                }
                
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${player.nickname}</td>
                    <td>${player.score}</td>
                    <td>${player.accuracy}%</td>
                    <td>${player.elapsedTime}m</td>
                `;
                
                rankingTable.appendChild(row);
            });
        }

        // Initialize player in Firebase
        async function initializePlayer() {
            if (!firebaseInitialized || gameState.role !== 'player' || !gameState.roomId) return;
            
            try {
                // Generate unique player ID
                gameState.playerId = `${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
                
                // Add player to room
                await db.collection('rooms').doc(gameState.roomId).update({
                    [`players.${gameState.playerId}`]: {
                        nickname: gameState.nickname,
                        progress: 0,
                        accuracy: 0,
                        score: 0,
                        elapsedTime: 0,
                        finished: false,
                        joinedAt: firebase.firestore.FieldValue.serverTimestamp()
                    },
                    playerCount: firebase.firestore.FieldValue.increment(1)
                });
                
                // Start timer
                gameState.startTime = new Date();
                
                // Set up periodic progress updates
                setInterval(updatePlayerProgress, 3000);
            } catch (error) {
                console.error("Error initializing player:", error);
                alert("Failed to join the room. Please try again.");
            }
        }

        // Initialize teacher view
        function initializeTeacherView() {
            if (!gameState.roomId) return;
            
            // Show ranking screen directly for teacher
            showRankingScreen();
        }

        // Initialize game
        async function initializeGame() {
            if (gameState.role === 'teacher') {
                initializeTeacherView();
            } else if (gameState.role === 'player') {
                await initializePlayer();
                navigateToPage(2101);
            } else {
                alert("Invalid role. Redirecting to start page.");
                window.location.href = 'index.html';
            }
        }

        // Start game when page loads
        window.addEventListener('load', initializeGame);
    </script>
</body>
</html>
