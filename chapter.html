<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>英语时态之旅 - 游戏</title>
    <link rel="stylesheet" href="style.css">
    <!-- Firebase App (核心SDK) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <!-- Firebase Database -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
</head>
<body>
    <div id="game-container">
        <!-- 游戏画面将动态加载到这里 -->
    </div>

    <div id="ranking-screen" class="screen">
        <div class="ranking-header">
            <div class="room-info">
                <span id="room-code-display"></span>
                <span id="player-count-display"></span>
            </div>
        </div>
        <div class="ranking-table-container">
            <table id="ranking-table">
                <thead>
                    <tr>
                        <th>排名</th>
                        <th>名称</th>
                        <th>总分数</th>
                        <th>正确率</th>
                        <th>用时</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- 排行榜数据将动态填充 -->
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // Firebase配置
        const firebaseConfig = {
            apiKey: "AIzaSyDHRYTBU74r31MPYVAAnRMwKM76c_-BduQ",
            authDomain: "tetrisonline-ca400.firebaseapp.com",
            projectId: "tetrisonline-ca400",
            storageBucket: "tetrisonline-ca400.firebasestorage.app",
            messagingSenderId: "58207939196",
            appId: "1:58207939196:web:b34f403204096084ee37f9",
            measurementId: "G-GG7GNEQ718"
        };

        // 初始化Firebase
        let firebaseApp;
        let database;
        
        try {
            firebaseApp = firebase.initializeApp(firebaseConfig);
            database = firebase.database();
            console.log("Firebase initialized successfully");
        } catch (error) {
            console.error("Firebase initialization error:", error);
            alert("Failed to initialize database. Please refresh the page.");
        }

        // 游戏数据
        const gameData = {
            currentPage: 1,
            totalPages: 12,
            score: 0,
            startTime: null,
            elapsedTime: 0,
            answers: {},
            roomCode: null,
            nickname: null,
            isTeacher: false,
            playerId: null,
            timerInterval: null,
            dataSyncInterval: null
        };

        // 游戏内容配置
        const pagesConfig = [
            // 页面 1 (ID:2101)
            {
                image: "画面01.jpg",
                text: "Arturo: Hello, I'm Arturo Valdez.",
                buttons: [],
                nextPage: 2
            },
            // 页面 2 (ID:2102)
            {
                image: "画面02.jpg",
                text: "Alexa: Hi. My name （1） Alexandra Costa, but please （2） me Alexa.",
                buttons: [
                    {
                        group: 1,
                        options: [
                            { text: "is", correct: true },
                            { text: "am", correct: false },
                            { text: "are", correct: false }
                        ]
                    },
                    {
                        group: 2,
                        options: [
                            { text: "calls", correct: false },
                            { text: "call", correct: true },
                            { text: "calling", correct: false }
                        ]
                    }
                ],
                nextPage: 3
            },
            // 页面 3 (ID:2103)
            {
                image: "画面03.jpg",
                text: "Arturo: OK. Where （3） you from, Alexa?",
                buttons: [
                    {
                        group: 3,
                        options: [
                            { text: "is", correct: false },
                            { text: "are", correct: true },
                            { text: "am", correct: false }
                        ]
                    }
                ],
                nextPage: 4
            },
            // 页面 4 (ID:2104)
            {
                image: "画面04.jpg",
                text: "Alexa: Brazil. How about you?",
                buttons: [],
                nextPage: 5
            },
            // 页面 5 (ID:2105)
            {
                image: "画面05.jpg",
                text: "Arturo: I'm from Mexico. I （4） here in the city now, but my family （5） in a small town near Guadalajara.",
                buttons: [
                    {
                        group: 4,
                        options: [
                            { text: "lives", correct: true },
                            { text: "live", correct: false },
                            { text: "living", correct: false }
                        ]
                    },
                    {
                        group: 5,
                        options: [
                            { text: "lives", correct: true },
                            { text: "live", correct: false },
                            { text: "are living", correct: false }
                        ]
                    }
                ],
                nextPage: 6
            },
            // 页面 6 (ID:2106)
            {
                image: "画面06.jpg",
                text: "Alexa: Oh, I （6） Mexico! It （7） really beautiful. My brother （8） Mexico, too. Oh, good. Soo-jin （9） here.",
                buttons: [
                    {
                        group: 6,
                        options: [
                            { text: "loves", correct: false },
                            { text: "love", correct: true },
                            { text: "loving", correct: false }
                        ]
                    },
                    {
                        group: 7,
                        options: [
                            { text: "is", correct: true },
                            { text: "am", correct: false },
                            { text: "are", correct: false }
                        ]
                    },
                    {
                        group: 8,
                        options: [
                            { text: "loves", correct: true },
                            { text: "love", correct: false },
                            { text: "loving", correct: false }
                        ]
                    },
                    {
                        group: 9,
                        options: [
                            { text: "is", correct: true },
                            { text: "are", correct: false },
                            { text: "am", correct: false }
                        ]
                    }
                ],
                nextPage: 7
            },
            // 页面 7 (ID:2107)
            {
                image: "画面07.jpg",
                text: "Arturo: Who （10） Soo-jin? She （11） familiar.",
                buttons: [
                    {
                        group: 10,
                        options: [
                            { text: "is", correct: true },
                            { text: "are", correct: false },
                            { text: "am", correct: false }
                        ]
                    },
                    {
                        group: 11,
                        options: [
                            { text: "looks", correct: true },
                            { text: "look", correct: false },
                            { text: "looking", correct: false }
                        ]
                    }
                ],
                nextPage: 8
            },
            // 页面 8 (ID:2108)
            {
                image: "画面08.jpg",
                text: "Alexa: She （12） my classmate. We （13） in the same business class. We （14） our class every Monday and Wednesday.",
                buttons: [
                    {
                        group: 12,
                        options: [
                            { text: "is", correct: false },
                            { text: "are", correct: true },
                            { text: "am", correct: false }
                        ]
                    },
                    {
                        group: 13,
                        options: [
                            { text: "is", correct: false },
                            { text: "are", correct: true },
                            { text: "am", correct: false }
                        ]
                    },
                    {
                        group: 14,
                        options: [
                            { text: "has", correct: false },
                            { text: "have", correct: true },
                            { text: "having", correct: false }
                        ]
                    }
                ],
                nextPage: 9
            },
            // 页面 9 (ID:2109)
            {
                image: "画面09.jpg",
                text: "Arturo: Where （15） she from?",
                buttons: [
                    {
                        group: 15,
                        options: [
                            { text: "is", correct: false },
                            { text: "are", correct: true },
                            { text: "am", correct: false }
                        ]
                    }
                ],
                nextPage: 10
            },
            // 页面 10 (ID:2110)
            {
                image: "画面10.jpg",
                text: "Alexa: South Korea. She （16） marketing. She （17） the classes （18） very interesting. Let's go and say hello. Sorry, what （19） your last name again? Vargas?",
                buttons: [
                    {
                        group: 16,
                        options: [
                            { text: "studies", correct: true },
                            { text: "study", correct: false },
                            { text: "studying", correct: false }
                        ]
                    },
                    {
                        group: 17,
                        options: [
                            { text: "says", correct: true },
                            { text: "say", correct: false },
                            { text: "saying", correct: false }
                        ]
                    },
                    {
                        group: 18,
                        options: [
                            { text: "is", correct: false },
                            { text: "are", correct: true },
                            { text: "am", correct: false }
                        ]
                    },
                    {
                        group: 19,
                        options: [
                            { text: "is", correct: true },
                            { text: "are", correct: false },
                            { text: "am", correct: false }
                        ]
                    }
                ],
                nextPage: 11
            },
            // 页面 11 (ID:2111)
            {
                image: "画面11.jpg",
                text: "Arturo: Actually, it （20） Valdez",
                buttons: [
                    {
                        group: 20,
                        options: [
                            { text: "is", correct: true },
                            { text: "are", correct: false },
                            { text: "am", correct: false }
                        ]
                    }
                ],
                nextPage: 12
            },
            // 页面 12 (ID:2112)
            {
                image: "画面12.jpg",
                text: "Alexa: How （21） you spell that?",
                buttons: [
                    {
                        group: 21,
                        options: [
                            { text: "is", correct: false },
                            { text: "are", correct: true },
                            { text: "am", correct: false }
                        ]
                    }
                ],
                nextPage: 13
            }
        ];

        // 初始化游戏
        function initGame() {
            // 解析URL参数
            const urlParams = new URLSearchParams(window.location.search);
            gameData.roomCode = urlParams.get('room');
            gameData.nickname = urlParams.get('nickname');
            gameData.isTeacher = urlParams.get('role') === 'teacher';
            
            if (!gameData.roomCode) {
                alert("Invalid room code. Redirecting to start page.");
                window.location.href = "index.html";
                return;
            }
            
            if (gameData.isTeacher) {
                // 老师直接进入排行榜
                showRankingScreen();
                startDataSync();
            } else {
                if (!gameData.nickname) {
                    alert("Nickname required. Redirecting to start page.");
                    window.location.href = "index.html";
                    return;
                }
                
                // 玩家开始游戏
                gameData.startTime = Date.now();
                gameData.playerId = generatePlayerId();
                
                // 将玩家添加到房间
                addPlayerToRoom();
                
                // 开始计时和数据同步
                startTimer();
                startDataSync();
                
                // 加载第一个页面
                loadPage(1);
            }
        }

        // 生成玩家ID
        function generatePlayerId() {
            return 'player_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        // 将玩家添加到房间
        async function addPlayerToRoom() {
            try {
                const playerData = {
                    nickname: gameData.nickname,
                    joinedAt: firebase.database.ServerValue.TIMESTAMP,
                    score: 0,
                    progress: 0,
                    accuracy: 0,
                    time: 0,
                    finished: false
                };
                
                // 添加玩家到房间
                await database.ref('rooms/' + gameData.roomCode + '/players/' + gameData.playerId).set(playerData);
                
                // 更新玩家计数
                const playersRef = database.ref('rooms/' + gameData.roomCode + '/players');
                playersRef.once('value', snapshot => {
                    const playerCount = snapshot.numChildren();
                    database.ref('rooms/' + gameData.roomCode + '/playerCount').set(playerCount);
                });
                
            } catch (error) {
                console.error("Error adding player to room:", error);
            }
        }

        // 开始计时器
        function startTimer() {
            gameData.timerInterval = setInterval(() => {
                gameData.elapsedTime = Date.now() - gameData.startTime;
            }, 1000);
        }

        // 开始数据同步
        function startDataSync() {
            gameData.dataSyncInterval = setInterval(() => {
                updatePlayerData();
            }, 3000);
        }

        // 更新玩家数据到数据库
        async function updatePlayerData() {
            if (gameData.isTeacher || !gameData.playerId) return;
            
            try {
                // 计算进度百分比
                const progress = Math.floor((gameData.currentPage / gameData.totalPages) * 100);
                
                // 计算正确率
                const correctAnswers = Object.values(gameData.answers).filter(answer => answer).length;
                const accuracy = gameData.currentPage > 1 ? 
                    (correctAnswers / (gameData.currentPage - 1)) * 100 : 0;
                
                // 计算时间分数（每分钟2分，不满一分钟按1分计算）
                const minutes = Math.floor(gameData.elapsedTime / 60000);
                const timeScore = minutes * 2 + (gameData.elapsedTime % 60000 > 0 ? 1 : 0);
                
                // 计算总分（N-时间分数，不超过100）
                const totalScore = Math.min(100, gameData.score - timeScore);
                
                const playerData = {
                    nickname: gameData.nickname,
                    score: totalScore,
                    progress: progress,
                    accuracy: accuracy.toFixed(1),
                    time: Math.floor(gameData.elapsedTime / 1000), // 以秒为单位存储
                    finished: gameData.currentPage > gameData.totalPages
                };
                
                await database.ref('rooms/' + gameData.roomCode + '/players/' + gameData.playerId).update(playerData);
                
            } catch (error) {
                console.error("Error updating player data:", error);
            }
        }

        // 加载游戏页面
        function loadPage(pageNumber) {
            if (pageNumber > pagesConfig.length) {
                // 游戏结束，显示排行榜
                gameFinished();
                return;
            }
            
            const pageConfig = pagesConfig[pageNumber - 1];
            const gameContainer = document.getElementById('game-container');
            
            // 创建页面HTML
            let pageHTML = `
                <div class="game-screen screen active">
                    <img src="images/${pageConfig.image}" alt="Game Scene" class="background-image">
                    <div class="text-content">${pageConfig.text}</div>
            `;
            
            // 添加按钮组（如果有）
            if (pageConfig.buttons && pageConfig.buttons.length > 0) {
                pageHTML += `<div class="button-groups">`;
                
                pageConfig.buttons.forEach(buttonGroup => {
                    pageHTML += `<div class="button-group" data-group="${buttonGroup.group}">`;
                    
                    buttonGroup.options.forEach((option, index) => {
                        pageHTML += `
                            <button class="option-btn" 
                                    data-group="${buttonGroup.group}" 
                                    data-index="${index}" 
                                    data-correct="${option.correct}">
                                ${option.text}
                            </button>
                        `;
                    });
                    
                    pageHTML += `</div>`;
                });
                
                pageHTML += `</div>`;
            }
            
            // 添加继续按钮
            pageHTML += `
                <button class="continue-btn">Continue</button>
                </div>
            `;
            
            // 应用淡入效果
            gameContainer.innerHTML = pageHTML;
            setTimeout(() => {
                const screen = gameContainer.querySelector('.game-screen');
                screen.classList.add('fade-in');
            }, 50);
            
            // 添加事件监听器
            attachEventListeners(pageNumber, pageConfig);
            
            // 预加载下一张图片（如果存在）
            if (pageNumber < pagesConfig.length) {
                preloadNextImage(pageNumber + 1);
            }
        }

        // 预加载下一张图片
        function preloadNextImage(nextPageNumber) {
            const nextPageConfig = pagesConfig[nextPageNumber - 1];
            if (nextPageConfig && nextPageConfig.image) {
                const img = new Image();
                img.src = 'images/' + nextPageConfig.image;
            }
        }

        // 附加事件监听器
        function attachEventListeners(pageNumber, pageConfig) {
            // 选项按钮点击事件
            const optionButtons = document.querySelectorAll('.option-btn');
            optionButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const group = this.dataset.group;
                    const isCorrect = this.dataset.correct === 'true';
                    
                    // 高亮选中的按钮，暗淡同组其他按钮
                    const groupButtons = document.querySelectorAll(`.option-btn[data-group="${group}"]`);
                    groupButtons.forEach(btn => {
                        btn.classList.remove('selected');
                    });
                    this.classList.add('selected');
                    
                    // 存储答案（但不立即计分，等到点击Continue时才计分）
                    gameData.answers[group] = isCorrect;
                });
            });
            
            // 继续按钮点击事件
            const continueButton = document.querySelector('.continue-btn');
            continueButton.addEventListener('click', function() {
                // 计算当前页面的得分
                if (pageConfig.buttons && pageConfig.buttons.length > 0) {
                    pageConfig.buttons.forEach(buttonGroup => {
                        if (gameData.answers[buttonGroup.group] === true) {
                            gameData.score += 1;
                        }
                    });
                }
                
                // 更新当前页面
                gameData.currentPage = pageNumber + 1;
                
                // 加载下一页
                loadPage(gameData.currentPage);
            });
        }

        // 游戏结束处理
        function gameFinished() {
            // 停止计时器和数据同步
            clearInterval(gameData.timerInterval);
            clearInterval(gameData.dataSyncInterval);
            
            // 标记玩家为已完成
            database.ref('rooms/' + gameData.roomCode + '/players/' + gameData.playerId).update({
                finished: true
            });
            
            // 显示排行榜
            showRankingScreen();
        }

        // 显示排行榜
        function showRankingScreen() {
            const gameContainer = document.getElementById('game-container');
            const rankingScreen = document.getElementById('ranking-screen');
            
            gameContainer.classList.remove('active');
            rankingScreen.classList.add('active');
            
            // 显示房间信息
            document.getElementById('room-code-display').textContent = `Room: ${gameData.roomCode}`;
            
            // 加载排行榜数据
            loadRankingData();
            
            // 设置排行榜数据刷新
            setInterval(loadRankingData, 3000);
        }

        // 加载排行榜数据
        async function loadRankingData() {
            try {
                const snapshot = await database.ref('rooms/' + gameData.roomCode).once('value');
                const roomData = snapshot.val();
                
                if (!roomData) return;
                
                // 更新玩家数量显示
                const playerCount = roomData.playerCount || 0;
                document.getElementById('player-count-display').textContent = `Players: ${playerCount}`;
                
                // 获取玩家数据并排序
                const players = roomData.players ? Object.values(roomData.players) : [];
                const rankedPlayers = players
                    .filter(player => player.finished) // 只显示已完成的玩家
                    .sort((a, b) => b.score - a.score) // 按分数降序排序
                    .slice(0, 10); // 只取前10名
                
                // 更新排行榜表格
                const tableBody = document.querySelector('#ranking-table tbody');
                tableBody.innerHTML = '';
                
                rankedPlayers.forEach((player, index) => {
                    const row = document.createElement('tr');
                    
                    // 高亮显示当前玩家
                    if (player.nickname === gameData.nickname) {
                        row.classList.add('highlight');
                    }
                    
                    // 格式化时间显示
                    const minutes = Math.floor(player.time / 60);
                    const seconds = player.time % 60;
                    const timeDisplay = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                    
                    row.innerHTML = `
                        <td>${index + 1}</td>
                        <td>${player.nickname}</td>
                        <td>${player.score}</td>
                        <td>${player.accuracy}%</td>
                        <td>${timeDisplay}</td>
                    `;
                    
                    tableBody.appendChild(row);
                });
                
            } catch (error) {
                console.error("Error loading ranking data:", error);
            }
        }

        // 页面加载完成后初始化游戏
        window.addEventListener('load', initGame);
    </script>
</body>
</html>
