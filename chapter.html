<!-- chapter.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>英语时态之旅 - 游戏</title>
    <link rel="stylesheet" href="style.css">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
</head>
<body>
    <div id="game-container">
        <!-- 游戏画面将通过JS动态加载 -->
    </div>

    <div id="ranking-screen" class="screen">
        <div class="ranking-header">
            <div class="room-info">
                <p>房间号: <span id="room-number-display"></span></p>
                <p>玩家人数: <span id="player-count">0</span></p>
            </div>
        </div>
        <div class="ranking-table-container">
            <table id="ranking-table">
                <thead>
                    <tr>
                        <th>排名</th>
                        <th>名称</th>
                        <th>总分数</th>
                        <th>正确率</th>
                        <th>用时</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- 排行榜数据将通过JS动态填充 -->
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // Firebase配置
        const firebaseConfig = {
            apiKey: "AIzaSyDHRYTBU74r31MPYVAAnRMwKM76c_-BduQ",
            authDomain: "tetrisonline-ca400.firebaseapp.com",
            projectId: "tetrisonline-ca400",
            storageBucket: "tetrisonline-ca400.firebasestorage.app",
            messagingSenderId: "58207939196",
            appId: "1:58207939196:web:b34f403204096084ee37f9",
            measurementId: "G-GG7GNEQ718"
        };

        // 初始化Firebase
        let firebaseInitialized = false;
        try {
            firebase.initializeApp(firebaseConfig);
            firebaseInitialized = true;
            console.log("Firebase initialized successfully");
        } catch (error) {
            console.error("Firebase initialization error:", error);
            alert("Database connection failed. Please refresh and try again.");
        }

        // 全局变量
        let currentRoom = null;
        let playerId = null;
        let isTeacher = false;
        let startTime = null;
        let currentPage = 2101; // 从画面01开始
        let selectedAnswers = {};
        let score = 0;
        let timeInterval = null;
        let databaseRef = null;

        // 正确答案映射
        const correctAnswers = {
            2102: { 1: "is", 2: "call" },
            2103: { 3: "are" },
            2105: { 4: "lives", 5: "lives" },
            2106: { 6: "love", 7: "is", 8: "loves", 9: "is" },
            2107: { 10: "is", 11: "looks" },
            2108: { 12: "are", 13: "are", 14: "have" },
            2109: { 15: "is" },
            2110: { 16: "studies", 17: "says", 18: "are", 19: "is" },
            2111: { 20: "is" },
            2112: { 21: "are" }
        };

        // 页面内容配置
        const pageConfigs = {
            2101: { image: "画面01.jpg", text: "Arturo: Hello, I'm Arturo Valdez.", buttons: [] },
            2102: { 
                image: "画面02.jpg", 
                text: "Alexa: Hi. My name (1) Alexandra Costa, but please (2) me Alexa.",
                buttons: [
                    { group: 1, options: [
                        { id: "1-1", text: "is", correct: true },
                        { id: "1-2", text: "am", correct: false },
                        { id: "1-3", text: "are", correct: false }
                    ]},
                    { group: 2, options: [
                        { id: "2-1", text: "calls", correct: false },
                        { id: "2-2", text: "call", correct: true },
                        { id: "2-3", text: "calling", correct: false }
                    ]}
                ]
            },
            2103: { 
                image: "画面03.jpg", 
                text: "Arturo: OK. Where (3) you from, Alexa?",
                buttons: [
                    { group: 3, options: [
                        { id: "3-1", text: "is", correct: false },
                        { id: "3-2", text: "are", correct: true },
                        { id: "3-3", text: "am", correct: false }
                    ]}
                ]
            },
            2104: { image: "画面04.jpg", text: "Alexa: Brazil. How about you?", buttons: [] },
            2105: { 
                image: "画面05.jpg", 
                text: "Arturo: I'm from Mexico. I (4) here in the city now, but my family (5) in a small town near Guadalajara.",
                buttons: [
                    { group: 4, options: [
                        { id: "4-1", text: "lives", correct: true },
                        { id: "4-2", text: "live", correct: false },
                        { id: "4-3", text: "living", correct: false }
                    ]},
                    { group: 5, options: [
                        { id: "5-1", text: "lives", correct: true },
                        { id: "5-2", text: "live", correct: false },
                        { id: "5-3", text: "are living", correct: false }
                    ]}
                ]
            },
            2106: { 
                image: "画面06.jpg", 
                text: "Alexa: Oh, I (6) Mexico! It (7) really beautiful. My brother (8) Mexico, too. Oh, good. Soo-jin (9) here.",
                buttons: [
                    { group: 6, options: [
                        { id: "6-1", text: "loves", correct: false },
                        { id: "6-2", text: "love", correct: true },
                        { id: "6-3", text: "loving", correct: false }
                    ]},
                    { group: 7, options: [
                        { id: "7-1", text: "is", correct: true },
                        { id: "7-2", text: "am", correct: false },
                        { id: "7-3", text: "are", correct: false }
                    ]},
                    { group: 8, options: [
                        { id: "8-1", text: "loves", correct: true },
                        { id: "8-2", text: "love", correct: false },
                        { id: "8-3", text: "loving", correct: false }
                    ]},
                    { group: 9, options: [
                        { id: "9-1", text: "is", correct: true },
                        { id: "9-2", text: "are", correct: false },
                        { id: "9-3", text: "am", correct: false }
                    ]}
                ]
            },
            2107: { 
                image: "画面07.jpg", 
                text: "Arturo: Who (10) Soo-jin? She (11) familiar.",
                buttons: [
                    { group: 10, options: [
                        { id: "10-1", text: "is", correct: true },
                        { id: "10-2", text: "are", correct: false },
                        { id: "10-3", text: "am", correct: false }
                    ]},
                    { group: 11, options: [
                        { id: "11-1", text: "looks", correct: true },
                        { id: "11-2", text: "look", correct: false },
                        { id: "11-3", text: "looking", correct: false }
                    ]}
                ]
            },
            2108: { 
                image: "画面08.jpg", 
                text: "Alexa: She (12) my classmate. We (13) in the same business class. We (14) our class every Monday and Wednesday.",
                buttons: [
                    { group: 12, options: [
                        { id: "12-1", text: "is", correct: false },
                        { id: "12-2", text: "are", correct: true },
                        { id: "12-3", text: "am", correct: false }
                    ]},
                    { group: 13, options: [
                        { id: "13-1", text: "is", correct: false },
                        { id: "13-2", text: "are", correct: true },
                        { id: "13-3", text: "am", correct: false }
                    ]},
                    { group: 14, options: [
                        { id: "14-1", text: "has", correct: false },
                        { id: "14-2", text: "have", correct: true },
                        { id: "14-3", text: "having", correct: false }
                    ]}
                ]
            },
            2109: { 
                image: "画面09.jpg", 
                text: "Arturo: Where (15) she from?",
                buttons: [
                    { group: 15, options: [
                        { id: "15-1", text: "is", correct: false },
                        { id: "15-2", text: "are", correct: true },
                        { id: "15-3", text: "am", correct: false }
                    ]}
                ]
            },
            2110: { 
                image: "画面10.jpg", 
                text: "Alexa: South Korea. She (16) marketing. She (17) the classes (18) very interesting. Let's go and say hello. Sorry, what (19) your last name again? Vargas?",
                buttons: [
                    { group: 16, options: [
                        { id: "16-1", text: "studies", correct: true },
                        { id: "16-2", text: "study", correct: false },
                        { id: "16-3", text: "studying", correct: false }
                    ]},
                    { group: 17, options: [
                        { id: "17-1", text: "says", correct: true },
                        { id: "17-2", text: "say", correct: false },
                        { id: "17-3", text: "saying", correct: false }
                    ]},
                    { group: 18, options: [
                        { id: "18-1", text: "is", correct: false },
                        { id: "18-2", text: "are", correct: true },
                        { id: "18-3", text: "am", correct: false }
                    ]},
                    { group: 19, options: [
                        { id: "19-1", text: "is", correct: true },
                        { id: "19-2", text: "are", correct: false },
                        { id: "19-3", text: "am", correct: false }
                    ]}
                ]
            },
            2111: { 
                image: "画面11.jpg", 
                text: "Arturo: Actually, it (20) Valdez",
                buttons: [
                    { group: 20, options: [
                        { id: "20-1", text: "is", correct: true },
                        { id: "20-2", text: "are", correct: false },
                        { id: "20-3", text: "am", correct: false }
                    ]}
                ]
            },
            2112: { 
                image: "画面12.jpg", 
                text: "Alexa: How (21) you spell that?",
                buttons: [
                    { group: 21, options: [
                        { id: "21-1", text: "is", correct: false },
                        { id: "21-2", text: "are", correct: true },
                        { id: "21-3", text: "am", correct: false }
                    ]}
                ]
            }
        };

        // 初始化游戏
        function initGame() {
            // 获取URL参数
            const urlParams = new URLSearchParams(window.location.search);
            currentRoom = urlParams.get('room');
            playerId = urlParams.get('player');
            isTeacher = urlParams.has('teacher');
            
            if (!currentRoom) {
                alert("房间号缺失，将返回首页");
                window.location.href = "index.html";
                return;
            }
            
            if (isTeacher) {
                // 老师直接显示排行榜
                showRankingScreen();
                setupRankingUpdates();
                return;
            }
            
            if (!playerId) {
                alert("玩家ID缺失，将返回首页");
                window.location.href = "index.html";
                return;
            }
            
            // 记录开始时间
            startTime = Date.now();
            
            // 设置Firebase监听
            setupFirebaseListeners();
            
            // 加载第一个画面
            loadPage(currentPage);
            
            // 开始计时
            startTimer();
        }

        // 设置Firebase监听
        function setupFirebaseListeners() {
            if (!firebaseInitialized) return;
            
            const db = firebase.database();
            databaseRef = db.ref('rooms/' + currentRoom + '/players/' + playerId);
            
            // 每3秒更新一次玩家数据
            timeInterval = setInterval(() => {
                updatePlayerData();
            }, 3000);
        }

        // 更新玩家数据
        function updatePlayerData() {
            if (!firebaseInitialized || !databaseRef) return;
            
            const timeSpent = Math.floor((Date.now() - startTime) / 1000);
            const progress = Math.floor((currentPage - 2101) / 12 * 100);
            
            databaseRef.update({
                timeSpent: timeSpent,
                progress: progress,
                correctAnswers: score,
                status: currentPage === 2113 ? "finished" : "playing"
            });
        }

        // 开始计时
        function startTimer() {
            // 计时已经在updatePlayerData中处理
        }

        // 加载页面
        function loadPage(pageId) {
            const gameContainer = document.getElementById('game-container');
            gameContainer.innerHTML = '';
            
            if (pageId === 2113) {
                // 游戏结束，显示排行榜
                showRankingScreen();
                calculateFinalScore();
                return;
            }
            
            const config = pageConfigs[pageId];
            if (!config) {
                console.error("Invalid page ID:", pageId);
                return;
            }
            
            // 创建页面元素
            const pageElement = document.createElement('div');
            pageElement.className = 'game-screen';
            
            // 添加图片
            const img = document.createElement('img');
            img.src = 'images/' + config.image;
            img.alt = 'Game Scene';
            img.className = 'background-image fade-in';
            pageElement.appendChild(img);
            
            // 添加文字内容
            const textContainer = document.createElement('div');
            textContainer.className = 'text-container';
            textContainer.textContent = config.text;
            pageElement.appendChild(textContainer);
            
            // 添加按钮组
            if (config.buttons && config.buttons.length > 0) {
                const buttonsContainer = document.createElement('div');
                buttonsContainer.className = 'buttons-container';
                
                config.buttons.forEach(buttonGroup => {
                    const groupContainer = document.createElement('div');
                    groupContainer.className = 'button-group';
                    
                    buttonGroup.options.forEach(option => {
                        const button = document.createElement('button');
                        button.className = 'option-btn';
                        button.textContent = option.text;
                        button.dataset.id = option.id;
                        button.dataset.correct = option.correct;
                        
                        button.addEventListener('click', () => {
                            // 处理按钮选择
                            handleOptionSelect(buttonGroup.group, option.id, option.correct);
                            
                            // 高亮选中的按钮，取消同组其他按钮的高亮
                            const siblings = groupContainer.querySelectorAll('.option-btn');
                            siblings.forEach(btn => {
                                btn.classList.remove('selected');
                            });
                            button.classList.add('selected');
                        });
                        
                        groupContainer.appendChild(button);
                    });
                    
                    buttonsContainer.appendChild(groupContainer);
                });
                
                pageElement.appendChild(buttonsContainer);
            }
            
            // 添加Continue按钮
            const continueBtn = document.createElement('button');
            continueBtn.className = 'continue-btn';
            continueBtn.textContent = 'Continue';
            continueBtn.addEventListener('click', () => {
                handleContinue(pageId);
            });
            pageElement.appendChild(continueBtn);
            
            gameContainer.appendChild(pageElement);
            
            // 预加载下一张图片
            preloadNextImage(pageId);
        }

        // 处理选项选择
        function handleOptionSelect(groupId, optionId, isCorrect) {
            selectedAnswers[groupId] = {
                id: optionId,
                correct: isCorrect
            };
        }

        // 处理Continue按钮点击
        function handleContinue(currentPageId) {
            // 计算当前页面的得分
            if (pageConfigs[currentPageId].buttons && pageConfigs[currentPageId].buttons.length > 0) {
                let pageScore = 0;
                
                pageConfigs[currentPageId].buttons.forEach(group => {
                    const groupId = group.group;
                    if (selectedAnswers[groupId] && selectedAnswers[groupId].correct) {
                        pageScore++;
                    }
                });
                
                score += pageScore;
            }
            
            // 清空当前页面的选择
            selectedAnswers = {};
            
            // 加载下一页
            const nextPageId = currentPageId + 1;
            currentPage = nextPageId;
            
            // 更新玩家进度
            updatePlayerData();
            
            // 如果是最后一页，计算最终得分
            if (nextPageId === 2113) {
                calculateFinalScore();
                clearInterval(timeInterval);
                
                if (firebaseInitialized && databaseRef) {
                    databaseRef.update({
                        status: "finished",
                        finishedAt: Date.now()
                    });
                }
            }
            
            loadPage(nextPageId);
        }

        // 计算最终得分
        function calculateFinalScore() {
            const timeSpent = Math.floor((Date.now() - startTime) / 1000);
            const minutes = Math.floor(timeSpent / 60);
            
            // 计算时间分数：每满一分钟2分，不满一分钟1分
            const timeScore = minutes * 2 + (timeSpent % 60 > 0 ? 1 : 0);
            
            // 计算总分数 = 正确数 + 时间分数，不超过100
            let totalScore = score + timeScore;
            totalScore = Math.min(totalScore, 100);
            
            // 计算正确率
            const accuracy = (score / 15 * 100).toFixed(1);
            
            // 更新数据库中的最终得分
            if (firebaseInitialized && databaseRef) {
                databaseRef.update({
                    totalScore: totalScore,
                    accuracy: accuracy,
                    timeSpent: timeSpent,
                    status: "finished",
                    finishedAt: Date.now()
                });
            }
            
            // 显示排行榜
            showRankingScreen();
            setupRankingUpdates();
        }

        // 显示排行榜
        function showRankingScreen() {
            document.getElementById('game-container').style.display = 'none';
            document.getElementById('ranking-screen').style.display = 'block';
            document.getElementById('room-number-display').textContent = currentRoom;
        }

        // 设置排行榜更新
        function setupRankingUpdates() {
            if (!firebaseInitialized) return;
            
            const db = firebase.database();
            const roomRef = db.ref('rooms/' + currentRoom);
            
            // 监听房间数据变化
            roomRef.on('value', (snapshot) => {
                const roomData = snapshot.val();
                if (!roomData) return;
                
                // 更新玩家人数
                const players = roomData.players || {};
                const playerCount = Object.keys(players).length;
                document.getElementById('player-count').textContent = playerCount;
                
                // 准备排行榜数据
                const rankingData = [];
                for (const playerId in players) {
                    const player = players[playerId];
                    if (player.status === "finished") {
                        rankingData.push({
                            nickname: player.nickname,
                            totalScore: player.totalScore || 0,
                            accuracy: player.accuracy || "0.0",
                            timeSpent: player.timeSpent || 0
                        });
                    }
                }
                
                // 按分数排序
                rankingData.sort((a, b) => b.totalScore - a.totalScore);
                
                // 更新排行榜
                updateRankingTable(rankingData);
            });
        }

        // 更新排行榜表格
        function updateRankingTable(data) {
            const tableBody = document.querySelector('#ranking-table tbody');
            tableBody.innerHTML = '';
            
            // 只显示前10名
            const top10 = data.slice(0, 10);
            
            top10.forEach((player, index) => {
                const row = document.createElement('tr');
                
                // 高亮显示当前玩家
                if (!isTeacher && player.nickname === playerNickname) {
                    row.classList.add('highlight');
                }
                
                // 格式化时间
                const minutes = Math.floor(player.timeSpent / 60);
                const seconds = player.timeSpent % 60;
                const timeFormatted = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${escapeHtml(player.nickname)}</td>
                    <td>${player.totalScore}</td>
                    <td>${player.accuracy}%</td>
                    <td>${timeFormatted}</td>
                `;
                
                tableBody.appendChild(row);
            });
        }

        // 预加载下一张图片
        function preloadNextImage(currentPageId) {
            const nextPageId = currentPageId + 1;
            if (nextPageId <= 2112) {
                const nextConfig = pageConfigs[nextPageId];
                if (nextConfig && nextConfig.image) {
                    const img = new Image();
                    img.src = 'images/' + nextConfig.image;
                }
            }
        }

        // HTML转义函数
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // 页面加载完成后初始化游戏
        window.addEventListener('load', initGame);
    </script>
</body>
</html>
