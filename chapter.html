<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>English Tenses Journey - Chapter</title>
    <link rel="stylesheet" href="style.css">
    <!-- Firebase App (核心SDK) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <!-- Firebase Firestore -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
</head>
<body>
    <div class="screen">
        <!-- 动态内容将由JavaScript填充 -->
        <img id="scene-image" class="background-image" alt="Scene">
        <div class="text-container">
            <p id="dialogue-text"></p>
        </div>
        <div id="buttons-container" class="buttons-container"></div>
        <button id="continue-btn" class="continue-btn">Continue</button>
    </div>

    <!-- 排行榜画面 -->
    <div id="leaderboard-screen" class="screen">
        <div class="leaderboard-header">
            <div class="room-info">
                <p>Room: <span id="room-code-display"></span></p>
                <p>Players: <span id="player-count-display">0</span></p>
            </div>
        </div>
        <div class="leaderboard-container">
            <table id="leaderboard-table">
                <thead>
                    <tr>
                        <th>Rank</th>
                        <th>Name</th>
                        <th>Score</th>
                        <th>Accuracy</th>
                        <th>Time</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- 排行榜数据将由JavaScript填充 -->
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // Firebase配置
        const firebaseConfig = {
            apiKey: "AIzaSyDHRYTBU74r31MPYVAAnRMwKM76c_-BduQ",
            authDomain: "tetrisonline-ca400.firebaseapp.com",
            projectId: "tetrisonline-ca400",
            storageBucket: "tetrisonline-ca400.firebasestorage.app",
            messagingSenderId: "58207939196",
            appId: "1:58207939196:web:b34f403204096084ee37f9",
            measurementId: "G-GG7GNEQ718"
        };

        // 初始化Firebase
        let firebaseInitialized = false;
        let db = null;
        
        try {
            // 初始化Firebase
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            firebaseInitialized = true;
            console.log("Firebase initialized successfully");
        } catch (error) {
            console.error("Firebase initialization error:", error);
            alert("Failed to initialize Firebase. Please check your connection.");
        }

        // 从URL获取参数
        const urlParams = new URLSearchParams(window.location.search);
        const roomCode = urlParams.get('room');
        const playerId = urlParams.get('player');
        const isTeacher = urlParams.get('teacher') === 'true';

        // 游戏数据
        const gameData = {
            currentPage: 1,
            score: 0,
            correctAnswers: 0,
            selectedOptions: {},
            startTime: Date.now(),
            timeSpent: 0
        };

        // 场景数据
        const scenes = [
            {
                id: 2101,
                image: '画面01.jpg',
                text: "Arturo: Hello, I'm Arturo Valdez.",
                buttons: [],
                next: 2102
            },
            {
                id: 2102,
                image: '画面02.jpg',
                text: "Alexa: Hi. My name (1) Alexandra Costa, but please (2) me Alexa.",
                buttons: [
                    {
                        group: 1,
                        options: [
                            { id: '1-1', text: 'is', correct: true },
                            { id: '1-2', text: 'am', correct: false },
                            { id: '1-3', text: 'are', correct: false }
                        ]
                    },
                    {
                        group: 2,
                        options: [
                            { id: '2-1', text: 'calls', correct: false },
                            { id: '2-2', text: 'call', correct: true },
                            { id: '2-3', text: 'calling', correct: false }
                        ]
                    }
                ],
                next: 2103
            },
            {
                id: 2103,
                image: '画面03.jpg',
                text: "Arturo: OK. Where (3) you from, Alexa?",
                buttons: [
                    {
                        group: 3,
                        options: [
                            { id: '3-1', text: 'is', correct: false },
                            { id: '3-2', text: 'are', correct: true },
                            { id: '3-3', text: 'am', correct: false }
                        ]
                    }
                ],
                next: 2104
            },
            {
                id: 2104,
                image: '画面04.jpg',
                text: "Alexa: Brazil. How about you?",
                buttons: [],
                next: 2105
            },
            {
                id: 2105,
                image: '画面05.jpg',
                text: "Arturo: I'm from Mexico. I (4) here in the city now, but my family (5) in a small town near Guadalajara.",
                buttons: [
                    {
                        group: 4,
                        options: [
                            { id: '4-1', text: 'lives', correct: true },
                            { id: '4-2', text: 'live', correct: false },
                            { id: '4-3', text: 'living', correct: false }
                        ]
                    },
                    {
                        group: 5,
                        options: [
                            { id: '5-1', text: 'lives', correct: true },
                            { id: '5-2', text: 'live', correct: false },
                            { id: '5-3', text: 'are living', correct: false }
                        ]
                    }
                ],
                next: 2106
            },
            {
                id: 2106,
                image: '画面06.jpg',
                text: "Alexa: Oh, I (6) Mexico! It (7) really beautiful. My brother (8) Mexico, too. Oh, good. Soo-jin (9) here.",
                buttons: [
                    {
                        group: 6,
                        options: [
                            { id: '6-1', text: 'loves', correct: false },
                            { id: '6-2', text: 'love', correct: true },
                            { id: '6-3', text: 'loving', correct: false }
                        ]
                    },
                    {
                        group: 7,
                        options: [
                            { id: '7-1', text: 'is', correct: true },
                            { id: '7-2', text: 'am', correct: false },
                            { id: '7-3', text: 'are', correct: false }
                        ]
                    },
                    {
                        group: 8,
                        options: [
                            { id: '8-1', text: 'loves', correct: true },
                            { id: '8-2', text: 'love', correct: false },
                            { id: '8-3', text: 'loving', correct: false }
                        ]
                    },
                    {
                        group: 9,
                        options: [
                            { id: '9-1', text: 'is', correct: true },
                            { id: '9-2', text: 'are', correct: false },
                            { id: '9-3', text: 'am', correct: false }
                        ]
                    }
                ],
                next: 2107
            },
            {
                id: 2107,
                image: '画面07.jpg',
                text: "Arturo: Who (10) Soo-jin? She (11) familiar.",
                buttons: [
                    {
                        group: 10,
                        options: [
                            { id: '10-1', text: 'is', correct: true },
                            { id: '10-2', text: 'are', correct: false },
                            { id: '10-3', text: 'am', correct: false }
                        ]
                    },
                    {
                        group: 11,
                        options: [
                            { id: '11-1', text: 'looks', correct: true },
                            { id: '11-2', text: 'look', correct: false },
                            { id: '11-3', text: 'looking', correct: false }
                        ]
                    }
                ],
                next: 2108
            },
            {
                id: 2108,
                image: '画面08.jpg',
                text: "Alexa: She (12) my classmate. We (13) in the same business class. We (14) our class every Monday and Wednesday.",
                buttons: [
                    {
                        group: 12,
                        options: [
                            { id: '12-1', text: 'is', correct: false },
                            { id: '12-2', text: 'are', correct: true },
                            { id: '12-3', text: 'am', correct: false }
                        ]
                    },
                    {
                        group: 13,
                        options: [
                            { id: '13-1', text: 'is', correct: false },
                            { id: '13-2', text: 'are', correct: true },
                            { id: '13-3', text: 'am', correct: false }
                        ]
                    },
                    {
                        group: 14,
                        options: [
                            { id: '14-1', text: 'has', correct: false },
                            { id: '14-2', text: 'have', correct: true },
                            { id: '14-3', text: 'having', correct: false }
                        ]
                    }
                ],
                next: 2109
            },
            {
                id: 2109,
                image: '画面09.jpg',
                text: "Arturo: Where (15) she from?",
                buttons: [
                    {
                        group: 15,
                        options: [
                            { id: '15-1', text: 'is', correct: false },
                            { id: '15-2', text: 'are', correct: true },
                            { id: '15-3', text: 'am', correct: false }
                        ]
                    }
                ],
                next: 2110
            },
            {
                id: 2110,
                image: '画面10.jpg',
                text: "Alexa: South Korea. She (16) marketing. She (17) the classes (18) very interesting. Let's go and say hello. Sorry, what (19) your last name again? Vargas?",
                buttons: [
                    {
                        group: 16,
                        options: [
                            { id: '16-1', text: 'studies', correct: true },
                            { id: '16-2', text: 'study', correct: false },
                            { id: '16-3', text: 'studying', correct: false }
                        ]
                    },
                    {
                        group: 17,
                        options: [
                            { id: '17-1', text: 'says', correct: true },
                            { id: '17-2', text: 'say', correct: false },
                            { id: '17-3', text: 'saying', correct: false }
                        ]
                    },
                    {
                        group: 18,
                        options: [
                            { id: '18-1', text: 'is', correct: false },
                            { id: '18-2', text: 'are', correct: true },
                            { id: '18-3', text: 'am', correct: false }
                        ]
                    },
                    {
                        group: 19,
                        options: [
                            { id: '19-1', text: 'is', correct: true },
                            { id: '19-2', text: 'are', correct: false },
                            { id: '19-3', text: 'am', correct: false }
                        ]
                    }
                ],
                next: 2111
            },
            {
                id: 2111,
                image: '画面11.jpg',
                text: "Arturo: Actually, it (20) Valdez",
                buttons: [
                    {
                        group: 20,
                        options: [
                            { id: '20-1', text: 'is', correct: true },
                            { id: '20-2', text: 'are', correct: false },
                            { id: '20-3', text: 'am', correct: false }
                        ]
                    }
                ],
                next: 2112
            },
            {
                id: 2112,
                image: '画面12.jpg',
                text: "Alexa: How (21) you spell that?",
                buttons: [
                    {
                        group: 21,
                        options: [
                            { id: '21-1', text: 'is', correct: false },
                            { id: '21-2', text: 'are', correct: true },
                            { id: '21-3', text: 'am', correct: false }
                        ]
                    }
                ],
                next: 2113
            }
        ];

        // DOM元素
        const sceneImage = document.getElementById('scene-image');
        const dialogueText = document.getElementById('dialogue-text');
        const buttonsContainer = document.getElementById('buttons-container');
        const continueBtn = document.getElementById('continue-btn');
        const leaderboardScreen = document.getElementById('leaderboard-screen');
        const roomCodeDisplay = document.getElementById('room-code-display');
        const playerCountDisplay = document.getElementById('player-count-display');
        const leaderboardTable = document.getElementById('leaderboard-table');

        // 显示场景
        function showScene(sceneId) {
            const scene = scenes.find(s => s.id === sceneId);
            if (!scene) return;
            
            // 更新当前页面
            gameData.currentPage = sceneId;
            
            // 更新图片
            sceneImage.src = `images/${scene.image}`;
            sceneImage.classList.add('fade-in');
            
            // 更新文本
            dialogueText.textContent = scene.text;
            
            // 清除按钮容器
            buttonsContainer.innerHTML = '';
            
            // 创建按钮
            if (scene.buttons && scene.buttons.length > 0) {
                scene.buttons.forEach(buttonGroup => {
                    const groupDiv = document.createElement('div');
                    groupDiv.className = 'button-group';
                    
                    buttonGroup.options.forEach(option => {
                        const button = document.createElement('button');
                        button.textContent = option.text;
                        button.dataset.id = option.id;
                        button.dataset.correct = option.correct;
                        button.className = 'option-btn';
                        
                        // 如果之前已选择此选项，则高亮显示
                        if (gameData.selectedOptions[option.id]) {
                            button.classList.add('selected');
                            if (option.correct) {
                                button.classList.add('correct');
                            } else {
                                button.classList.add('incorrect');
                            }
                        }
                        
                        button.addEventListener('click', () => {
                            // 只能选择同一组中的一个选项
                            const groupButtons = groupDiv.querySelectorAll('.option-btn');
                            groupButtons.forEach(btn => {
                                btn.classList.remove('selected', 'correct', 'incorrect');
                            });
                            
                            // 标记选中的按钮
                            button.classList.add('selected');
                            if (option.correct) {
                                button.classList.add('correct');
                            } else {
                                button.classList.add('incorrect');
                            }
                            
                            // 保存选择
                            gameData.selectedOptions[option.id] = true;
                        });
                        
                        groupDiv.appendChild(button);
                    });
                    
                    buttonsContainer.appendChild(groupDiv);
                });
            }
            
            // 显示继续按钮
            continueBtn.style.display = 'block';
            
            // 更新数据库中的进度
            updateProgress();
            
            // 预加载下一张图片
            if (scene.next && scene.next !== 2113) {
                preloadNextImage(scene.next);
            }
        }

        // 预加载下一张图片
        function preloadNextImage(nextSceneId) {
            const nextScene = scenes.find(s => s.id === nextSceneId);
            if (nextScene) {
                const img = new Image();
                img.src = `images/${nextScene.image}`;
            }
        }

        // 更新进度到数据库
        async function updateProgress() {
            if (!firebaseInitialized || !roomCode || !playerId) return;
            
            try {
                // 计算进度百分比
                const progress = Math.floor((gameData.currentPage - 2100) / 12 * 100);
                
                // 更新数据库
                await db.collection('rooms').doc(roomCode).update({
                    [`players.${playerId}.progress`]: progress,
                    [`players.${playerId}.correctAnswers`]: gameData.correctAnswers
                });
            } catch (error) {
                console.error("Error updating progress:", error);
            }
        }

        // 计算得分
        function calculateScore() {
            // 计算时间分数（每分钟2分，不满一分钟按1分计算）
            const minutes = Math.floor(gameData.timeSpent / 60);
            const timeScore = minutes * 2 + (gameData.timeSpent % 60 > 0 ? 1 : 0);
            
            // 计算总分数 = 正确答案数 - 时间分数
            let totalScore = gameData.correctAnswers - timeScore;
            
            // 确保分数不为负
            totalScore = Math.max(0, totalScore);
            
            // 分数上限为100
            totalScore = Math.min(100, totalScore);
            
            return totalScore;
        }

        // 计算正确率
        function calculateAccuracy() {
            if (gameData.correctAnswers === 0) return 0;
            return (gameData.correctAnswers / 15 * 100).toFixed(1);
        }

        // 格式化时间
        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins}:${secs < 10 ? '0' : ''}${secs}`;
        }

        // 显示排行榜
        async function showLeaderboard() {
            if (isTeacher || !roomCode) {
                // 老师视图或无效房间，显示空排行榜
                leaderboardScreen.style.display = 'block';
                document.querySelector('.screen').style.display = 'none';
                roomCodeDisplay.textContent = roomCode || 'N/A';
                playerCountDisplay.textContent = '0';
                return;
            }
            
            try {
                // 获取房间数据
                const roomDoc = await db.collection('rooms').doc(roomCode).get();
                if (!roomDoc.exists) {
                    console.error("Room does not exist");
                    return;
                }
                
                const roomData = roomDoc.data();
                const players = roomData.players || {};
                
                // 更新房间信息
                roomCodeDisplay.textContent = roomCode;
                playerCountDisplay.textContent = roomData.playerCount || 0;
                
                // 准备玩家数据
                const playerArray = [];
                
                for (const [id, player] of Object.entries(players)) {
                    if (player.status === "finished") {
                        playerArray.push({
                            id: id,
                            nickname: player.nickname,
                            score: player.score || 0,
                            accuracy: player.accuracy || "0.0",
                            time: formatTime(player.timeSpent || 0),
                            isCurrentPlayer: id === playerId
                        });
                    }
                }
                
                // 按分数排序
                playerArray.sort((a, b) => b.score - a.score);
                
                // 只显示前10名
                const topPlayers = playerArray.slice(0, 10);
                
                // 更新排行榜表格
                const tbody = leaderboardTable.querySelector('tbody');
                tbody.innerHTML = '';
                
                topPlayers.forEach((player, index) => {
                    const row = document.createElement('tr');
                    if (player.isCurrentPlayer) {
                        row.classList.add('current-player');
                    }
                    
                    row.innerHTML = `
                        <td>${index + 1}</td>
                        <td>${player.nickname}</td>
                        <td>${player.score}</td>
                        <td>${player.accuracy}%</td>
                        <td>${player.time}</td>
                    `;
                    
                    tbody.appendChild(row);
                });
                
                // 显示排行榜
                leaderboardScreen.style.display = 'block';
                document.querySelector('.screen').style.display = 'none';
                
            } catch (error) {
                console.error("Error loading leaderboard:", error);
            }
        }

        // 更新玩家完成状态
        async function markPlayerAsFinished() {
            if (!firebaseInitialized || !roomCode || !playerId) return;
            
            try {
                // 计算最终分数和正确率
                const totalScore = calculateScore();
                const accuracy = calculateAccuracy();
                
                // 更新数据库
                await db.collection('rooms').doc(roomCode).update({
                    [`players.${playerId}.status`]: "finished",
                    [`players.${playerId}.score`]: totalScore,
                    [`players.${playerId}.accuracy`]: accuracy,
                    [`players.${playerId}.finishedAt`]: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // 显示排行榜
                showLeaderboard();
            } catch (error) {
                console.error("Error marking player as finished:", error);
            }
        }

        // 继续按钮事件
        continueBtn.addEventListener('click', () => {
            // 检查当前场景是否有按钮组
            const currentScene = scenes.find(s => s.id === gameData.currentPage);
            
            if (currentScene.buttons && currentScene.buttons.length > 0) {
                // 计算当前场景的得分
                let sceneScore = 0;
                
                currentScene.buttons.forEach(buttonGroup => {
                    buttonGroup.options.forEach(option => {
                        if (gameData.selectedOptions[option.id] && option.correct) {
                            sceneScore++;
                        }
                    });
                });
                
                // 更新总得分
                gameData.correctAnswers += sceneScore;
            }
            
            // 如果是最后一个场景，显示排行榜
            if (currentScene.next === 2113) {
                // 更新总用时
                gameData.timeSpent = Math.floor((Date.now() - gameData.startTime) / 1000);
                
                // 标记玩家为已完成
                markPlayerAsFinished();
            } else {
                // 显示下一个场景
                showScene(currentScene.next);
            }
        });

        // 初始化页面
        if (isTeacher) {
            // 老师直接看到排行榜
            showLeaderboard();
            
            // 设置定时更新排行榜
            setInterval(showLeaderboard, 3000);
        } else {
            // 玩家从第一场景开始
            showScene(2101);
        }

        // 图片加载完成后移除淡入效果
        sceneImage.addEventListener('load', () => {
            setTimeout(() => {
                sceneImage.classList.remove('fade-in');
            }, 500);
        });
    </script>
</body>
</html>
