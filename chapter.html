<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ëã±ËØ≠Êó∂ÊÄÅ‰πãÊóÖ - Ê∏∏Êàè</title>
    <link rel="stylesheet" href="style.css">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database-compat.js"></script>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üéÆ</text></svg>">
</head>
<body>
    <!-- Ê∏∏ÊàèÈ°µÈù¢ÂÆπÂô® -->
    <div id="game-container">
        <!-- È°µÈù¢Â∞ÜÂä®ÊÄÅÂä†ËΩΩÂà∞ËøôÈáå -->
    </div>
    
    <!-- ÊéíË°åÊ¶úÈ°µÈù¢ -->
    <div id="page-2113" class="page">
        <div class="ranking-header">
            <div class="room-info">
                <span>Room: <span id="room-number-display"></span></span>
                <span>Players: <span id="player-count-display">0</span></span>
            </div>
        </div>
        
        <div class="ranking-table-container">
            <table class="ranking-table">
                <thead>
                    <tr>
                        <th>Rank</th>
                        <th>Name</th>
                        <th>Score</th>
                        <th>Accuracy</th>
                        <th>Time</th>
                    </tr>
                </thead>
                <tbody id="ranking-body">
                    <!-- ÊéíË°åÊ¶úÊï∞ÊçÆÂ∞ÜÂä®ÊÄÅÂ°´ÂÖÖ -->
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // FirebaseÈÖçÁΩÆ
        const firebaseConfig = {
            apiKey: "AIzaSyDHRYTBU74r31MPYVAAnRMwKM76c_-BduQ",
            authDomain: "tetrisonline-ca400.firebaseapp.com",
            projectId: "tetrisonline-ca400",
            storageBucket: "tetrisonline-ca400.firebasestorage.app",
            messagingSenderId: "58207939196",
            appId: "1:58207939196:web:b34f403204096084ee37f9",
            measurementId: "G-GG7GNEQ718"
        };
        
        // ÂàùÂßãÂåñFirebase
        let firebaseApp;
        let database;
        
        try {
            firebaseApp = firebase.initializeApp(firebaseConfig);
            database = firebase.database();
            console.log("Firebase initialized successfully");
        } catch (error) {
            console.error("Firebase initialization error:", error);
            alert("Database connection failed. Please refresh and try again.");
        }
        
        // Ê∏∏ÊàèÁä∂ÊÄÅ
        const gameState = {
            currentPage: 2101,
            score: 0,
            startTime: null,
            elapsedTime: 0,
            selectedAnswers: {},
            playerData: {}
        };
        
        // ‰ªéURLËé∑ÂèñÂèÇÊï∞
        const urlParams = new URLSearchParams(window.location.search);
        const roomId = urlParams.get('room');
        const playerId = urlParams.get('player');
        const nickname = decodeURIComponent(urlParams.get('nickname') || '');
        const isTeacher = urlParams.get('teacher') === 'true';
        
        // È°µÈù¢Êï∞ÊçÆ
        const pages = {
            2101: {
                image: "ÁîªÈù¢01.jpg",
                text: "Arturo: Hello, I'm Arturo Valdez.",
                buttons: [],
                nextPage: 2102
            },
            2102: {
                image: "ÁîªÈù¢02.jpg",
                text: "Alexa: Hi. My name Ôºà1Ôºâ Alexandra Costa, but please Ôºà2Ôºâ me Alexa.",
                buttons: [
                    {
                        id: "1-1", options: [
                            { text: "is", correct: true },
                            { text: "am", correct: false },
                            { text: "are", correct: false }
                        ]
                    },
                    {
                        id: "2-1", options: [
                            { text: "calls", correct: false },
                            { text: "call", correct: true },
                            { text: "calling", correct: false }
                        ]
                    }
                ],
                nextPage: 2103
            },
            2103: {
                image: "ÁîªÈù¢03.jpg",
                text: "Arturo: OK. Where Ôºà3Ôºâ you from, Alexa?",
                buttons: [
                    {
                        id: "3-1", options: [
                            { text: "is", correct: false },
                            { text: "are", correct: true },
                            { text: "am", correct: false }
                        ]
                    }
                ],
                nextPage: 2104
            },
            2104: {
                image: "ÁîªÈù¢04.jpg",
                text: "Alexa: Brazil. How about you?",
                buttons: [],
                nextPage: 2105
            },
            2105: {
                image: "ÁîªÈù¢05.jpg",
                text: "Arturo: I'm from Mexico. I Ôºà4Ôºâ here in the city now, but my family Ôºà5Ôºâ in a small town near Guadalajara.",
                buttons: [
                    {
                        id: "4-1", options: [
                            { text: "lives", correct: true },
                            { text: "live", correct: false },
                            { text: "living", correct: false }
                        ]
                    },
                    {
                        id: "5-1", options: [
                            { text: "lives", correct: true },
                            { text: "live", correct: false },
                            { text: "are living", correct: false }
                        ]
                    }
                ],
                nextPage: 2106
            },
            2106: {
                image: "ÁîªÈù¢06.jpg",
                text: "Alexa: Oh, I Ôºà6Ôºâ Mexico! It Ôºà7Ôºâ really beautiful. My brother Ôºà8Ôºâ Mexico, too. Oh, good. Soo-jin Ôºà9Ôºâ here.",
                buttons: [
                    {
                        id: "6-1", options: [
                            { text: "loves", correct: false },
                            { text: "love", correct: true },
                            { text: "loving", correct: false }
                        ]
                    },
                    {
                        id: "7-1", options: [
                            { text: "is", correct: true },
                            { text: "am", correct: false },
                            { text: "are", correct: false }
                        ]
                    },
                    {
                        id: "8-1", options: [
                            { text: "loves", correct: true },
                            { text: "love", correct: false },
                            { text: "loving", correct: false }
                        ]
                    },
                    {
                        id: "9-1", options: [
                            { text: "is", correct: true },
                            { text: "are", correct: false },
                            { text: "am", correct: false }
                        ]
                    }
                ],
                nextPage: 2107
            },
            2107: {
                image: "ÁîªÈù¢07.jpg",
                text: "Arturo: Who Ôºà10Ôºâ Soo-jin? She Ôºà11Ôºâ familiar.",
                buttons: [
                    {
                        id: "10-1", options: [
                            { text: "is", correct: true },
                            { text: "are", correct: false },
                            { text: "am", correct: false }
                        ]
                    },
                    {
                        id: "11-1", options: [
                            { text: "looks", correct: true },
                            { text: "look", correct: false },
                            { text: "looking", correct: false }
                        ]
                    }
                ],
                nextPage: 2108
            },
            2108: {
                image: "ÁîªÈù¢08.jpg",
                text: "Alexa: She Ôºà12Ôºâ my classmate. We Ôºà13Ôºâ in the same business class. We Ôºà14Ôºâ our class every Monday and Wednesday.",
                buttons: [
                    {
                        id: "12-1", options: [
                            { text: "is", correct: false },
                            { text: "are", correct: true },
                            { text: "am", correct: false }
                        ]
                    },
                    {
                        id: "13-1", options: [
                            { text: "is", correct: false },
                            { text: "are", correct: true },
                            { text: "am", correct: false }
                        ]
                    },
                    {
                        id: "14-1", options: [
                            { text: "has", correct: false },
                            { text: "have", correct: true },
                            { text: "having", correct: false }
                        ]
                    }
                ],
                nextPage: 2109
            },
            2109: {
                image: "ÁîªÈù¢09.jpg",
                text: "Arturo: Where Ôºà15Ôºâ she from?",
                buttons: [
                    {
                        id: "15-1", options: [
                            { text: "is", correct: false },
                            { text: "are", correct: true },
                            { text: "am", correct: false }
                        ]
                    }
                ],
                nextPage: 2110
            },
            2110: {
                image: "ÁîªÈù¢10.jpg",
                text: "Alexa: South Korea. She Ôºà16Ôºâ marketing. She Ôºà17Ôºâ the classes Ôºà18Ôºâ very interesting. Let's go and say hello. Sorry, what Ôºà19Ôºâ your last name again? Vargas?",
                buttons: [
                    {
                        id: "16-1", options: [
                            { text: "studies", correct: true },
                            { text: "study", correct: false },
                            { text: "studying", correct: false }
                        ]
                    },
                    {
                        id: "17-1", options: [
                            { text: "says", correct: true },
                            { text: "say", correct: false },
                            { text: "saying", correct: false }
                        ]
                    },
                    {
                        id: "18-1", options: [
                            { text: "is", correct: false },
                            { text: "are", correct: true },
                            { text: "am", correct: false }
                        ]
                    },
                    {
                        id: "19-1", options: [
                            { text: "is", correct: true },
                            { text: "are", correct: false },
                            { text: "am", correct: false }
                        ]
                    }
                ],
                nextPage: 2111
            },
            2111: {
                image: "ÁîªÈù¢11.jpg",
                text: "Arturo: Actually, it Ôºà20Ôºâ Valdez",
                buttons: [
                    {
                        id: "20-1", options: [
                            { text: "is", correct: true },
                            { text: "are", correct: false },
                            { text: "am", correct: false }
                        ]
                    }
                ],
                nextPage: 2112
            },
            2112: {
                image: "ÁîªÈù¢12.jpg",
                text: "Alexa: How Ôºà21Ôºâ you spell that?",
                buttons: [
                    {
                        id: "21-1", options: [
                            { text: "is", correct: false },
                            { text: "are", correct: true },
                            { text: "am", correct: false }
                        ]
                    }
                ],
                nextPage: 2113
            }
        };
        
        // ÂàùÂßãÂåñÊ∏∏Êàè
        function initGame() {
            if (isTeacher) {
                // ËÄÅÂ∏àÁõ¥Êé•ËøõÂÖ•ÊéíË°åÊ¶úÈ°µÈù¢
                showRankingPage();
                startRankingUpdates();
            } else {
                // Áé©ÂÆ∂ÂºÄÂßãÊ∏∏Êàè
                gameState.startTime = Date.now();
                startGameTimer();
                showPage(2101);
            }
        }
        
        // ÊòæÁ§∫ÊåáÂÆöÈ°µÈù¢
        function showPage(pageId) {
            const pageData = pages[pageId];
            if (!pageData) {
                console.error("Page not found:", pageId);
                return;
            }
            
            gameState.currentPage = pageId;
            
            // ÂàõÂª∫È°µÈù¢HTML
            const pageHTML = `
                <div id="page-${pageId}" class="page active">
                    <img src="images/${pageData.image}" alt="Page ${pageId}" class="background-image">
                    <div class="text-content">${pageData.text}</div>
                    <div class="buttons-container">
                        ${renderButtons(pageData.buttons)}
                    </div>
                    <button class="continue-btn" onclick="continueToNextPage()">Continue</button>
                </div>
            `;
            
            // Êõ¥Êñ∞Ê∏∏ÊàèÂÆπÂô®
            document.getElementById('game-container').innerHTML = pageHTML;
            
            // Êõ¥Êñ∞Firebase‰∏≠ÁöÑÁé©ÂÆ∂ËøõÂ∫¶
            updatePlayerProgress();
            
            // È¢ÑÂä†ËΩΩ‰∏ã‰∏ÄÂº†ÂõæÁâá
            if (pageData.nextPage && pageData.nextPage !== 2113) {
                preloadImage(pages[pageData.nextPage].image);
            }
        }
        
        // Ê∏≤ÊüìÊåâÈíÆÁªÑ
        function renderButtons(buttonGroups) {
            if (buttonGroups.length === 0) return '';
            
            return buttonGroups.map(group => `
                <div class="button-group">
                    ${group.options.map(option => `
                        <button class="answer-btn" 
                                data-group="${group.id}" 
                                data-correct="${option.correct}"
                                onclick="selectAnswer(this, '${group.id}', ${option.correct})">
                            ${option.text}
                        </button>
                    `).join('')}
                </div>
            `).join('');
        }
        
        // ÈÄâÊã©Á≠îÊ°à
        function selectAnswer(button, groupId, isCorrect) {
            // È´ò‰∫ÆÈÄâ‰∏≠ÁöÑÊåâÈíÆ
            const group = button.parentElement;
            const buttons = group.querySelectorAll('.answer-btn');
            
            buttons.forEach(btn => {
                btn.classList.remove('selected');
            });
            
            button.classList.add('selected');
            
            // ‰øùÂ≠òÈÄâÊã©
            gameState.selectedAnswers[groupId] = isCorrect;
        }
        
        // ÁªßÁª≠Âà∞‰∏ã‰∏ÄÈ°µ
        function continueToNextPage() {
            const pageData = pages[gameState.currentPage];
            
            // ËÆ°ÁÆóÂΩìÂâçÈ°µÈù¢ÁöÑÂæóÂàÜ
            calculateScoreForCurrentPage();
            
            if (pageData.nextPage === 2113) {
                // Ê∏∏ÊàèÁªìÊùüÔºåÊòæÁ§∫ÊéíË°åÊ¶ú
                finishGame();
            } else {
                // ËΩ¨Âà∞‰∏ã‰∏ÄÈ°µ
                showPage(pageData.nextPage);
            }
        }
        
        // ËÆ°ÁÆóÂΩìÂâçÈ°µÈù¢ÁöÑÂæóÂàÜ
        function calculateScoreForCurrentPage() {
            const pageData = pages[gameState.currentPage];
            
            pageData.buttons.forEach(group => {
                if (gameState.selectedAnswers[group.id] === true) {
                    gameState.score++;
                }
            });
        }
        
        // ÂÆåÊàêÊ∏∏Êàè
        function finishGame() {
            // ËÆ°ÁÆóÊÄªÁî®Êó∂
            gameState.elapsedTime = Math.floor((Date.now() - gameState.startTime) / 1000);
            
            // ËÆ°ÁÆóÊó∂Èó¥ÂàÜÊï∞
            const timeScore = calculateTimeScore(gameState.elapsedTime);
            
            // ËÆ°ÁÆóÊÄªÂàÜ
            const totalScore = Math.min(gameState.score + timeScore, 100);
            
            // ËÆ°ÁÆóÊ≠£Á°ÆÁéá
            const accuracy = (gameState.score / 15 * 100).toFixed(1);
            
            // ‰øùÂ≠òÁé©ÂÆ∂Êï∞ÊçÆ
            savePlayerData(totalScore, accuracy, gameState.elapsedTime);
            
            // ÊòæÁ§∫ÊéíË°åÊ¶ú
            showRankingPage();
            
            // ÂºÄÂßãÊéíË°åÊ¶úÊõ¥Êñ∞
            startRankingUpdates();
        }
        
        // ËÆ°ÁÆóÊó∂Èó¥ÂàÜÊï∞
        function calculateTimeScore(seconds) {
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            
            // ÊØèÊª°‰∏ÄÂàÜÈíüÂæó2ÂàÜÔºå‰∏çÊª°‰∏ÄÂàÜÈíüÂæó1ÂàÜ
            return minutes * 2 + (remainingSeconds > 0 ? 1 : 0);
        }
        
        // ‰øùÂ≠òÁé©ÂÆ∂Êï∞ÊçÆÂà∞Firebase
        function savePlayerData(score, accuracy, time) {
            if (!database || !roomId || !playerId) return;
            
            const playerRef = database.ref('rooms/' + roomId + '/players/' + playerId);
            
            playerRef.set({
                nickname: nickname,
                score: score,
                accuracy: accuracy,
                time: time,
                finished: true,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            }).catch(error => {
                console.error("Error saving player data:", error);
            });
            
            // Êõ¥Êñ∞Áé©ÂÆ∂Êï∞Èáè
            updatePlayerCount();
        }
        
        // Êõ¥Êñ∞Áé©ÂÆ∂ËøõÂ∫¶Âà∞Firebase
        function updatePlayerProgress() {
            if (!database || !roomId || !playerId || isTeacher) return;
            
            const progress = Math.floor((gameState.currentPage - 2100) / 12 * 100);
            
            const playerRef = database.ref('rooms/' + roomId + '/players/' + playerId);
            
            playerRef.update({
                progress: progress,
                currentPage: gameState.currentPage,
                score: gameState.score,
                updatedAt: firebase.database.ServerValue.TIMESTAMP
            }).catch(error => {
                console.error("Error updating player progress:", error);
            });
        }
        
        // Êõ¥Êñ∞Áé©ÂÆ∂Êï∞Èáè
        function updatePlayerCount() {
            if (!database || !roomId) return;
            
            const playersRef = database.ref('rooms/' + roomId + '/players');
            
            playersRef.once('value').then(snapshot => {
                let count = 0;
                
                snapshot.forEach(childSnapshot => {
                    if (childSnapshot.val().finished) {
                        count++;
                    }
                });
                
                // Êõ¥Êñ∞Áé©ÂÆ∂ËÆ°Êï∞
                const roomRef = database.ref('rooms/' + roomId);
                roomRef.update({
                    playerCount: count
                }).catch(error => {
                    console.error("Error updating player count:", error);
                });
            }).catch(error => {
                console.error("Error getting players:", error);
            });
        }
        
        // ÊòæÁ§∫ÊéíË°åÊ¶úÈ°µÈù¢
        function showRankingPage() {
            document.getElementById('game-container').style.display = 'none';
            document.getElementById('page-2113').style.display = 'block';
            
            // ÊòæÁ§∫ÊàøÈó¥Âè∑
            document.getElementById('room-number-display').textContent = roomId;
        }
        
        // ÂºÄÂßãÊéíË°åÊ¶úÊõ¥Êñ∞
        function startRankingUpdates() {
            if (!database || !roomId) return;
            
            // Êõ¥Êñ∞Áé©ÂÆ∂Êï∞Èáè
            const playerCountRef = database.ref('rooms/' + roomId + '/playerCount');
            playerCountRef.on('value', (snapshot) => {
                const count = snapshot.val() || 0;
                document.getElementById('player-count-display').textContent = count;
            });
            
            // Êõ¥Êñ∞ÊéíË°åÊ¶ú
            const playersRef = database.ref('rooms/' + roomId + '/players');
            playersRef.on('value', (snapshot) => {
                updateRankingTable(snapshot);
            });
        }
        
        // Êõ¥Êñ∞ÊéíË°åÊ¶úË°®Ê†º
        function updateRankingTable(snapshot) {
            const rankingBody = document.getElementById('ranking-body');
            rankingBody.innerHTML = '';
            
            const players = [];
            
            snapshot.forEach(childSnapshot => {
                const player = childSnapshot.val();
                if (player.finished) {
                    players.push(player);
                }
            });
            
            // ÊåâÂàÜÊï∞ÊéíÂ∫è
            players.sort((a, b) => b.score - a.score);
            
            // Âè™ÊòæÁ§∫Ââç10Âêç
            const topPlayers = players.slice(0, 10);
            
            // Â°´ÂÖÖË°®Ê†º
            topPlayers.forEach((player, index) => {
                const row = document.createElement('tr');
                
                // Â¶ÇÊûúÊòØÂΩìÂâçÁé©ÂÆ∂ÔºåÈ´ò‰∫ÆÊòæÁ§∫
                if (player.nickname === nickname) {
                    row.classList.add('highlight');
                }
                
                // Ê†ºÂºèÂåñÊó∂Èó¥
                const minutes = Math.floor(player.time / 60);
                const seconds = player.time % 60;
                const timeFormatted = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${player.nickname}</td>
                    <td>${player.score}</td>
                    <td>${player.accuracy}%</td>
                    <td>${timeFormatted}</td>
                `;
                
                rankingBody.appendChild(row);
            });
            
            // Â¶ÇÊûúÊ≤°ÊúâÁé©ÂÆ∂ÔºåÊòæÁ§∫Á©∫Ë°å
            if (topPlayers.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = '<td colspan="5">No players have finished yet</td>';
                rankingBody.appendChild(row);
            }
        }
        
        // È¢ÑÂä†ËΩΩÂõæÁâá
        function preloadImage(imageName) {
            const img = new Image();
            img.src = 'images/' + imageName;
        }
        
        // Ê∏∏ÊàèËÆ°Êó∂Âô®
        function startGameTimer() {
            setInterval(() => {
                if (gameState.startTime && gameState.currentPage !== 2113) {
                    gameState.elapsedTime = Math.floor((Date.now() - gameState.startTime) / 1000);
                    
                    // ÊØè3ÁßíÊõ¥Êñ∞‰∏ÄÊ¨°ËøõÂ∫¶
                    updatePlayerProgress();
                }
            }, 3000);
        }
        
        // È°µÈù¢Âä†ËΩΩÂÆåÊàêÂêéÂàùÂßãÂåñÊ∏∏Êàè
        window.addEventListener('load', initGame);
        
        // ÂÖ®Â±ÄÂáΩÊï∞
        window.selectAnswer = selectAnswer;
        window.continueToNextPage = continueToNextPage;
    </script>
</body>
</html>
