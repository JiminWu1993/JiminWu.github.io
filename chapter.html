<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>English Tenses Journey - Game</title>
    <link rel="stylesheet" href="style.css">
    <!-- Firebase App (the core Firebase SDK) is always required and must be listed first -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app-compat.js"></script>
    <!-- Add Firebase products that you want to use -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database-compat.js"></script>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üìö</text></svg>">
</head>
<body>
    <!-- Ê∏∏ÊàèÈ°µÈù¢ÂÆπÂô® -->
    <div id="game-container">
        <!-- ÊâÄÊúâÊ∏∏ÊàèÈ°µÈù¢ -->
        <div id="page-2101" class="page">
            <img src="images/ÁîªÈù¢01.jpg" alt="Scene 1" class="background-image">
            <div class="text-container">
                <p>Arturo: Hello, I'm Arturo Valdez.</p>
            </div>
            <div class="button-container">
                <button class="continue-btn">Continue</button>
            </div>
        </div>

        <div id="page-2102" class="page">
            <img src="images/ÁîªÈù¢02.jpg" alt="Scene 2" class="background-image">
            <div class="text-container">
                <p>Alexa: Hi. My name <span class="blank">(1)</span> Alexandra Costa, but please <span class="blank">(2)</span> me Alexa.</p>
            </div>
            <div class="options-container">
                <div class="option-row">
                    <button class="option-btn" data-value="is" data-correct="true">is</button>
                    <button class="option-btn" data-value="am" data-correct="false">am</button>
                    <button class="option-btn" data-value="are" data-correct="false">are</button>
                </div>
                <div class="option-row">
                    <button class="option-btn" data-value="calls" data-correct="false">calls</button>
                    <button class="option-btn" data-value="call" data-correct="true">call</button>
                    <button class="option-btn" data-value="calling" data-correct="false">calling</button>
                </div>
            </div>
            <div class="button-container">
                <button class="continue-btn">Continue</button>
            </div>
        </div>

        <div id="page-2103" class="page">
            <img src="images/ÁîªÈù¢03.jpg" alt="Scene 3" class="background-image">
            <div class="text-container">
                <p>Arturo: OK. Where <span class="blank">(3)</span> you from, Alexa?</p>
            </div>
            <div class="options-container">
                <div class="option-row">
                    <button class="option-btn" data-value="is" data-correct="false">is</button>
                    <button class="option-btn" data-value="are" data-correct="true">are</button>
                    <button class="option-btn" data-value="am" data-correct="false">am</button>
                </div>
            </div>
            <div class="button-container">
                <button class="continue-btn">Continue</button>
            </div>
        </div>

        <div id="page-2104" class="page">
            <img src="images/ÁîªÈù¢04.jpg" alt="Scene 4" class="background-image">
            <div class="text-container">
                <p>Alexa: Brazil. How about you?</p>
            </div>
            <div class="button-container">
                <button class="continue-btn">Continue</button>
            </div>
        </div>

        <div id="page-2105" class="page">
            <img src="images/ÁîªÈù¢05.jpg" alt="Scene 5" class="background-image">
            <div class="text-container">
                <p>Arturo: I'm from Mexico. I <span class="blank">(4)</span> here in the city now, but my family <span class="blank">(5)</span> in a small town near Guadalajara.</p>
            </div>
            <div class="options-container">
                <div class="option-row">
                    <button class="option-btn" data-value="lives" data-correct="true">lives</button>
                    <button class="option-btn" data-value="live" data-correct="false">live</button>
                    <button class="option-btn" data-value="living" data-correct="false">living</button>
                </div>
                <div class="option-row">
                    <button class="option-btn" data-value="lives" data-correct="true">lives</button>
                    <button class="option-btn" data-value="live" data-correct="false">live</button>
                    <button class="option-btn" data-value="are living" data-correct="false">are living</button>
                </div>
            </div>
            <div class="button-container">
                <button class="continue-btn">Continue</button>
            </div>
        </div>

        <div id="page-2106" class="page">
            <img src="images/ÁîªÈù¢06.jpg" alt="Scene 6" class="background-image">
            <div class="text-container">
                <p>Alexa: Oh, I <span class="blank">(6)</span> Mexico! It <span class="blank">(7)</span> really beautiful. My brother <span class="blank">(8)</span> Mexico, too. Oh, good. Soo-jin <span class="blank">(9)</span> here.</p>
            </div>
            <div class="options-container">
                <div class="option-row">
                    <button class="option-btn" data-value="loves" data-correct="false">loves</button>
                    <button class="option-btn" data-value="love" data-correct="true">love</button>
                    <button class="option-btn" data-value="loving" data-correct="false">loving</button>
                </div>
                <div class="option-row">
                    <button class="option-btn" data-value="is" data-correct="true">is</button>
                    <button class="option-btn" data-value="am" data-correct="false">am</button>
                    <button class="option-btn" data-value="are" data-correct="false">are</button>
                </div>
                <div class="option-row">
                    <button class="option-btn" data-value="loves" data-correct="true">loves</button>
                    <button class="option-btn" data-value="love" data-correct="false">love</button>
                    <button class="option-btn" data-value="loving" data-correct="false">loving</button>
                </div>
                <div class="option-row">
                    <button class="option-btn" data-value="is" data-correct="true">is</button>
                    <button class="option-btn" data-value="are" data-correct="false">are</button>
                    <button class="option-btn" data-value="am" data-correct="false">am</button>
                </div>
            </div>
            <div class="button-container">
                <button class="continue-btn">Continue</button>
            </div>
        </div>

        <div id="page-2107" class="page">
            <img src="images/ÁîªÈù¢07.jpg" alt="Scene 7" class="background-image">
            <div class="text-container">
                <p>Arturo: Who <span class="blank">(10)</span> Soo-jin? She <span class="blank">(11)</span> familiar.</p>
            </div>
            <div class="options-container">
                <div class="option-row">
                    <button class="option-btn" data-value="is" data-correct="true">is</button>
                    <button class="option-btn" data-value="are" data-correct="false">are</button>
                    <button class="option-btn" data-value="am" data-correct="false">am</button>
                </div>
                <div class="option-row">
                    <button class="option-btn" data-value="looks" data-correct="true">looks</button>
                    <button class="option-btn" data-value="look" data-correct="false">look</button>
                    <button class="option-btn" data-value="looking" data-correct="false">looking</button>
                </div>
            </div>
            <div class="button-container">
                <button class="continue-btn">Continue</button>
            </div>
        </div>

        <div id="page-2108" class="page">
            <img src="images/ÁîªÈù¢08.jpg" alt="Scene 8" class="background-image">
            <div class="text-container">
                <p>Alexa: She <span class="blank">(12)</span> my classmate. We <span class="blank">(13)</span> in the same business class. We <span class="blank">(14)</span> our class every Monday and Wednesday.</p>
            </div>
            <div class="options-container">
                <div class="option-row">
                    <button class="option-btn" data-value="is" data-correct="false">is</button>
                    <button class="option-btn" data-value="are" data-correct="true">are</button>
                    <button class="option-btn" data-value="am" data-correct="false">am</button>
                </div>
                <div class="option-row">
                    <button class="option-btn" data-value="is" data-correct="false">is</button>
                    <button class="option-btn" data-value="are" data-correct="true">are</button>
                    <button class="option-btn" data-value="am" data-correct="false">am</button>
                </div>
                <div class="option-row">
                    <button class="option-btn" data-value="has" data-correct="false">has</button>
                    <button class="option-btn" data-value="have" data-correct="true">have</button>
                    <button class="option-btn" data-value="having" data-correct="false">having</button>
                </div>
            </div>
            <div class="button-container">
                <button class="continue-btn">Continue</button>
            </div>
        </div>

        <div id="page-2109" class="page">
            <img src="images/ÁîªÈù¢09.jpg" alt="Scene 9" class="background-image">
            <div class="text-container">
                <p>Arturo: Where <span class="blank">(15)</span> she from?</p>
            </div>
            <div class="options-container">
                <div class="option-row">
                    <button class="option-btn" data-value="is" data-correct="false">is</button>
                    <button class="option-btn" data-value="are" data-correct="true">are</button>
                    <button class="option-btn" data-value="am" data-correct="false">am</button>
                </div>
            </div>
            <div class="button-container">
                <button class="continue-btn">Continue</button>
            </div>
        </div>

        <div id="page-2110" class="page">
            <img src="images/ÁîªÈù¢10.jpg" alt="Scene 10" class="background-image">
            <div class="text-container">
                <p>Alexa: South Korea. She <span class="blank">(16)</span> marketing. She <span class="blank">(17)</span> the classes <span class="blank">(18)</span> very interesting. Let's go and say hello. Sorry, what <span class="blank">(19)</span> your last name again? Vargas?</p>
            </div>
            <div class="options-container">
                <div class="option-row">
                    <button class="option-btn" data-value="studies" data-correct="true">studies</button>
                    <button class="option-btn" data-value="study" data-correct="false">study</button>
                    <button class="option-btn" data-value="studying" data-correct="false">studying</button>
                </div>
                <div class="option-row">
                   ÊûÅÁÆÄ
                    <button class="option-btn" data-value="says" data-correct="true">says</button>
                    <button class="option-btn"ÊûÅÁÆÄ data-value="say" data-correct="false">say</button>
                    <button class="option-btn" data-value="saying" data-correct="false">saying</button>
                </div>
                <div class="option-row">
                    <button class="option-btn" data-value="is" data-correct="false">is</button>
                    <button class="option-btn" data-value="are" data-correct="true">are</button>
                    <button class="ÊûÅÁÆÄoption-btn" data-value="am" data-correct="false">am</button>
                </div>
                <div class="option-row">
                    <button class="option-btn" data-value="is" data-correct="true">is</button>
                    <button class="option-btn" data-value="are" data-correct="false">are</button>
                    <button class="option-btn" data-value="am" data-correct="false">am</button>
                </div>
            </div>
            <div class="button-container">
                <button class="continue-btn">Continue</button>
            </div>
        </div>

        <div id="page-2111" class="page">
            <img src="images/ÁîªÈù¢11.jpg" alt="Scene 11" class="background-image">
            <div class="text-container">
                <p>Arturo: Actually, it <span class="blank">(20)</span> Valdez</p>
            </div>
            <div class="options-container">
                <div class="option-row">
                    <button class="option-btn" data-value="is" dataÊûÅÁÆÄ-correct="true">is</button>
                    <button class="option-btn" data-value="are" data-correct="false">are</button>
                    <button class="option-btn" data-value="am" data-correct="false">am</button>
                </div>
            </div>
            <div class="button-container">
                <button class="continue-btn">Continue</button>
            </div>
        </div>

        <div id="page-2112" class="page">
            <img src="images/ÁîªÈù¢12.jpg" alt="Scene 12" class="background-image">
            <div class="text-container">
                <p>Alexa: How <span class="blank">(21)</span> you spell that?</p>
            </div>
            <div class="options-container">
                <div class="option-row">
                    <button class="option-btn" data-value="is" data-correct="false">is</button>
                    <button class="option-btn" data-value="are" data-correct="true">are</button>
                    <button class="option-btn" data-value="am" data-correct="false">am</button>
                </ÊûÅÁÆÄdiv>
            </div>
            <div class="button-container">
                <button class="continue-btn">Continue</button>
            </div>
        </div>

        <!-- ÊéíÂêçÁîªÈù¢ (È°µÈù¢ID:2113) -->
        <div id="page-2113" class="page">
            <div class="ranking-header">
                <div class="room-info">
                    <p>Room: <span id="room-number">000000</span></p>
                    <p>Players: <span id="player-count">0</span></p>
                </div>
            </div>
            <div class="ranking-container">
                <table id="ranking-table">
                    <thead>
                        <tr>
                            <th>Rank</th>
                            <th>Name</th>
                            <th>Score</th>
                            <th>Accuracy</th>
                            <th>Time</th>
                        </tr>
                    </thead>
                    <tbody id="ranking-body">
                        <!-- ÊéíË°åÊ¶úÊï∞ÊçÆÂ∞ÜÈÄöËøáJavaScriptÂä®ÊÄÅÂ°´ÂÖÖ -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- ÊèêÁ§∫‰ø°ÊÅØÊ®°ÊÄÅÊ°Ü -->
    <div id="message-modal" class="modal">
        <div class="modal-content">
            <p id="message-text"></p>
        </div>
    </div>

    <script>
        // FirebaseÈÖçÁΩÆ
        const firebaseConfig = {
            apiKey: "AIzaSyDHRYTBU74r31ÊûÅÁÆÄMPYVAAnRMwKM76c_-BduQ",
            authDomain: "tetrisonline-ca400.firebaseapp.com",
            projectId: "tetrisonline-ca400",
            storageBucket: "tetrisonline-ca400.firebasestorage.app",
            messagingSenderId: "58207939196",
            appId: "1:58207939196:web:b34f403204096084ee37f9",
            measurementId: "G-GG7GNEQ718"
        };

        // ÂàùÂßãÂåñFirebase
        let firebaseInitialized = false;
        try {
            firebase.initializeApp(firebaseConfig);
            firebaseInitialized = true;
            console.log("Firebase initialized successfully");
        } catch (error) {
            console.error("Firebase initialization error:", error);
            alert("Failed to initialize the game. Please refresh the page.");
        }

        // ÂÖ®Â±ÄÂèòÈáè
        let currentPage = 2101;
        let roomCode = null;
        let playerId = null;
        let nickname = null;
        let isTeacher = false;
        let startTime = null;
        let correctAnswers = 0;
        let selectedOptions = {};
        let updateInterval = null;

        // DOMÂÖÉÁ¥†
        const gameContainer = document.getElementById('game-container');
        const messageModal = document.getElementById('message-modal');
        const messageText = document.getElementById('message-text');
        const roomNumberSpan = document.getElementById('room-number');
        const playerCountSpan = document.getElementById('player-count');
        const rankingBody = document.getElementById('ranking-body');

        // ÊòæÁ§∫Ê∂àÊÅØÊèêÁ§∫
        function showMessage(message, duration = 3000) {
            messageText.textContent = message;
            messageModal.style.display = 'flex';
            
            if (duration > 0) {
                setTimeout(() => {
                    messageModal.style.display = 'none';
                }, duration);
            }
        }

        // ÈöêËóèÊ∂àÊÅØÊèêÁ§∫
        function hideMessage() {
            messageModal.style.display = 'none';
        }

        // ÊòæÁ§∫ÊåáÂÆöÈ°µÈù¢
        function showPage(pageId) {
            // ÈöêËóèÊâÄÊúâÈ°µÈù¢
            const pages = document.querySelectorAll('.page');
            pages.forEach(page => {
                page.classList.remove('active');
            });
            
            // ÊòæÁ§∫ÊåáÂÆöÈ°µÈù¢
            const targetPage = document.getElementById('page-' + pageId);
            if (targetPage) {
                targetPage.classList.add('active');
                currentPage = pageId;
                
                // Êõ¥Êñ∞Firebase‰∏≠ÁöÑËøõÂ∫¶
                updateProgress();
                
                // È¢ÑÂä†ËΩΩ‰∏ã‰∏ÄÂº†ÂõæÁâá
                if (pageId < 2112) {
                    preloadNextImage(parseInt(pageId) + 1);
                }
            }
        }

        // È¢ÑÂä†ËΩΩ‰∏ã‰∏ÄÂº†ÂõæÁâá
        function preloadNextImage(nextPageId) {
            if (nextPageId > 2112) return;
            
            const imageName = 'ÁîªÈù¢' + (nextPageId - 2100).toString().padStart(2, '0') + '.jpg';
            const img = new Image();
            img.src = 'images/' + imageName;
        }

        // ÂàùÂßãÂåñÈÄâÈ°πÊåâÈíÆ
        function initOptionButtons() {
            const optionButtons = document.querySelectorAll('.option-btn');
            optionButtons.forEach(button => {
                button.addEventListener('click', function() {
                    // Ëé∑ÂèñÊâÄÂú®ÁöÑË°å
                    const row = this.parentElement;
                    
                    // ÂèñÊ∂àÂêåË°å‰∏≠ÂÖ∂‰ªñÊåâÈíÆÁöÑÈÄâ‰∏≠Áä∂ÊÄÅ
                    const siblings = row.querySelectorAll('.option-btn');
                    siblings.forEach(btn => {
                        btn.classList.remove('selected');
                    });
                    
                    // ËÆæÁΩÆÂΩìÂâçÊåâÈíÆ‰∏∫ÈÄâ‰∏≠Áä∂ÊÄÅ
                    this.classList.add('selected');
                    
                    // ‰øùÂ≠òÈÄâÊã©
                    const pageId = this.closest('.page').id.replace('page-', '');
                    const blankIndex = Array.from(row.parentElement.children).indexOf(row) + 1;
                    selectedOptions[pageId + '-' + blankIndex] = {
                        value: this.dataset.value,
                        correct: this.dataset.correct === 'true'
                    };
                });
            });
        }

        // ÂàùÂßãÂåñÁªßÁª≠ÊåâÈíÆ
        function initContinueButtons() {
            const continueButtons = document.querySelectorAll('.continue-btn');
            continueButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const currentPageId = this.closest('.page').id.replace('page-', '');
                    
                    // Ê£ÄÊü•ÊòØÂê¶ÊòØÊéíÂêçÈ°µÈù¢
                    if (currentPageId === '2113') {
                        return; // ÊéíÂêçÈ°µÈù¢Ê≤°Êúâ‰∏ã‰∏ÄÈ°µ
                    }
                    
                    // Ê£ÄÊü•ÊòØÂê¶ÊúâÈÄâÈ°πÈúÄË¶ÅËØÑÂàÜ
                    if (currentPageId !== '2101' && currentPageId !== '2104') {
                        const pageOptions = Object.keys(selectedOptions).filter(key => key.startsWith(currentPageId + '-'));
                        
                        // ËÆ°ÁÆóÊú¨È°µÂæóÂàÜ
                        let pageScore = 0;
                        pageOptions.forEach(key => {
                            if (selectedOptions[key].correct) {
                                pageScore++;
                            }
                        });
                        
                        // Êõ¥Êñ∞ÊÄªÂæóÂàÜ
                        correctAnswers += pageScore;
                    }
                    
                    // ÂâçËøõÂà∞‰∏ã‰∏ÄÈ°µ
                    const nextPageId = parseInt(currentPageId) + 1;
                    
                    // Â¶ÇÊûúÊòØÊúÄÂêé‰∏ÄÈ°µÔºåËÆ°ÁÆóÊúÄÁªàÂæóÂàÜÂπ∂Ë∑≥ËΩ¨Âà∞ÊéíÂêç
                    if (nextPageId === 2113) {
                        finishGame();
                    } else {
                        showPage(nextPageId);
                    }
                });
            });
        }

        // ËÆ°ÁÆóÊó∂Èó¥ÂàÜÊï∞
        function calculateTimeScore() {
            if (!startTime) return 0;
            
            const endTime = Date.now();
            const timeSpent = Math.floor((endTime - startTime) / 1000); // Áßí
            const minutes = Math.floor(timeSpent / 60);
            const seconds = timeSpent % 60;
            
            // ÊØèÊª°‰∏ÄÂàÜÈíüÂæó2ÂàÜÔºå‰∏çÊª°‰∏ÄÂàÜÈíüÂæó1ÂàÜ
            let timeScore = minutes * 2;
            if (seconds > 0) {
                timeScore += 1;
            }
            
            return timeScore;
        }

        // ËÆ°ÁÆóÊÄªÂàÜ
        function calculateTotalScore() {
            const timeScore = calculateTimeScore();
            let totalScore = correctAnswers + timeScore;
            
            // ÊÄªÂàÜ‰∏çË∂ÖËøá100
            if (totalScore > 100) {
                totalScore = 100;
            }
            
            return totalScore;
        }

        // ËÆ°ÁÆóÊ≠£Á°ÆÁéá
        function calculateAccuracy() {
            return (correctAnswers / 15 * 100).toFixed(1);
        }

        // Êõ¥Êñ∞Firebase‰∏≠ÁöÑËøõÂ∫¶
        function updateProgress() {
            if (!firebaseInitialized || !roomCode || !playerId || isTeacher) return;
            
            try {
                const database = firebase.database();
                const playerRef = database.ref('rooms/' + roomCode + '/players/' + playerId);
                
                // ËÆ°ÁÆóËøõÂ∫¶ÁôæÂàÜÊØî
                const progress = Math.floor((currentPage - 2101) / 12 * 100);
                
                // Êõ¥Êñ∞Êó∂Èó¥
                const timeSpent = startTime ? Math.floor((Date.now() - startTime) / 1000) : 0;
                
                playerRef.update({
                    progress: progress,
                    correctAnswers: correctAnswers,
                    timeSpent: timeSpent,
                    status: currentPage === 2113 ? 'finished' : 'playing'
                });
            } catch (error) {
                console.error("Error updating progress:", error);
            }
        }

        // ÂÆåÊàêÊ∏∏Êàè
        function finishGame() {
            if (!firebaseInitialized || !roomCode || !playerId || isTeacher) return;
            
            try {
                const database = firebase.database();
                const playerRef = database.ref('rooms/' + roomCode + '/players/' + playerId);
                
                // ËÆ°ÁÆóÊúÄÁªàÊï∞ÊçÆ
                const timeSpent = Math.floor((Date.now() - startTime) / 1000);
                const totalScore = calculateTotalScore();
                const accuracy = calculateAccuracy();
                
                playerRef.update({
                    status: 'finished',
                    progress: 100,
                    correctAnswers: correctAnswers,
                    timeSpent: timeSpent,
                    totalScore: totalScore,
                    accuracy: accuracy,
                    finishedAt: firebase.database.ServerValue.TIMESTAMP
                });
                
                // ÂÅúÊ≠¢ÂÆöÊó∂Êõ¥Êñ∞
                if (updateInterval) {
                    clearInterval(updateInterval);
                }
                
                // ÊòæÁ§∫ÊéíÂêçÈ°µÈù¢
                showPage(2113);
            } catch (error) {
                console.error("Error finishing game:", error);
                showMessage("Error finishing game. Please try again.");
            }
        }

        // Êõ¥Êñ∞ÊéíÂêçÊï∞ÊçÆ
        function updateRankingData() {
            if (!firebaseInitialized || !roomCode) return;
            
            try {
                const database = firebase.database();
                const roomRef = database.ref('rooms/' + roomCode);
                
                roomRef.once('value').then(snapshot => {
                    if (snapshot.exists()) {
                        const roomData = snapshot.val();
                        
                        // Êõ¥Êñ∞ÊàøÈó¥‰ø°ÊÅØ
                        roomNumberSpan.textContent = roomCode;
                        playerCountSpan.textContent = roomData.playerCount || 0;
                        
                        // Êõ¥Êñ∞ÊéíË°åÊ¶ú
                        const players = roomData.players || {};
                        const playerArray = [];
                        
                        Object.keys(players).forEach(key => {
                            if (players[key].status === 'finished') {
                                playerArray.push({
                                    id: key,
                                    nickname: players[key].nickname,
                                    totalScore: players[key].totalScore || 0,
                                    accuracy: players[key].accuracy || '0.0',
                                    timeSpent: players[key].timeSpent || 0
                                });
                            }
                        });
                        
                        // ÊåâÊÄªÂàÜÊéíÂ∫è
                        playerArray.sort((a, b) => b.totalScore - a.totalScore);
                        
                        // Êõ¥Êñ∞ÊéíË°åÊ¶úHTML
                        rankingBody.innerHTML = '';
                        playerArray.slice(0, 10).forEach((player, index) => {
                            const row = document.createElement('tr');
                            
                            // È´ò‰∫ÆÊòæÁ§∫ÂΩìÂâçÁé©ÂÆ∂
                            if (player.id === playerId) {
                                row.classList.add('highlight');
                            }
                            
                            // Ê†ºÂºèÂåñÊó∂Èó¥
                            const minutes = Math.floor(player.timeSpent / 60);
                            const seconds = player.timeSpent % 60;
                            const timeFormatted = `${minutes}m ${seconds}s`;
                            
                            row.innerHTML = `
                                <td>${index + 1}</td>
                                <td>${player.nickname}</td>
                                <td>${player.totalScore}</td>
                                <td>${player.accuracy}%</td>
                                <td>${timeFormatted}</td>
                            `;
                            
                            rankingBody.appendChild(row);
                        });
                    }
                });
            } catch (error) {
                console.error("Error updating ranking data:", error);
            }
        }

        // ÂàùÂßãÂåñÊ∏∏Êàè
        function initGame() {
            // Ëß£ÊûêURLÂèÇÊï∞
            const urlParams = new URLSearchParams(window.location.search);
            roomCode = urlParams.get('room');
            playerId = urlParams.get('player');
            nickname = urlParams.get('nickname');
            isTeacher = urlParams.has('teacher');
            
            if (!roomCode) {
                showMessage("Room code not found. Redirecting to home page.");
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 2000);
                return;
            }
            
            // Â¶ÇÊûúÊòØËÄÅÂ∏àÔºåÁõ¥Êé•ÊòæÁ§∫ÊéíÂêçÈ°µÈù¢
            if (isTeacher) {
                showPage(2113);
                // ËÆæÁΩÆÂÆöÊó∂Êõ¥Êñ∞ÊéíÂêçÊï∞ÊçÆ
                updateInterval = setInterval(updateRankingData, 3000);
                updateRankingData();
                return;
            }
            
            // Â¶ÇÊûúÊòØÁé©ÂÆ∂ÔºåÂàùÂßãÂåñÊ∏∏Êàè
            if (playerId && nickname) {
                nickname = decodeURIComponent(nickname);
                startTime = Date.now();
                
                // ÂàùÂßãÂåñÈÄâÈ°πÊåâÈíÆÂíåÁªßÁª≠ÊåâÈíÆ
                initOptionButtons();
                initContinueButtons();
                
                // ÊòæÁ§∫Á¨¨‰∏ÄÈ°µ
                showPage(2101);
                
                // ËÆæÁΩÆÂÆöÊó∂Êõ¥Êñ∞ËøõÂ∫¶
                updateInterval = setInterval(() => {
                    updateProgress();
                    updateRankingData();
                }, 3000);
            } else {
                showMessage("Player information not found. Redirecting to home page.");
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 2000);
            }
        }

        // È°µÈù¢Âä†ËΩΩÂÆåÊàêÂêéÂàùÂßãÂåñÊ∏∏Êàè
        window.addEventListener('load', initGame);
    </script>
</body>
</html>
