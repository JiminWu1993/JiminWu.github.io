<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è‹±è¯­æ—¶æ€ä¹‹æ—… - æ¸¸æˆ</title>
    <link rel="stylesheet" href="style.css">
    <!-- Firebase App (the core Firebase SDK) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <!-- Firebase Database -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ“š</text></svg>">
</head>
<body>
    <!-- æ¸¸æˆé¡µé¢å®¹å™¨ -->
    <div id="game-container">
        <!-- æ‰€æœ‰æ¸¸æˆç”»é¢å°†åŠ¨æ€åŠ è½½åˆ°è¿™é‡Œ -->
    </div>

    <script>
        // Firebaseé…ç½®
        const firebaseConfig = {
            apiKey: "AIzaSyDHRYTBU74r31MPYVAAnRMwKM76c_-BduQ",
            authDomain: "tetrisonline-ca400.firebaseapp.com",
            projectId: "tetrisonline-ca400",
            storageBucket: "tetrisonline-ca400.firebasestorage.app",
            messagingSenderId: "58207939196",
            appId: "1:58207939196:web:b34f403204096084ee37f9",
            measurementId: "G-GG7GNEQ718"
        };

        // åˆå§‹åŒ–Firebase
        let firebaseInitialized = false;
        try {
            firebase.initializeApp(firebaseConfig);
            firebaseInitialized = true;
            console.log("Firebase initialized successfully");
        } catch (error) {
            console.error("Firebase initialization error:", error);
            alert("Failed to initialize the game. Please refresh the page and try again.");
        }

        // å…¨å±€å˜é‡
        let currentPage = 2101;
        let roomId = null;
        let playerId = null;
        let isTeacher = false;
        let selectedAnswers = {};
        let playerData = {
            correctAnswers: 0,
            startTime: Date.now(),
            progress: 0,
            finished: false
        };
        let preloadedImages = {};

        // é¡µé¢æ•°æ®å®šä¹‰
        const pageData = {
            2101: {
                image: "ç”»é¢01.jpg",
                text: "Arturo: Hello, I'm Arturo Valdez.",
                buttons: [],
                nextPage: 2102
            },
            2102: {
                image: "ç”»é¢02.jpg",
                text: "Alexa: Hi. My name ï¼ˆ1ï¼‰ Alexandra Costa, but please ï¼ˆ2ï¼‰ me Alexa.",
                buttons: [
                    {
                        id: "1",
                        options: [
                            { text: "is", correct: true },
                            { text: "am", correct: false },
                            { text: "are", correct: false }
                        ]
                    },
                    {
                        id: "2",
                        options: [
                            { text: "calls", correct: false },
                            { text: "call", correct: true },
                            { text: "calling", correct: false }
                        ]
                    }
                ],
                nextPage: 2103
            },
            2103: {
                image: "ç”»é¢03.jpg",
                text: "Arturo: OK. Where ï¼ˆ3ï¼‰ you from, Alexa?",
                buttons: [
                    {
                        id: "3",
                        options: [
                            { text: "is", correct: false },
                            { text: "are", correct: true },
                            { text: "am", correct: false }
                        ]
                    }
                ],
                nextPage: 2104
            },
            2104: {
                image: "ç”»é¢04.jpg",
                text: "Alexa: Brazil. How about you?",
                buttons: [],
                nextPage: 2105
            },
            2105: {
                image: "ç”»é¢05.jpg",
                text: "Arturo: I'm from Mexico. I ï¼ˆ4ï¼‰ here in the city now, but my family ï¼ˆ5ï¼‰ in a small town near Guadalajara.",
                buttons: [
                    {
                        id: "4",
                        options: [
                            { text: "lives", correct: true },
                            { text: "live", correct: false },
                            { text: "living", correct: false }
                        ]
                    },
                    {
                        id: "5",
                        options: [
                            { text: "lives", correct: true },
                            { text: "live", correct: false },
                            { text: "are living", correct: false }
                        ]
                    }
                ],
                nextPage: 2106
            },
            2106: {
                image: "ç”»é¢06.jpg",
                text: "Alexa: Oh, I ï¼ˆ6ï¼‰ Mexico! It ï¼ˆ7ï¼‰ really beautiful. My brother ï¼ˆ8ï¼‰ Mexico, too. Oh, good. Soo-jin ï¼ˆ9ï¼‰ here.",
                buttons: [
                    {
                        id: "6",
                        options: [
                            { text: "loves", correct: false },
                            { text: "love", correct: true },
                            { text: "loving", correct: false }
                        ]
                    },
                    {
                        id: "7",
                        options: [
                            { text: "is", correct: true },
                            { text: "am", correct: false },
                            { text: "are", correct: false }
                        ]
                    },
                    {
                        id: "8",
                        options: [
                            { text: "loves", correct: true },
                            { text: "love", correct: false },
                            { text: "loving", correct: false }
                        ]
                    },
                    {
                        id: "9",
                        options: [
                            { text: "is", correct: true },
                            { text: "are", correct: false },
                            { text: "am", correct: false }
                        ]
                    }
                ],
                nextPage: 2107
            },
            2107: {
                image: "ç”»é¢07.jpg",
                text: "Arturo: Who ï¼ˆ10ï¼‰ Soo-jin? She ï¼ˆ11ï¼‰ familiar.",
                buttons: [
                    {
                        id: "10",
                        options: [
                            { text: "is", correct: true },
                            { text: "are", correct: false },
                            { text: "am", correct: false }
                        ]
                    },
                    {
                        id: "11",
                        options: [
                            { text: "looks", correct: true },
                            { text: "look", correct: false },
                            { text: "looking", correct: false }
                        ]
                    }
                ],
                nextPage: 2108
            },
            2108: {
                image: "ç”»é¢08.jpg",
                text: "Alexa: She ï¼ˆ12ï¼‰ my classmate. We ï¼ˆ13ï¼‰ in the same business class. We ï¼ˆ14ï¼‰ our class every Monday and Wednesday.",
                buttons: [
                    {
                        id: "12",
                        options: [
                            { text: "is", correct: false },
                            { text: "are", correct: true },
                            { text: "am", correct: false }
                        ]
                    },
                    {
                        id: "13",
                        options: [
                            { text: "is", correct: false },
                            { text: "are", correct: true },
                            { text: "am", correct: false }
                        ]
                    },
                    {
                        id: "14",
                        options: [
                            { text: "has", correct: false },
                            { text: "have", correct: true },
                            { text: "having", correct: false }
                        ]
                    }
                ],
                nextPage: 2109
            },
            2109: {
                image: "ç”»é¢09.jpg",
                text: "Arturo: Where ï¼ˆ15ï¼‰ she from?",
                buttons: [
                    {
                        id: "15",
                        options: [
                            { text: "is", correct: false },
                            { text: "are", correct: true },
                            { text: "am", correct: false }
                        ]
                    }
                ],
                nextPage: 2110
            },
            2110: {
                image: "ç”»é¢10.jpg",
                text: "Alexa: South Korea. She ï¼ˆ16ï¼‰ marketing. She ï¼ˆ17ï¼‰ the classes ï¼ˆ18ï¼‰ very interesting. Let's go and say hello. Sorry, what ï¼ˆ19ï¼‰ your last name again? Vargas?",
                buttons: [
                    {
                        id: "16",
                        options: [
                            { text: "studies", correct: true },
                            { text: "study", correct: false },
                            { text: "studying", correct: false }
                        ]
                    },
                    {
                        id: "17",
                        options: [
                            { text: "says", correct: true },
                            { text: "say", correct: false },
                            { text: "saying", correct: false }
                        ]
                    },
                    {
                        id: "18",
                        options: [
                            { text: "is", correct: false },
                            { text: "are", correct: true },
                            { text: "am", correct: false }
                        ]
                    },
                    {
                        id: "19",
                        options: [
                            { text: "is", correct: true },
                            { text: "are", correct: false },
                            { text: "am", correct: false }
                        ]
                    }
                ],
                nextPage: 2111
            },
            2111: {
                image: "ç”»é¢11.jpg",
                text: "Arturo: Actually, it ï¼ˆ20ï¼‰ Valdez",
                buttons: [
                    {
                        id: "20",
                        options: [
                            { text: "is", correct: true },
                            { text: "are", correct: false },
                            { text: "am", correct: false }
                        ]
                    }
                ],
                nextPage: 2112
            },
            2112: {
                image: "ç”»é¢12.jpg",
                text: "Alexa: How ï¼ˆ21ï¼‰ you spell that?",
                buttons: [
                    {
                        id: "21",
                        options: [
                            { text: "is", correct: false },
                            { text: "are", correct: true },
                            { text: "am", correct: false }
                        ]
                    }
                ],
                nextPage: 2113
            }
        };

        // åˆå§‹åŒ–æ¸¸æˆ
        document.addEventListener('DOMContentLoaded', function() {
            // è·å–URLå‚æ•°
            const urlParams = new URLSearchParams(window.location.search);
            roomId = urlParams.get('room');
            playerId = urlParams.get('player');
            isTeacher = urlParams.get('teacher') === 'true';
            
            if (!roomId) {
                alert("Invalid room. Redirecting to start page.");
                window.location.href = "index.html";
                return;
            }
            
            if (isTeacher) {
                // è€å¸ˆç›´æ¥æ˜¾ç¤ºæ’è¡Œæ¦œ
                showLeaderboard();
                startLeaderboardUpdates();
            } else if (!playerId) {
                alert("Invalid player. Redirecting to start page.");
                window.location.href = "index.html";
                return;
            } else {
                // ç©å®¶åŠ è½½æ¸¸æˆ
                loadPlayerData();
                loadPage(currentPage);
                preloadNextImage(currentPage + 1);
            }
        });

        // åŠ è½½ç©å®¶æ•°æ®
        function loadPlayerData() {
            if (!firebaseInitialized) return;
            
            const db = firebase.database();
            const playerRef = db.ref('rooms/' + roomId + '/players/' + playerId);
            
            playerRef.once('value')
                .then((snapshot) => {
                    if (snapshot.exists()) {
                        playerData = snapshot.val();
                    }
                })
                .catch((error) => {
                    console.error("Error loading player data:", error);
                });
        }

        // åŠ è½½é¡µé¢
        function loadPage(pageId) {
            const page = pageData[pageId];
            if (!page) {
                if (pageId === 2113) {
                    showLeaderboard();
                    startLeaderboardUpdates();
                }
                return;
            }
            
            const gameContainer = document.getElementById('game-container');
            
            // åˆ›å»ºé¡µé¢å…ƒç´ 
            const pageElement = document.createElement('div');
            pageElement.className = 'page';
            pageElement.id = `page-${pageId}`;
            
            // æ·»åŠ å›¾ç‰‡
            const img = document.createElement('img');
            img.src = `images/${page.image}`;
            img.alt = `Page ${pageId}`;
            img.className = 'background-image fade-in';
            pageElement.appendChild(img);
            
            // æ·»åŠ æ–‡æœ¬
            const textDiv = document.createElement('div');
            textDiv.className = 'text-content';
            textDiv.textContent = page.text;
            pageElement.appendChild(textDiv);
            
            // æ·»åŠ æŒ‰é’®ç»„
            if (page.buttons && page.buttons.length > 0) {
                const buttonsContainer = document.createElement('div');
                buttonsContainer.className = 'buttons-container';
                
                page.buttons.forEach(buttonGroup => {
                    const buttonGroupDiv = document.createElement('div');
                    buttonGroupDiv.className = 'button-group';
                    
                    buttonGroup.options.forEach(option => {
                        const button = document.createElement('button');
                        button.className = 'option-btn';
                        button.textContent = option.text;
                        button.dataset.correct = option.correct;
                        button.dataset.groupId = buttonGroup.id;
                        
                        button.addEventListener('click', function() {
                            // å¤„ç†æŒ‰é’®é€‰æ‹©
                            handleOptionSelect(buttonGroup.id, option.correct, button);
                        });
                        
                        buttonGroupDiv.appendChild(button);
                    });
                    
                    buttonsContainer.appendChild(buttonGroupDiv);
                });
                
                pageElement.appendChild(buttonsContainer);
            }
            
            // æ·»åŠ ContinueæŒ‰é’®
            const continueBtn = document.createElement('button');
            continueBtn.className = 'continue-btn';
            continueBtn.textContent = 'Continue';
            continueBtn.addEventListener('click', function() {
                // å¤„ç†é¡µé¢è·³è½¬
                handleContinue(pageId, page.nextPage);
            });
            pageElement.appendChild(continueBtn);
            
            // æ¸…ç©ºå®¹å™¨å¹¶æ·»åŠ æ–°é¡µé¢
            gameContainer.innerHTML = '';
            gameContainer.appendChild(pageElement);
            
            // æ›´æ–°å½“å‰é¡µé¢
            currentPage = pageId;
            
            // æ›´æ–°ç©å®¶è¿›åº¦
            updateProgress();
        }

        // å¤„ç†é€‰é¡¹é€‰æ‹©
        function handleOptionSelect(groupId, isCorrect, button) {
            // é«˜äº®é€‰ä¸­çš„æŒ‰é’®
            const group = button.parentElement;
            const buttons = group.querySelectorAll('.option-btn');
            buttons.forEach(btn => {
                btn.classList.remove('selected');
            });
            button.classList.add('selected');
            
            // è®°å½•é€‰æ‹©
            selectedAnswers[groupId] = isCorrect;
        }

        // å¤„ç†ContinueæŒ‰é’®ç‚¹å‡»
        function handleContinue(currentPageId, nextPageId) {
            // è®¡ç®—å½“å‰é¡µé¢çš„å¾—åˆ†
            if (pageData[currentPageId].buttons && pageData[currentPageId].buttons.length > 0) {
                let pageScore = 0;
                
                pageData[currentPageId].buttons.forEach(buttonGroup => {
                    if (selectedAnswers[buttonGroup.id] === true) {
                        pageScore++;
                    }
                });
                
                // æ›´æ–°ç©å®¶æ•°æ®
                updatePlayerData(pageScore);
                
                // æ¸…ç©ºå½“å‰é¡µé¢çš„é€‰æ‹©
                selectedAnswers = {};
            }
            
            // åŠ è½½ä¸‹ä¸€é¡µæˆ–æ˜¾ç¤ºæ’è¡Œæ¦œ
            if (nextPageId === 2113) {
                // æ ‡è®°æ¸¸æˆå®Œæˆ
                markGameCompleted();
                showLeaderboard();
                startLeaderboardUpdates();
            } else {
                loadPage(nextPageId);
                preloadNextImage(nextPageId + 1);
            }
        }

        // æ›´æ–°ç©å®¶æ•°æ®
        function updatePlayerData(score) {
            if (!firebaseInitialized || !playerId) return;
            
            playerData.correctAnswers += score;
            
            const db = firebase.database();
            const playerRef = db.ref('rooms/' + roomId + '/players/' + playerId);
            
            playerRef.update({
                correctAnswers: playerData.correctAnswers
            }).catch((error) => {
                console.error("Error updating player data:", error);
            });
        }

        // æ›´æ–°è¿›åº¦
        function updateProgress() {
            if (!firebaseInitialized || !playerId) return;
            
            // è®¡ç®—è¿›åº¦ (å½“å‰é¡µæ•°/12 * 100)
            const progress = Math.floor((currentPage - 2101) / 12 * 100);
            playerData.progress = progress;
            
            const db = firebase.database();
            const playerRef = db.ref('rooms/' + roomId + '/players/' + playerId);
            
            playerRef.update({
                progress: progress
            }).catch((error) => {
                console.error("Error updating progress:", error);
            });
        }

        // æ ‡è®°æ¸¸æˆå®Œæˆ
        function markGameCompleted() {
            if (!firebaseInitialized || !playerId) return;
            
            const db = firebase.database();
            const playerRef = db.ref('rooms/' + roomId + '/players/' + playerId);
            
            // è®¡ç®—æ¸¸æˆç”¨æ—¶ï¼ˆåˆ†é’Ÿï¼‰
            const endTime = Date.now();
            const timeSpent = Math.min(60, Math.ceil((endTime - playerData.startTime) / 60000));
            
            // è®¡ç®—æ—¶é—´åˆ†æ•°ï¼ˆæ¯æ»¡ä¸€åˆ†é’Ÿ2åˆ†ï¼Œä¸æ»¡ä¸€åˆ†é’Ÿ1åˆ†ï¼‰
            const timeScore = timeSpent <= 1 ? 1 : timeSpent * 2;
            
            // è®¡ç®—æ€»åˆ†æ•°ï¼ˆN-æ—¶é—´åˆ†æ•°ï¼Œä¸è¶…è¿‡100ï¼‰
            const totalScore = Math.min(100, playerData.correctAnswers - timeScore);
            
            // è®¡ç®—æ­£ç¡®ç‡
            const accuracy = (playerData.correctAnswers / 15 * 100).toFixed(1);
            
            playerRef.update({
                finished: true,
                endTime: endTime,
                timeSpent: timeSpent,
                totalScore: totalScore,
                accuracy: accuracy,
                status: "completed"
            }).catch((error) => {
                console.error("Error marking game completed:", error);
            });
        }

        // é¢„åŠ è½½ä¸‹ä¸€å¼ å›¾ç‰‡
        function preloadNextImage(nextPageId) {
            const nextPage = pageData[nextPageId];
            if (!nextPage) return;
            
            const img = new Image();
            img.src = `images/${nextPage.image}`;
            preloadedImages[nextPageId] = img;
        }

        // æ˜¾ç¤ºæ’è¡Œæ¦œ
        function showLeaderboard() {
            const gameContainer = document.getElementById('game-container');
            gameContainer.innerHTML = '';
            
            const leaderboardDiv = document.createElement('div');
            leaderboardDiv.className = 'leaderboard-page';
            leaderboardDiv.id = 'page-2113';
            
            // æˆ¿é—´ä¿¡æ¯
            const roomInfoDiv = document.createElement('div');
            roomInfoDiv.className = 'room-info';
            roomInfoDiv.innerHTML = `
                <div>Room: ${roomId}</div>
                <div id="player-count">Players: 0</div>
            `;
            leaderboardDiv.appendChild(roomInfoDiv);
            
            // æ’è¡Œæ¦œ
            const leaderboardTable = document.createElement('table');
            leaderboardTable.className = 'leaderboard-table';
            leaderboardTable.innerHTML = `
                <thead>
                    <tr>
                        <th>Rank</th>
                        <th>Name</th>
                        <th>Score</th>
                        <th>Accuracy</th>
                        <th>Time</th>
                    </tr>
                </thead>
                <tbody id="leaderboard-body">
                    <!-- æ’è¡Œæ¦œæ•°æ®å°†é€šè¿‡JavaScriptåŠ¨æ€å¡«å…… -->
                </tbody>
            `;
            leaderboardDiv.appendChild(leaderboardTable);
            
            gameContainer.appendChild(leaderboardDiv);
            
            // åˆå§‹åŠ è½½æ’è¡Œæ¦œæ•°æ®
            updateLeaderboard();
        }

        // å¼€å§‹æ’è¡Œæ¦œæ›´æ–°
        function startLeaderboardUpdates() {
            // æ¯3ç§’æ›´æ–°ä¸€æ¬¡æ’è¡Œæ¦œ
            setInterval(updateLeaderboard, 3000);
        }

        // æ›´æ–°æ’è¡Œæ¦œ
        function updateLeaderboard() {
            if (!firebaseInitialized || !roomId) return;
            
            const db = firebase.database();
            const roomRef = db.ref('rooms/' + roomId);
            
            roomRef.once('value')
                .then((snapshot) => {
                    if (snapshot.exists()) {
                        const roomData = snapshot.val();
                        const players = roomData.players || {};
                        
                        // æ›´æ–°ç©å®¶æ•°é‡ï¼ˆä¸åŒ…æ‹¬è€å¸ˆï¼‰
                        const playerCount = Object.keys(players).length;
                        document.getElementById('player-count').textContent = `Players: ${playerCount}`;
                        
                        // å‡†å¤‡æ’è¡Œæ¦œæ•°æ®
                        const leaderboardData = [];
                        
                        for (const playerId in players) {
                            const player = players[playerId];
                            if (player.finished) {
                                leaderboardData.push({
                                    name: player.name,
                                    score: player.totalScore || 0,
                                    accuracy: player.accuracy || "0.0",
                                    time: player.timeSpent || 0,
                                    isCurrent: playerId === window.playerId
                                });
                            }
                        }
                        
                        // æŒ‰åˆ†æ•°æ’åº
                        leaderboardData.sort((a, b) => b.score - a.score);
                        
                        // åªæ˜¾ç¤ºå‰10å
                        const top10 = leaderboardData.slice(0, 10);
                        
                        // æ›´æ–°æ’è¡Œæ¦œè¡¨æ ¼
                        const tbody = document.getElementById('leaderboard-body');
                        tbody.innerHTML = '';
                        
                        top10.forEach((player, index) => {
                            const row = document.createElement('tr');
                            if (player.isCurrent) {
                                row.classList.add('current-player');
                            }
                            
                            row.innerHTML = `
                                <td>${index + 1}</td>
                                <td>${player.name}</td>
                                <td>${player.score}</td>
                                <td>${player.accuracy}%</td>
                                <td>${player.time}m</td>
                            `;
                            
                            tbody.appendChild(row);
                        });
                    }
                })
                .catch((error) => {
                    console.error("Error updating leaderboard:", error);
                });
        }
    </script>
</body>
</html>
