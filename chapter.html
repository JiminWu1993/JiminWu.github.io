<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>English Tenses Journey - Game</title>
    <link rel="stylesheet" href="style.css">
    <!-- Firebase App (the core Firebase SDK) is always required and must be listed first -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app-compat.js"></script>
    <!-- Add Firebase products that you want to use -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database-compat.js"></script>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>📚</text></svg>">
</head>
<body>
    <!-- 游戏页面容器 -->
    <div id="game-container">
        <!-- 所有游戏页面 -->
        <div id="page-2101" class="page">
            <img src="images/画面01.jpg" alt="Scene 1" class="background-image">
            <div class="text-container">
                <p>Arturo: Hello, I'm Arturo Valdez.</p>
            </div>
            <div class="button-container">
                <button class="continue-btn">Continue</button>
            </div>
        </div>

        <div id="page-2102" class="page">
            <img src="images/画面02.jpg" alt="Scene 2" class="background-image">
            <div class="text-container">
                <p>Alexa: Hi. My name <span class="blank">(1)</span> Alexandra Costa, but please <span class="blank">(2)</span> me Alexa.</p>
            </div>
            <div class="options-container">
                <div class="option-row">
                    <button class="option-btn" data-value="is" data-correct="true">is</button>
                    <button class="option-btn" data-value="am" data-correct="false">am</button>
                    <button class="option-btn" data-value="are" data-correct="false">are</button>
                </div>
                <div class="option-row">
                    <button class="option-btn" data-value="calls" data-correct="false">calls</button>
                    <button class="option-btn" data-value="call" data-correct="true">call</button>
                    <button class="option-btn" data-value="calling" data-correct="false">calling</button>
                </div>
            </div>
            <div class="button-container">
                <button class="continue-btn">Continue</button>
            </div>
        </div>

        <div id="page-2103" class="page">
            <img src="images/画面03.jpg" alt="Scene 3" class="background-image">
            <div class="text-container">
                <p>Arturo: OK. Where <span class="blank">(3)</span> you from, Alexa?</p>
            </div>
            <div class="options-container">
                <div class="option-row">
                    <button class="option-btn" data-value="is" data-correct="false">is</button>
                    <button class="option-btn" data-value="are" data-correct="true">are</button>
                    <button class="option-btn" data-value="am" data-correct="false">am</button>
                </div>
            </div>
            <div class="button-container">
                <button class="continue-btn">Continue</button>
            </div>
        </div>

        <div id="page-2104" class="page">
            <img src="images/画面04.jpg" alt="Scene 4" class="background-image">
            <div class="text-container">
                <p>Alexa: Brazil. How about you?</p>
            </div>
            <div class="button-container">
                <button class="continue-btn">Continue</button>
            </div>
        </div>

        <div id="page-2105" class="page">
            <img src="images/画面05.jpg" alt="Scene 5" class="background-image">
            <div class="text-container">
                <p>Arturo: I'm from Mexico. I <span class="blank">(4)</span> here in the city now, but my family <span class="blank">(5)</span> in a small town near Guadalajara.</p>
            </div>
            <div class="options-container">
                <div class="option-row">
                    <button class="option-btn" data-value="lives" data-correct="true">lives</button>
                    <button class="option-btn" data-value="live" data-correct="false">live</button>
                    <button class="option-btn" data-value="living" data-correct="false">living</button>
                </div>
                <div class="option-row">
                    <button class="option-btn" data-value="lives" data-correct="true">lives</button>
                    <button class="option-btn" data-value="live" data-correct="false">live</button>
                    <button class="option-btn" data-value="are living" data-correct="false">are living</button>
                </div>
            </div>
            <div class="button-container">
                <button class="continue-btn">Continue</button>
            </div>
        </div>

        <div id="page-2106" class="page">
            <img src="images/画面06.jpg" alt="Scene 6" class="background-image">
            <div class="text-container">
                <p>Alexa: Oh, I <span class="blank">(6)</span> Mexico! It <span class="blank">(7)</span> really beautiful. My brother <span class="blank">(8)</span> Mexico, too. Oh, good. Soo-jin <span class="blank">(9)</span> here.</p>
            </div>
            <div class="options-container">
                <div class="option-row">
                    <button class="option-btn" data-value="loves" data-correct="false">loves</button>
                    <button class="option-btn" data-value="love" data-correct="true">love</button>
                    <button class="option-btn" data-value="loving" data-correct="false">loving</button>
                </div>
                <div class="option-row">
                    <button class="option-btn" data-value="is" data-correct="true">is</button>
                    <button class="option-btn" data-value="am" data-correct="false">am</button>
                    <button class="option-btn" data-value="are" data-correct="false">are</button>
                </div>
                <div class="option-row">
                    <button class="option-btn" data-value="loves" data-correct="true">loves</button>
                    <button class="option-btn" data-value="love" data-correct="false">love</button>
                    <button class="option-btn" data-value="loving" data-correct="false">loving</button>
                </div>
                <div class="option-row">
                    <button class="option-btn" data-value="is" data-correct="true">is</button>
                    <button class="option-btn" data-value="are" data-correct="false">are</button>
                    <button class="option-btn" data-value="am" data-correct="false">am</button>
                </div>
            </div>
            <div class="button-container">
                <button class="continue-btn">Continue</button>
            </div>
        </div>

        <div id="page-2107" class="page">
            <img src="images/画面07.jpg" alt="Scene 7" class="background-image">
            <div class="text-container">
                <p>Arturo: Who <span class="blank">(10)</span> Soo-jin? She <span class="blank">(11)</span> familiar.</p>
            </div>
            <div class="options-container">
                <div class="option-row">
                    <button class="option-btn" data-value="is" data-correct="true">is</button>
                    <button class="option-btn" data-value="are" data-correct="false">are</button>
                    <button class="option-btn" data-value="am" data-correct="false">am</button>
                </div>
                <div class="option-row">
                    <button class="option-btn" data-value="looks" data-correct="true">looks</button>
                    <button class="option-btn" data-value="look" data-correct="false">look</button>
                    <button class="option-btn" data-value="looking" data-correct="false">looking</button>
                </div>
            </div>
            <div class="button-container">
                <button class="continue-btn">Continue</button>
            </div>
        </div>

        <div id="page-2108" class="page">
            <img src="images/画面08.jpg" alt="Scene 8" class="background-image">
            <div class="text-container">
                <p>Alexa: She <span class="blank">(12)</span> my classmate. We <span class="blank">(13)</span> in the same business class. We <span class="blank">(14)</span> our class every Monday and Wednesday.</p>
            </div>
            <div class="options-container">
                <div class="option-row">
                    <button class="option-btn" data-value="is" data-correct="false">is</button>
                    <button class="option-btn" data-value="are" data-correct="true">are</button>
                    <button class="option-btn" data-value="am" data-correct="false">am</button>
                </div>
                <div class="option-row">
                    <button class="option-btn" data-value="is" data-correct="false">is</button>
                    <button class="option-btn" data-value="are" data-correct="true">are</button>
                    <button class="option-btn" data-value="am" data-correct="false">am</button>
                </div>
                <div class="option-row">
                    <button class="option-btn" data-value="has" data-correct="false">has</button>
                    <button class="option-btn" data-value="have" data-correct="true">have</button>
                    <button class="option-btn" data-value="having" data-correct="false">having</button>
                </div>
            </div>
            <div class="button-container">
                <button class="continue-btn">Continue</button>
            </div>
        </div>

        <div id="page-2109" class="page">
            <img src="images/画面09.jpg" alt="Scene 9" class="background-image">
            <div class="text-container">
                <p>Arturo: Where <span class="blank">(15)</span> she from?</p>
            </div>
            <div class="options-container">
                <div class="option-row">
                    <button class="option-btn" data-value="is" data-correct="false">is</button>
                    <button class="option-btn" data-value="are" data-correct="true">are</button>
                    <button class="option-btn" data-value="am" data-correct="false">am</button>
                </div>
            </div>
            <div class="button-container">
                <button class="continue-btn">Continue</button>
            </div>
        </div>

        <div id="page-2110" class="page">
            <img src="images/画面10.jpg" alt="Scene 10" class="background-image">
            <div class="text-container">
                <p>Alexa: South Korea. She <span class="blank">(16)</span> marketing. She <span class="blank">(17)</span> the classes <span class="blank">(18)</span> very interesting. Let's go and say hello. Sorry, what <span class="blank">(19)</span> your last name again? Vargas?</p>
            </div>
            <div class="options-container">
                <div class="option-row">
                    <button class="option-btn" data-value="studies" data-correct="true">studies</button>
                    <button class="option-btn" data-value="study" data-correct="false">study</button>
                    <button class="option-btn" data-value="studying" data-correct="false">studying</button>
                </div>
                <div class="option-row">
                   极简
                    <button class="option-btn" data-value="says" data-correct="true">says</button>
                    <button class="option-btn"极简 data-value="say" data-correct="false">say</button>
                    <button class="option-btn" data-value="saying" data-correct="false">saying</button>
                </div>
                <div class="option-row">
                    <button class="option-btn" data-value="is" data-correct="false">is</button>
                    <button class="option-btn" data-value="are" data-correct="true">are</button>
                    <button class="极简option-btn" data-value="am" data-correct="false">am</button>
                </div>
                <div class="option-row">
                    <button class="option-btn" data-value="is" data-correct="true">is</button>
                    <button class="option-btn" data-value="are" data-correct="false">are</button>
                    <button class="option-btn" data-value="am" data-correct="false">am</button>
                </div>
            </div>
            <div class="button-container">
                <button class="continue-btn">Continue</button>
            </div>
        </div>

        <div id="page-2111" class="page">
            <img src="images/画面11.jpg" alt="Scene 11" class="background-image">
            <div class="text-container">
                <p>Arturo: Actually, it <span class="blank">(20)</span> Valdez</p>
            </div>
            <div class="options-container">
                <div class="option-row">
                    <button class="option-btn" data-value="is" data极简-correct="true">is</button>
                    <button class="option-btn" data-value="are" data-correct="false">are</button>
                    <button class="option-btn" data-value="am" data-correct="false">am</button>
                </div>
            </div>
            <div class="button-container">
                <button class="continue-btn">Continue</button>
            </div>
        </div>

        <div id="page-2112" class="page">
            <img src="images/画面12.jpg" alt="Scene 12" class="background-image">
            <div class="text-container">
                <p>Alexa: How <span class="blank">(21)</span> you spell that?</p>
            </div>
            <div class="options-container">
                <div class="option-row">
                    <button class="option-btn" data-value="is" data-correct="false">is</button>
                    <button class="option-btn" data-value="are" data-correct="true">are</button>
                    <button class="option-btn" data-value="am" data-correct="false">am</button>
                </极简div>
            </div>
            <div class="button-container">
                <button class="continue-btn">Continue</button>
            </div>
        </div>

        <!-- 排名画面 (页面ID:2113) -->
        <div id="page-2113" class="page">
            <div class="ranking-header">
                <div class="room-info">
                    <p>Room: <span id="room-number">000000</span></p>
                    <p>Players: <span id="player-count">0</span></p>
                </div>
            </div>
            <div class="ranking-container">
                <table id="ranking-table">
                    <thead>
                        <tr>
                            <th>Rank</th>
                            <th>Name</th>
                            <th>Score</th>
                            <th>Accuracy</th>
                            <th>Time</th>
                        </tr>
                    </thead>
                    <tbody id="ranking-body">
                        <!-- 排行榜数据将通过JavaScript动态填充 -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- 提示信息模态框 -->
    <div id="message-modal" class="modal">
        <div class="modal-content">
            <p id="message-text"></p>
        </div>
    </div>

    <script>
        // Firebase配置
        const firebaseConfig = {
            apiKey: "AIzaSyDHRYTBU74r31极简MPYVAAnRMwKM76c_-BduQ",
            authDomain: "tetrisonline-ca400.firebaseapp.com",
            projectId: "tetrisonline-ca400",
            storageBucket: "tetrisonline-ca400.firebasestorage.app",
            messagingSenderId: "58207939196",
            appId: "1:58207939196:web:b34f403204096084ee37f9",
            measurementId: "G-GG7GNEQ718"
        };

        // 初始化Firebase
        let firebaseInitialized = false;
        try {
            firebase.initializeApp(firebaseConfig);
            firebaseInitialized = true;
            console.log("Firebase initialized successfully");
        } catch (error) {
            console.error("Firebase initialization error:", error);
            alert("Failed to initialize the game. Please refresh the page.");
        }

        // 全局变量
        let currentPage = 2101;
        let roomCode = null;
        let playerId = null;
        let nickname = null;
        let isTeacher = false;
        let startTime = null;
        let correctAnswers = 0;
        let selectedOptions = {};
        let updateInterval = null;

        // DOM元素
        const gameContainer = document.getElementById('game-container');
        const messageModal = document.getElementById('message-modal');
        const messageText = document.getElementById('message-text');
        const roomNumberSpan = document.getElementById('room-number');
        const playerCountSpan = document.getElementById('player-count');
        const rankingBody = document.getElementById('ranking-body');

        // 显示消息提示
        function showMessage(message, duration = 3000) {
            messageText.textContent = message;
            messageModal.style.display = 'flex';
            
            if (duration > 0) {
                setTimeout(() => {
                    messageModal.style.display = 'none';
                }, duration);
            }
        }

        // 隐藏消息提示
        function hideMessage() {
            messageModal.style.display = 'none';
        }

        // 显示指定页面
        function showPage(pageId) {
            // 隐藏所有页面
            const pages = document.querySelectorAll('.page');
            pages.forEach(page => {
                page.classList.remove('active');
            });
            
            // 显示指定页面
            const targetPage = document.getElementById('page-' + pageId);
            if (targetPage) {
                targetPage.classList.add('active');
                currentPage = pageId;
                
                // 更新Firebase中的进度
                updateProgress();
                
                // 预加载下一张图片
                if (pageId < 2112) {
                    preloadNextImage(parseInt(pageId) + 1);
                }
            }
        }

        // 预加载下一张图片
        function preloadNextImage(nextPageId) {
            if (nextPageId > 2112) return;
            
            const imageName = '画面' + (nextPageId - 2100).toString().padStart(2, '0') + '.jpg';
            const img = new Image();
            img.src = 'images/' + imageName;
        }

        // 初始化选项按钮
        function initOptionButtons() {
            const optionButtons = document.querySelectorAll('.option-btn');
            optionButtons.forEach(button => {
                button.addEventListener('click', function() {
                    // 获取所在的行
                    const row = this.parentElement;
                    
                    // 取消同行中其他按钮的选中状态
                    const siblings = row.querySelectorAll('.option-btn');
                    siblings.forEach(btn => {
                        btn.classList.remove('selected');
                    });
                    
                    // 设置当前按钮为选中状态
                    this.classList.add('selected');
                    
                    // 保存选择
                    const pageId = this.closest('.page').id.replace('page-', '');
                    const blankIndex = Array.from(row.parentElement.children).indexOf(row) + 1;
                    selectedOptions[pageId + '-' + blankIndex] = {
                        value: this.dataset.value,
                        correct: this.dataset.correct === 'true'
                    };
                });
            });
        }

        // 初始化继续按钮
        function initContinueButtons() {
            const continueButtons = document.querySelectorAll('.continue-btn');
            continueButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const currentPageId = this.closest('.page').id.replace('page-', '');
                    
                    // 检查是否是排名页面
                    if (currentPageId === '2113') {
                        return; // 排名页面没有下一页
                    }
                    
                    // 检查是否有选项需要评分
                    if (currentPageId !== '2101' && currentPageId !== '2104') {
                        const pageOptions = Object.keys(selectedOptions).filter(key => key.startsWith(currentPageId + '-'));
                        
                        // 计算本页得分
                        let pageScore = 0;
                        pageOptions.forEach(key => {
                            if (selectedOptions[key].correct) {
                                pageScore++;
                            }
                        });
                        
                        // 更新总得分
                        correctAnswers += pageScore;
                    }
                    
                    // 前进到下一页
                    const nextPageId = parseInt(currentPageId) + 1;
                    
                    // 如果是最后一页，计算最终得分并跳转到排名
                    if (nextPageId === 2113) {
                        finishGame();
                    } else {
                        showPage(nextPageId);
                    }
                });
            });
        }

        // 计算时间分数
        function calculateTimeScore() {
            if (!startTime) return 0;
            
            const endTime = Date.now();
            const timeSpent = Math.floor((endTime - startTime) / 1000); // 秒
            const minutes = Math.floor(timeSpent / 60);
            const seconds = timeSpent % 60;
            
            // 每满一分钟得2分，不满一分钟得1分
            let timeScore = minutes * 2;
            if (seconds > 0) {
                timeScore += 1;
            }
            
            return timeScore;
        }

        // 计算总分
        function calculateTotalScore() {
            const timeScore = calculateTimeScore();
            let totalScore = correctAnswers + timeScore;
            
            // 总分不超过100
            if (totalScore > 100) {
                totalScore = 100;
            }
            
            return totalScore;
        }

        // 计算正确率
        function calculateAccuracy() {
            return (correctAnswers / 15 * 100).toFixed(1);
        }

        // 更新Firebase中的进度
        function updateProgress() {
            if (!firebaseInitialized || !roomCode || !playerId || isTeacher) return;
            
            try {
                const database = firebase.database();
                const playerRef = database.ref('rooms/' + roomCode + '/players/' + playerId);
                
                // 计算进度百分比
                const progress = Math.floor((currentPage - 2101) / 12 * 100);
                
                // 更新时间
                const timeSpent = startTime ? Math.floor((Date.now() - startTime) / 1000) : 0;
                
                playerRef.update({
                    progress: progress,
                    correctAnswers: correctAnswers,
                    timeSpent: timeSpent,
                    status: currentPage === 2113 ? 'finished' : 'playing'
                });
            } catch (error) {
                console.error("Error updating progress:", error);
            }
        }

        // 完成游戏
        function finishGame() {
            if (!firebaseInitialized || !roomCode || !playerId || isTeacher) return;
            
            try {
                const database = firebase.database();
                const playerRef = database.ref('rooms/' + roomCode + '/players/' + playerId);
                
                // 计算最终数据
                const timeSpent = Math.floor((Date.now() - startTime) / 1000);
                const totalScore = calculateTotalScore();
                const accuracy = calculateAccuracy();
                
                playerRef.update({
                    status: 'finished',
                    progress: 100,
                    correctAnswers: correctAnswers,
                    timeSpent: timeSpent,
                    totalScore: totalScore,
                    accuracy: accuracy,
                    finishedAt: firebase.database.ServerValue.TIMESTAMP
                });
                
                // 停止定时更新
                if (updateInterval) {
                    clearInterval(updateInterval);
                }
                
                // 显示排名页面
                showPage(2113);
            } catch (error) {
                console.error("Error finishing game:", error);
                showMessage("Error finishing game. Please try again.");
            }
        }

        // 更新排名数据
        function updateRankingData() {
            if (!firebaseInitialized || !roomCode) return;
            
            try {
                const database = firebase.database();
                const roomRef = database.ref('rooms/' + roomCode);
                
                roomRef.once('value').then(snapshot => {
                    if (snapshot.exists()) {
                        const roomData = snapshot.val();
                        
                        // 更新房间信息
                        roomNumberSpan.textContent = roomCode;
                        playerCountSpan.textContent = roomData.playerCount || 0;
                        
                        // 更新排行榜
                        const players = roomData.players || {};
                        const playerArray = [];
                        
                        Object.keys(players).forEach(key => {
                            if (players[key].status === 'finished') {
                                playerArray.push({
                                    id: key,
                                    nickname: players[key].nickname,
                                    totalScore: players[key].totalScore || 0,
                                    accuracy: players[key].accuracy || '0.0',
                                    timeSpent: players[key].timeSpent || 0
                                });
                            }
                        });
                        
                        // 按总分排序
                        playerArray.sort((a, b) => b.totalScore - a.totalScore);
                        
                        // 更新排行榜HTML
                        rankingBody.innerHTML = '';
                        playerArray.slice(0, 10).forEach((player, index) => {
                            const row = document.createElement('tr');
                            
                            // 高亮显示当前玩家
                            if (player.id === playerId) {
                                row.classList.add('highlight');
                            }
                            
                            // 格式化时间
                            const minutes = Math.floor(player.timeSpent / 60);
                            const seconds = player.timeSpent % 60;
                            const timeFormatted = `${minutes}m ${seconds}s`;
                            
                            row.innerHTML = `
                                <td>${index + 1}</td>
                                <td>${player.nickname}</td>
                                <td>${player.totalScore}</td>
                                <td>${player.accuracy}%</td>
                                <td>${timeFormatted}</td>
                            `;
                            
                            rankingBody.appendChild(row);
                        });
                    }
                });
            } catch (error) {
                console.error("Error updating ranking data:", error);
            }
        }

        // 初始化游戏
        function initGame() {
            // 解析URL参数
            const urlParams = new URLSearchParams(window.location.search);
            roomCode = urlParams.get('room');
            playerId = urlParams.get('player');
            nickname = urlParams.get('nickname');
            isTeacher = urlParams.has('teacher');
            
            if (!roomCode) {
                showMessage("Room code not found. Redirecting to home page.");
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 2000);
                return;
            }
            
            // 如果是老师，直接显示排名页面
            if (isTeacher) {
                showPage(2113);
                // 设置定时更新排名数据
                updateInterval = setInterval(updateRankingData, 3000);
                updateRankingData();
                return;
            }
            
            // 如果是玩家，初始化游戏
            if (playerId && nickname) {
                nickname = decodeURIComponent(nickname);
                startTime = Date.now();
                
                // 初始化选项按钮和继续按钮
                initOptionButtons();
                initContinueButtons();
                
                // 显示第一页
                showPage(2101);
                
                // 设置定时更新进度
                updateInterval = setInterval(() => {
                    updateProgress();
                    updateRankingData();
                }, 3000);
            } else {
                showMessage("Player information not found. Redirecting to home page.");
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 2000);
            }
        }

        // 页面加载完成后初始化游戏
        window.addEventListener('load', initGame);
    </script>
</body>
</html>
